Issues with polymorphism of nested types