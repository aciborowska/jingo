Using the new Aggregation support fails when I try to 'group' on a property of a sub-object.  The referenced Gist should give enough context.  Following things in the debugger lead me to believe that the code is trying to resolve the 'code' property on the parent object instead of the contained sub-object.  Using a top-level property works great.  I've run the equivalent aggregation in the MongoDB shell and it allows me to 'group' on the sub-object's property so it doesn't appear to be illegal in MongoDB.