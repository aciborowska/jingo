more robust native code to eliminate memory leak