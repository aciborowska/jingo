Hiveserver2 fail on Mapreduce local job fail. For example:



select /*+ MAPJOIN(v) */ registration from studenttab10k s join votertab10k v on (s.name = v.name);



The root cause is "class not found" in the local hadoop job (MapredLocalTask.execute). HADOOP_CLASSPATH does not include $HIVE_HOME/lib. Set HADOOP_CLASSPATH correctly will fix the issue.
However, there is one complexity in Windows. We start Hiveserver2 using Windows service console (services.msc), which takes hiveserver2.xml generated by hive.cmd. There is no way to pass environment variable in hiveserver2.xml (weird but reality). I attach a patch which pass it through command line arguments and relay to HADOOP_CLASSPATH in Hive code. 