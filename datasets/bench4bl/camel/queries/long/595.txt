code uses in.read(buf) assuming that the read will be greedy. This isn't guaranteed, Patch fixes this.