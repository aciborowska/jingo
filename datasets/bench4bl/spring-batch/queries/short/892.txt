Thread visibility issues in repeat template