State transition causes infinite loop