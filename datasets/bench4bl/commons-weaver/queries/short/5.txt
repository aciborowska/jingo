Incomplete sorting code causes infinite loop