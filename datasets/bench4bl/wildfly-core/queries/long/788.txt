This does seem to be somewhat of an edge case as the only way to reproduce it is to add the allow-resource-service-restart=true header to a composite operation. The first operation must also need access to a capability provided by a resource being removed. It's likely an acceptable failure, but the failure isn't seen when executing the same composite operation again.
The issue seems to be that the capability is removed on the first execution that fails and is rolled back. On the second execution of the composite operation there is no capability registered registered in the RuntimeCapabilityRegistration so the remove of the capability doesn't happen. This allows the first operation to pass.