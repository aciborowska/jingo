To reproduce:
# Error Case 1
<a name="error-case-1"/>
1. Store a binary document into the database, e.g. `/db/me.jpg`.
2. Run the XQuery:

``` xquery
import module namespace util = "http://exist-db.org/xquery/util";
util:binary-doc("/db/me.jpg")
```

and you will get an error and the stack trace:

```
2015-10-05 13:06:22,965 [eXistThread-33] INFO  (RpcConnection.java [doQuery]:253) - query took 2ms. 
2015-10-05 13:06:22,966 [eXistThread-33] ERROR (XmlRpcErrorLogger.java [log]:36) - Failed to invoke method queryP in class org.exist.xmlrpc.RpcConnection: org.exist.xquery.XPathException: exerr:ERROR Unable to encode string value: The underlying InputStream has been closed 
org.apache.xmlrpc.common.XmlRpcInvocationException: Failed to invoke method queryP in class org.exist.xmlrpc.RpcConnection: org.exist.xquery.XPathException: exerr:ERROR Unable to encode string value: The underlying InputStream has been closed
    at org.apache.xmlrpc.server.ReflectiveXmlRpcHandler.invoke(ReflectiveXmlRpcHandler.java:129) ~[xmlrpc-server-3.1.3.jar:3.1.3]
    at org.apache.xmlrpc.server.ReflectiveXmlRpcHandler.execute(ReflectiveXmlRpcHandler.java:106) ~[xmlrpc-server-3.1.3.jar:3.1.3]
    at org.apache.xmlrpc.server.XmlRpcServerWorker.execute(XmlRpcServerWorker.java:46) ~[xmlrpc-server-3.1.3.jar:3.1.3]
    at org.apache.xmlrpc.server.XmlRpcServer.execute(XmlRpcServer.java:86) ~[xmlrpc-server-3.1.3.jar:3.1.3]
    at org.apache.xmlrpc.server.XmlRpcStreamServer.execute(XmlRpcStreamServer.java:200) [xmlrpc-server-3.1.3.jar:3.1.3]
    at org.apache.xmlrpc.webserver.XmlRpcServletServer.execute(XmlRpcServletServer.java:112) [xmlrpc-server-3.1.3.jar:3.1.3]
    at org.apache.xmlrpc.webserver.XmlRpcServlet.doPost(XmlRpcServlet.java:196) [xmlrpc-server-3.1.3.jar:3.1.3]
    at org.exist.xmlrpc.RpcServlet.doPost(RpcServlet.java:67) [eXist/:?]
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:755) [servlet-api-3.0.jar:?]
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:848) [servlet-api-3.0.jar:?]
    at org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:684) [jetty-servlet-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:503) [jetty-servlet-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:137) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:575) [jetty-security-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:231) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1086) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:429) [jetty-servlet-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:193) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1020) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:135) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.Dispatcher.forward(Dispatcher.java:229) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.Dispatcher.forward(Dispatcher.java:103) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.exist.http.urlrewrite.Forward.doRewrite(Forward.java:50) [eXist/:?]
    at org.exist.http.urlrewrite.XQueryURLRewrite.service(XQueryURLRewrite.java:223) [eXist/:?]
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:848) [servlet-api-3.0.jar:?]
    at org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:684) [jetty-servlet-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:503) [jetty-servlet-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:137) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:533) [jetty-security-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:231) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1086) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:429) [jetty-servlet-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:193) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1020) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:135) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:154) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:116) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.Server.handle(Server.java:370) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:494) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.AbstractHttpConnection.content(AbstractHttpConnection.java:982) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.content(AbstractHttpConnection.java:1043) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:865) [jetty-http-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:240) [jetty-http-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.AsyncHttpConnection.handle(AsyncHttpConnection.java:82) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.io.nio.SelectChannelEndPoint.handle(SelectChannelEndPoint.java:696) [jetty-io-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.io.nio.SelectChannelEndPoint$1.run(SelectChannelEndPoint.java:53) [jetty-io-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:608) [jetty-util-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:543) [jetty-util-8.1.17.v20150415.jar:8.1.17.v20150415]
    at java.lang.Thread.run(Thread.java:745) [?:1.8.0_51]
Caused by: org.exist.EXistException: org.exist.xquery.XPathException: exerr:ERROR Unable to encode string value: The underlying InputStream has been closed
    at org.exist.xmlrpc.RpcConnection.lambda$queryP$285(RpcConnection.java:1756) ~[eXist/:?]
    at org.exist.xmlrpc.RpcConnection$$Lambda$135/2006309794.applyXmlRpc(Unknown Source) ~[?:?]
    at org.exist.xmlrpc.function.XmlRpcFunction.apply(XmlRpcFunction.java:45) ~[eXist/:?]
    at org.exist.xmlrpc.RpcConnection.withDb(RpcConnection.java:3764) ~[eXist/:?]
    at org.exist.xmlrpc.RpcConnection.withDb(RpcConnection.java:3748) ~[eXist/:?]
    at org.exist.xmlrpc.RpcConnection.queryP(RpcConnection.java:1662) ~[eXist/:?]
    at org.exist.xmlrpc.RpcConnection.queryP(RpcConnection.java:3387) ~[eXist/:?]
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[?:1.8.0_51]
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[?:1.8.0_51]
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[?:1.8.0_51]
    at java.lang.reflect.Method.invoke(Method.java:497) ~[?:1.8.0_51]
    at org.apache.xmlrpc.server.ReflectiveXmlRpcHandler.invoke(ReflectiveXmlRpcHandler.java:115) ~[xmlrpc-server-3.1.3.jar:3.1.3]
    ... 48 more
Caused by: org.exist.xquery.XPathException: exerr:ERROR Unable to encode string value: The underlying InputStream has been closed
    at org.exist.xquery.value.BinaryValue.getStringValue(BinaryValue.java:225) ~[eXist/:?]
    at org.exist.xmlrpc.RpcConnection.lambda$queryP$285(RpcConnection.java:1738) ~[eXist/:?]
    at org.exist.xmlrpc.RpcConnection$$Lambda$135/2006309794.applyXmlRpc(Unknown Source) ~[?:?]
    at org.exist.xmlrpc.function.XmlRpcFunction.apply(XmlRpcFunction.java:45) ~[eXist/:?]
    at org.exist.xmlrpc.RpcConnection.withDb(RpcConnection.java:3764) ~[eXist/:?]
    at org.exist.xmlrpc.RpcConnection.withDb(RpcConnection.java:3748) ~[eXist/:?]
    at org.exist.xmlrpc.RpcConnection.queryP(RpcConnection.java:1662) ~[eXist/:?]
    at org.exist.xmlrpc.RpcConnection.queryP(RpcConnection.java:3387) ~[eXist/:?]
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[?:1.8.0_51]
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[?:1.8.0_51]
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[?:1.8.0_51]
    at java.lang.reflect.Method.invoke(Method.java:497) ~[?:1.8.0_51]
    at org.apache.xmlrpc.server.ReflectiveXmlRpcHandler.invoke(ReflectiveXmlRpcHandler.java:115) ~[xmlrpc-server-3.1.3.jar:3.1.3]
    ... 48 more
Caused by: java.io.IOException: The underlying InputStream has been closed
    at org.exist.util.io.CachingFilterInputStream.read(CachingFilterInputStream.java:135) ~[eXist/:?]
    at org.exist.util.io.CachingFilterInputStream.read(CachingFilterInputStream.java:128) ~[eXist/:?]
    at org.exist.xquery.value.BinaryValueFromInputStream.streamBinaryTo(BinaryValueFromInputStream.java:73) ~[eXist/:?]
    at org.exist.xquery.value.BinaryValue.streamTo(BinaryValue.java:254) ~[eXist/:?]
    at org.exist.xquery.value.BinaryValue.getStringValue(BinaryValue.java:223) ~[eXist/:?]
    at org.exist.xmlrpc.RpcConnection.lambda$queryP$285(RpcConnection.java:1738) ~[eXist/:?]
    at org.exist.xmlrpc.RpcConnection$$Lambda$135/2006309794.applyXmlRpc(Unknown Source) ~[?:?]
    at org.exist.xmlrpc.function.XmlRpcFunction.apply(XmlRpcFunction.java:45) ~[eXist/:?]
    at org.exist.xmlrpc.RpcConnection.withDb(RpcConnection.java:3764) ~[eXist/:?]
    at org.exist.xmlrpc.RpcConnection.withDb(RpcConnection.java:3748) ~[eXist/:?]
    at org.exist.xmlrpc.RpcConnection.queryP(RpcConnection.java:1662) ~[eXist/:?]
    at org.exist.xmlrpc.RpcConnection.queryP(RpcConnection.java:3387) ~[eXist/:?]
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[?:1.8.0_51]
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[?:1.8.0_51]
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[?:1.8.0_51]
    at java.lang.reflect.Method.invoke(Method.java:497) ~[?:1.8.0_51]
    at org.apache.xmlrpc.server.ReflectiveXmlRpcHandler.invoke(ReflectiveXmlRpcHandler.java:115) ~[xmlrpc-server-3.1.3.jar:3.1.3]
    ... 48 more
```
# Error Case 2
<a name="error-case-2"/>
1. Store the following XQuery into `/db/stream-image.xqy`:

``` xquery
import module namespace util = "http://exist-db.org/xquery/util";
import module namespace response = "http://exist-db.org/xquery/response";

let $bin := util:binary-doc("/db/me.jpg")
return
    response:stream($bin, "media-type=image/jpeg")
```
1. Give execute rights to all users for `/db/stream-image.xqy`.
2. Call the stored query using curl. e.g. `curl -v http://localhost:8080/exist/rest/db/stream-image.xqy`

You will see that the output is actually Base64 encoded text and not binary data as it should be:

```
*   Trying ::1...
* Connected to localhost (::1) port 8080 (#0)
> GET /exist/rest/db/stream-image.xqy HTTP/1.1
> Host: localhost:8080
> User-Agent: curl/7.43.0
> Accept: */*
> 
< HTTP/1.1 200 OK
< Date: Mon, 05 Oct 2015 12:21:59 GMT
< Set-Cookie: JSESSIONID=1wk1bvpjy6o7z1vref7uoymvd1;Path=/exist
< Expires: Thu, 01 Jan 1970 00:00:00 GMT
< X-XQuery-Cached: true
< Content-Type: image/jpeg; charset=UTF-8
< Transfer-Encoding: chunked
< Server: Jetty(8.1.17.v20150415)
< 
* Connection #0 to host localhost left intact
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
```
# Error Case 3
<a name="error-case-3"/>
1. Store a binary document into a temporary location on your filesystem, e.g. `/tmp/me.jpg`.
2. Run the XQuery:

``` xquery
import module namespace file = "http://exist-db.org/xquery/file";
file:read-binary("/tmp/me.jpg")
```

and you will get an error and the stack trace:

```
2015-10-05 13:27:03,941 [eXistThread-29] INFO  (RpcConnection.java [doQuery]:253) - query took 2ms. 
2015-10-05 13:27:03,943 [eXistThread-29] ERROR (XmlRpcErrorLogger.java [log]:36) - Failed to invoke method queryP in class org.exist.xmlrpc.RpcConnection: org.exist.xquery.XPathException: exerr:ERROR Unable to encode string value: Underlying channel has been closed 
org.apache.xmlrpc.common.XmlRpcInvocationException: Failed to invoke method queryP in class org.exist.xmlrpc.RpcConnection: org.exist.xquery.XPathException: exerr:ERROR Unable to encode string value: Underlying channel has been closed
    at org.apache.xmlrpc.server.ReflectiveXmlRpcHandler.invoke(ReflectiveXmlRpcHandler.java:129) ~[xmlrpc-server-3.1.3.jar:3.1.3]
    at org.apache.xmlrpc.server.ReflectiveXmlRpcHandler.execute(ReflectiveXmlRpcHandler.java:106) ~[xmlrpc-server-3.1.3.jar:3.1.3]
    at org.apache.xmlrpc.server.XmlRpcServerWorker.execute(XmlRpcServerWorker.java:46) ~[xmlrpc-server-3.1.3.jar:3.1.3]
    at org.apache.xmlrpc.server.XmlRpcServer.execute(XmlRpcServer.java:86) ~[xmlrpc-server-3.1.3.jar:3.1.3]
    at org.apache.xmlrpc.server.XmlRpcStreamServer.execute(XmlRpcStreamServer.java:200) [xmlrpc-server-3.1.3.jar:3.1.3]
    at org.apache.xmlrpc.webserver.XmlRpcServletServer.execute(XmlRpcServletServer.java:112) [xmlrpc-server-3.1.3.jar:3.1.3]
    at org.apache.xmlrpc.webserver.XmlRpcServlet.doPost(XmlRpcServlet.java:196) [xmlrpc-server-3.1.3.jar:3.1.3]
    at org.exist.xmlrpc.RpcServlet.doPost(RpcServlet.java:67) [exist.jar:?]
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:755) [servlet-api-3.0.jar:?]
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:848) [servlet-api-3.0.jar:?]
    at org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:684) [jetty-servlet-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:503) [jetty-servlet-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:137) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:575) [jetty-security-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:231) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1086) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:429) [jetty-servlet-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:193) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1020) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:135) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.Dispatcher.forward(Dispatcher.java:229) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.Dispatcher.forward(Dispatcher.java:103) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.exist.http.urlrewrite.Forward.doRewrite(Forward.java:50) [exist-optional.jar:?]
    at org.exist.http.urlrewrite.XQueryURLRewrite.service(XQueryURLRewrite.java:223) [exist-optional.jar:?]
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:848) [servlet-api-3.0.jar:?]
    at org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:684) [jetty-servlet-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:503) [jetty-servlet-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:137) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:533) [jetty-security-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:231) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1086) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:429) [jetty-servlet-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:193) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1020) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:135) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:154) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:116) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.Server.handle(Server.java:370) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:494) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.AbstractHttpConnection.content(AbstractHttpConnection.java:982) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.content(AbstractHttpConnection.java:1043) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:865) [jetty-http-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:240) [jetty-http-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.server.AsyncHttpConnection.handle(AsyncHttpConnection.java:82) [jetty-server-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.io.nio.SelectChannelEndPoint.handle(SelectChannelEndPoint.java:696) [jetty-io-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.io.nio.SelectChannelEndPoint$1.run(SelectChannelEndPoint.java:53) [jetty-io-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:608) [jetty-util-8.1.17.v20150415.jar:8.1.17.v20150415]
    at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:543) [jetty-util-8.1.17.v20150415.jar:8.1.17.v20150415]
    at java.lang.Thread.run(Thread.java:745) [?:1.8.0_51]
Caused by: org.exist.EXistException: org.exist.xquery.XPathException: exerr:ERROR Unable to encode string value: Underlying channel has been closed
    at org.exist.xmlrpc.RpcConnection.lambda$queryP$333(RpcConnection.java:1756) ~[exist.jar:?]
    at org.exist.xmlrpc.RpcConnection$$Lambda$109/1906088310.applyXmlRpc(Unknown Source) ~[?:?]
    at org.exist.xmlrpc.function.XmlRpcFunction.apply(XmlRpcFunction.java:45) ~[exist.jar:?]
    at org.exist.xmlrpc.RpcConnection.withDb(RpcConnection.java:3764) ~[exist.jar:?]
    at org.exist.xmlrpc.RpcConnection.withDb(RpcConnection.java:3748) ~[exist.jar:?]
    at org.exist.xmlrpc.RpcConnection.queryP(RpcConnection.java:1662) ~[exist.jar:?]
    at org.exist.xmlrpc.RpcConnection.queryP(RpcConnection.java:3387) ~[exist.jar:?]
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[?:1.8.0_51]
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[?:1.8.0_51]
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[?:1.8.0_51]
    at java.lang.reflect.Method.invoke(Method.java:497) ~[?:1.8.0_51]
    at org.apache.xmlrpc.server.ReflectiveXmlRpcHandler.invoke(ReflectiveXmlRpcHandler.java:115) ~[xmlrpc-server-3.1.3.jar:3.1.3]
    ... 48 more
Caused by: org.exist.xquery.XPathException: exerr:ERROR Unable to encode string value: Underlying channel has been closed
    at org.exist.xquery.value.BinaryValue.getStringValue(BinaryValue.java:225) ~[exist.jar:?]
    at org.exist.xmlrpc.RpcConnection.lambda$queryP$333(RpcConnection.java:1738) ~[exist.jar:?]
    at org.exist.xmlrpc.RpcConnection$$Lambda$109/1906088310.applyXmlRpc(Unknown Source) ~[?:?]
    at org.exist.xmlrpc.function.XmlRpcFunction.apply(XmlRpcFunction.java:45) ~[exist.jar:?]
    at org.exist.xmlrpc.RpcConnection.withDb(RpcConnection.java:3764) ~[exist.jar:?]
    at org.exist.xmlrpc.RpcConnection.withDb(RpcConnection.java:3748) ~[exist.jar:?]
    at org.exist.xmlrpc.RpcConnection.queryP(RpcConnection.java:1662) ~[exist.jar:?]
    at org.exist.xmlrpc.RpcConnection.queryP(RpcConnection.java:3387) ~[exist.jar:?]
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[?:1.8.0_51]
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[?:1.8.0_51]
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[?:1.8.0_51]
    at java.lang.reflect.Method.invoke(Method.java:497) ~[?:1.8.0_51]
    at org.apache.xmlrpc.server.ReflectiveXmlRpcHandler.invoke(ReflectiveXmlRpcHandler.java:115) ~[xmlrpc-server-3.1.3.jar:3.1.3]
    ... 48 more
Caused by: java.io.IOException: Underlying channel has been closed
    at org.exist.xquery.value.BinaryValueFromFile.streamBinaryTo(BinaryValueFromFile.java:56) ~[exist.jar:?]
    at org.exist.xquery.value.BinaryValue.streamTo(BinaryValue.java:254) ~[exist.jar:?]
    at org.exist.xquery.value.BinaryValue.getStringValue(BinaryValue.java:223) ~[exist.jar:?]
    at org.exist.xmlrpc.RpcConnection.lambda$queryP$333(RpcConnection.java:1738) ~[exist.jar:?]
    at org.exist.xmlrpc.RpcConnection$$Lambda$109/1906088310.applyXmlRpc(Unknown Source) ~[?:?]
    at org.exist.xmlrpc.function.XmlRpcFunction.apply(XmlRpcFunction.java:45) ~[exist.jar:?]
    at org.exist.xmlrpc.RpcConnection.withDb(RpcConnection.java:3764) ~[exist.jar:?]
    at org.exist.xmlrpc.RpcConnection.withDb(RpcConnection.java:3748) ~[exist.jar:?]
    at org.exist.xmlrpc.RpcConnection.queryP(RpcConnection.java:1662) ~[exist.jar:?]
    at org.exist.xmlrpc.RpcConnection.queryP(RpcConnection.java:3387) ~[exist.jar:?]
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[?:1.8.0_51]
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[?:1.8.0_51]
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[?:1.8.0_51]
    at java.lang.reflect.Method.invoke(Method.java:497) ~[?:1.8.0_51]
    at org.apache.xmlrpc.server.ReflectiveXmlRpcHandler.invoke(ReflectiveXmlRpcHandler.java:115) ~[xmlrpc-server-3.1.3.jar:3.1.3]
    ... 48 more
```
# Error Case 4
<a name="error-case-4"/>
1. Store a binary document into a temporary location on your filesystem, e.g. `/tmp/me.jpg`.
2. Run the XQuery:

``` xquery
import module namespace file = "http://exist-db.org/xquery/file";
let $bin := file:read-binary("/Users/aretter/Downloads/me.jpg")
return
    file:serialize-binary($bin, "/Users/aretter/Downloads/me2.jpg")
```

and you will get the stack trace:

```
org.xmldb.api.base.XMLDBException: exerr:ERROR Cannot serialize file. A problem occurred while serializing the binary data: /tmp/me2.jpg [at line 3, column 9]
    at org.exist.xmldb.LocalXPathQueryService.execute(LocalXPathQueryService.java:206)
    at org.exist.xmldb.LocalXPathQueryService.lambda$execute$273(LocalXPathQueryService.java:170)
    at org.exist.xmldb.LocalXPathQueryService$$Lambda$139/1854632053.applyXmldb(Unknown Source)
    at org.exist.xmldb.function.LocalXmldbFunction.apply(LocalXmldbFunction.java:46)
    at org.exist.xmldb.AbstractLocal.withDb(AbstractLocal.java:142)
    at org.exist.xmldb.LocalXPathQueryService.execute(LocalXPathQueryService.java:169)
    at org.exist.client.QueryDialog$QueryThread.run(QueryDialog.java:624)
Caused by: org.exist.xquery.XPathException: exerr:ERROR Cannot serialize file. A problem occurred while serializing the binary data: /tmp/me2.jpg [at line 3, column 9]
    at org.exist.xquery.modules.file.SerializeToFile.serializeBinary(SerializeToFile.java:228)
    at org.exist.xquery.modules.file.SerializeToFile.eval(SerializeToFile.java:173)
    at org.exist.xquery.BasicFunction.eval(BasicFunction.java:70)
    at org.exist.xquery.InternalFunctionCall.eval(InternalFunctionCall.java:56)
    at org.exist.xquery.DebuggableExpression.eval(DebuggableExpression.java:58)
    at org.exist.xquery.LetExpr.eval(LetExpr.java:111)
    at org.exist.xquery.AbstractExpression.eval(AbstractExpression.java:71)
    at org.exist.xquery.PathExpr.eval(PathExpr.java:267)
    at org.exist.xquery.AbstractExpression.eval(AbstractExpression.java:71)
    at org.exist.xquery.XQuery.execute(XQuery.java:280)
    at org.exist.xquery.XQuery.execute(XQuery.java:200)
    at org.exist.xmldb.LocalXPathQueryService.execute(LocalXPathQueryService.java:203)
    ... 6 more
Caused by: java.nio.file.NoSuchFileException: /tmp/me2.jpg
    at sun.nio.fs.UnixException.translateToIOException(UnixException.java:86)
    at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:102)
    at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:107)
    at sun.nio.fs.UnixFileSystemProvider.newByteChannel(UnixFileSystemProvider.java:214)
    at java.nio.file.spi.FileSystemProvider.newOutputStream(FileSystemProvider.java:434)
    at java.nio.file.Files.newOutputStream(Files.java:216)
    at org.exist.xquery.modules.file.SerializeToFile.serializeBinary(SerializeToFile.java:225)
    ... 17 more
Caused by: org.exist.xquery.XPathException: exerr:ERROR Cannot serialize file. A problem occurred while serializing the binary data: /tmp/me2.jpg [at line 3, column 9]
    at org.exist.xquery.modules.file.SerializeToFile.serializeBinary(SerializeToFile.java:228)
    at org.exist.xquery.modules.file.SerializeToFile.eval(SerializeToFile.java:173)
    at org.exist.xquery.BasicFunction.eval(BasicFunction.java:70)
    at org.exist.xquery.InternalFunctionCall.eval(InternalFunctionCall.java:56)
    at org.exist.xquery.DebuggableExpression.eval(DebuggableExpression.java:58)
    at org.exist.xquery.LetExpr.eval(LetExpr.java:111)
    at org.exist.xquery.AbstractExpression.eval(AbstractExpression.java:71)
    at org.exist.xquery.PathExpr.eval(PathExpr.java:267)
    at org.exist.xquery.AbstractExpression.eval(AbstractExpression.java:71)
    at org.exist.xquery.XQuery.execute(XQuery.java:280)
    at org.exist.xquery.XQuery.execute(XQuery.java:200)
    at org.exist.xmldb.LocalXPathQueryService.execute(LocalXPathQueryService.java:203)
    at org.exist.xmldb.LocalXPathQueryService.lambda$execute$273(LocalXPathQueryService.java:170)
    at org.exist.xmldb.LocalXPathQueryService$$Lambda$139/1854632053.applyXmldb(Unknown Source)
    at org.exist.xmldb.function.LocalXmldbFunction.apply(LocalXmldbFunction.java:46)
    at org.exist.xmldb.AbstractLocal.withDb(AbstractLocal.java:142)
    at org.exist.xmldb.LocalXPathQueryService.execute(LocalXPathQueryService.java:169)
    at org.exist.client.QueryDialog$QueryThread.run(QueryDialog.java:624)
Caused by: java.nio.file.NoSuchFileException: /tmp/me2.jpg
    at sun.nio.fs.UnixException.translateToIOException(UnixException.java:86)
    at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:102)
    at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:107)
    at sun.nio.fs.UnixFileSystemProvider.newByteChannel(UnixFileSystemProvider.java:214)
    at java.nio.file.spi.FileSystemProvider.newOutputStream(FileSystemProvider.java:434)
    at java.nio.file.Files.newOutputStream(Files.java:216)
    at org.exist.xquery.modules.file.SerializeToFile.serializeBinary(SerializeToFile.java:225)
    ... 17 more
```
# Error Case 5
<a name="error-case-5"/>
1. Store the following XQuery into `/db/stream-from-fs.xqy`:

``` xquery
import module namespace file = "http://exist-db.org/xquery/file";
import module namespace response = "http://exist-db.org/xquery/response";

let $bin := file:read-binary("/tmp/me.jpg")
return
    response:stream($bin, "media-type=image/jpeg")
```
1. Call the stored query as an admin user using curl. e.g. `curl -v http://admin:@localhost:8080/exist/rest/db/stream-from-fs.xqy`

You will see that the output is actually Base64 encoded text and not binary data as it should be:

```
*   Trying ::1...
* Connected to localhost (::1) port 8080 (#0)
* Server auth using Basic with user 'admin'
> GET /exist/rest/db/stream-from-fs.xqy HTTP/1.1
> Host: localhost:8080
> Authorization: Basic YWRtaW46
> User-Agent: curl/7.43.0
> Accept: */*
> 
< HTTP/1.1 200 OK
< Date: Mon, 05 Oct 2015 12:39:11 GMT
< Set-Cookie: JSESSIONID=17z1kikjckqlbmfs2w8pv56dw;Path=/exist
< Expires: Thu, 01 Jan 1970 00:00:00 GMT
< X-XQuery-Cached: true
< Content-Type: image/jpeg; charset=UTF-8
< Transfer-Encoding: chunked
< Server: Jetty(8.1.17.v20150415)
< 
* Connection #0 to host localhost left intact
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
```
# Error Case 6 and 7
<a name="error-case-6"/>

``` xquery
import module namespace transform = "http://exist-db.org/xquery/transform";
import module namespace xslfo = "http://exist-db.org/xquery/xslfo";
import module namespace file = "http://exist-db.org/xquery/file";
import module namespace response = "http://exist-db.org/xquery/response";

let $articles :=
    document { 
        element PubmedArticleSet {
            collection("/db/pubmed/data")//PubmedArticle[1]
        }
    }
return

    let $fo := transform:transform($articles, doc("/db/apps/pubmed/to-pdf-fo.xslt"), ())
    return
        let $pdf := xslfo:render($fo, "application/pdf", ())
        return

            response:stream($pdf, "media-type=application/pdf")

                        (: file:serialize-binary does not work instead of response:stream either! :)
            (:
            file:serialize-binary($pdf, "/tmp/my-output.pdf")
            :)
```