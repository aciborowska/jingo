eXist-db 4.3.1 macOS Mojave.

I'm trying to get to the core of the problem but so far I cannot get closer than this query fragment:

```xquery
declare variable $colDecorCache     := collection('/db/apps/decor/cache');
declare variable $colDecorData      := collection('/db/apps/decor/data');

declare function local:getTemplateById($id as xs:string, $flexibility as xs:string?, $prefix as xs:string, $version as xs:string?) {

let $internalrepositories       := $colDecorData/decor[project/@prefix = $prefix][1]
let $buildingBlockRepositories  := $internalrepositories/project/buildingBlockRepository
let $x                          := local:getTemplateById($prefix, $id, $prefix, $buildingBlockRepositories, ())

return ()
};

declare %private function local:getTemplateById($basePrefix as xs:string, $id as xs:string, $prefix as xs:string, $externalrepositorylist as element()*, $bbrList as element()*) as element()* {
    for $repository in $externalrepositorylist
    let $repourl                := $repository/@url
    let $repoident              := $repository/@ident
    return
        <repositoryTemplateList>
        {
                let $cachedProject  := $colDecorCache//cacheme[@bbrident = $repoident][@bbrurl = $repourl]/decor
                return ()
        }
        </repositoryTemplateList>
};

<x>
{
    (: Don't show links for templates in versioned projects :)
    for $projectTemplateSet in $colDecorData/decor[@repository = 'true']//template[@ref]
    let $prefix                 := $projectTemplateSet/ancestor::decor/project/@prefix
    let $tid                    := $projectTemplateSet/@id | $projectTemplateSet/@ref
    group by $prefix, $tid
    order by $prefix, $tid
    return (
        for $template in $projectTemplateSet
        return (
            if ($template[@ref]) then (
                local:getTemplateById($template/@ref, 'dynamic', $prefix, ())//template[@id]
            ) else ()
        )
    )
}
</x>
```

This code yields a NullPointException from the exist.log no stack trace:

```
2018-08-03 17:30:41,336 [qtp1226557879-3531] INFO  (XQueryServlet.java [init]:158) - encoding = UTF-8 
2018-08-03 17:30:41,371 [qtp1226557879-3531] ERROR (XQueryServlet.java [process]:552) - null 
java.lang.NullPointerException: null
```

When I remove the line "order by $prefix, $tid" the xquery finishes normally. When I remove the line "let $cachedProject  := $colDecorCache//cacheme[@bbrident = $repoident][@bbrurl = $repourl]/decor" the xquery finishes normally.

The collection that $colDecorCache operates on has combined range indexes configured.

This xquery fragment is hard to replay anywhere else because of data requirements. I still hope we can get to the bottom of it.
