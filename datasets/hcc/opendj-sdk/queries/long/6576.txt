The instructions to setup a Proxy Server when the Proxy server and the remote DS servers are in Production-mode, does not work. It results in `# The LDAP search request failed: 50 (Insufficient Access Rights)`  error when you try an ldapsearch via the Proxy.

In the DS Install Guide, at https://backstage.forgerock.com/docs/ds/6.5/install-guide/#setup-server-proxy , step 3, states the controls required if installing the Proxy in Production mode:


If you used the --productionMode setup option, explicitly grant appropriate access to remote data.
The following example grants authenticated users access to read data under dc=example,dc=com, and to use some LDAP controls and extended operations: 

But this is incomplete.

The following line needs to be added as well:   "ds-cfg-request-target-dn-equal-to: dc=example,dc=com"

​That is, the full command should look like:


$ dsconfig \
 create-global-access-control-policy \
 --hostname opendj.example.com \
 --port 4444 \
 --bindDN "cn=Directory Manager" \
 --bindPassword password \
 --policy-name "Authenticated access to example.com data" \
 --set authentication-required:true \
 --set request-target-dn-equal-to:"**,dc=example,dc=com" \
 --set request-target-dn-equal-to:"dc=example,dc=com" \ 
 --set permission:read \
 --set allowed-attribute:"*" \
 --set allowed-attribute:isMemberOf \
 --set allowed-attribute-exception:authPassword \
 --set allowed-attribute-exception:userPassword \
 --set allowed-control:Assertion \
 --set allowed-control:AuthorizationIdentity \
 --set allowed-control:Noop \
 --set allowed-control:PasswordPolicy \
 --set allowed-control:PermissiveModify \
 --set allowed-control:PostRead \
 --set allowed-control:PreRead \
 --set allowed-control:ProxiedAuthV2 \
 --set allowed-control:RealAttributesOnly \
 --set allowed-control:ServerSideSort \
 --set allowed-control:SimplePagedResults \
 --set allowed-control:TransactionId \
 --set allowed-control:VirtualAttributesOnly \
 --set allowed-control:Vlv \
 --set allowed-extended-operation:PasswordModify \
 --set allowed-extended-operation:PasswordPolicyState \
 --set allowed-extended-operation:StartTls \
 --set allowed-extended-operation:WhoAmI \
 --trustAll \
 --no-prompt 

 

Additionally, it is required to add the following line in the config.ldif for the remote DS servers, under the section for "dn: cn=Access Control Handler,cn=config"  :


ds-cfg-global-aci: (targetcontrol="2.16.840.1.113730.3.4.18") (version 3.0; acl "Authenticated users control access"; allow(read) userdn="ldap:///all";)

That is, the full section looks like this:

 


 dn: cn=Access Control Handler,cn=config
objectClass: top
objectClass: ds-cfg-access-control-handler
objectClass: ds-cfg-dsee-compat-access-control-handler
cn: Access Control Handler
ds-cfg-java-class: org.opends.server.authorization.dseecompat.AciHandler
ds-cfg-enabled: true
ds-cfg-global-aci: (targetcontrol="2.16.840.1.113730.3.4.18") (version 3.0; acl "Authenticated users control access"; allow(read) userdn="ldap:///all";)
ds-cfg-global-aci: (extop="1.3.6.1.4.1.26027.1.6.3 || 1.3.6.1.4.1.1466.20037") (version 3.0; acl "Anonymous extended operation access"; allow(read) userdn="ldap:///anyone";)
ds-cfg-global-aci: (extop="1.3.6.1.4.1.4203.1.11.1 || 1.3.6.1.4.1.4203.1.11.3 || 1.3.6.1.1.8") (version 3.0; acl "Authenticated users extended operation access"; allow(read) userdn="ldap:///all";)
ds-cfg-global-aci: (target="ldap:///")(targetscope="base") (targetattr="objectClass||namingContexts||supportedAuthPasswordSchemes||supportedControl||supportedExtension||supportedFeatures||supportedLDAPVersion||supportedSASLMechanisms||supportedTLSCiphers||supportedTLSProtocols||vendorName||vendorVersion||alive||healthy")(version 3.0; acl "User-Visible Root DSE Operational Attributes"; allow (read,search,compare) userdn="ldap:///anyone";)
ds-cfg-global-aci: (target="ldap:///cn=schema")(targetscope="base") (targetattr="objectClass||attributeTypes||dITContentRules||dITStructureRules ||ldapSyntaxes||matchingRules||matchingRuleUse||nameForms||objectClasses") (version 3.0; acl "User-Visible Schema Operational Attributes"; allow (read,search,compare) userdn="ldap:///all";)
ds-cfg-global-aci: (targetcontrol="1.3.6.1.4.1.36733.2.1.5.1") (version 3.0; acl "Transaction ID control access"; allow(read) userdn="ldap:///all";)
ds-cfg-global-aci: (targetcontrol="1.3.6.1.1.13.1||1.3.6.1.1.13.2 ||1.2.840.113556.1.4.805||1.2.840.113556.1.4.1413") (version 3.0; acl "REST to LDAP control access"; allow(read) userdn="ldap:///all";)

 

Without the above changes to the Proxy server and the remote DS servers, ldapsearches via the Proxy doesn't work.