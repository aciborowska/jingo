OpenDJ 2.4.5
Build ID: 20120220171857Z
Revision Number: 7743

Manually deleting an objectclass from 99-user.ldif does not get replicated.

Set up 2 servers (M1 and M2) and enable/init replication between then.
Stop M1 and add a new objectclass:

objectClasses: ( newtestobjectclass-oid NAME 'newtestobjectclass-0' SUP person MUST ( street $ c ) X-ORIGIN 'user defined' )

Start M1 and wait for it to be replicated. Check config/schema/99-user.ldif on M2.

cat m2/config/schema/99-user.ldif
dn: cn=schema
objectClass: top
objectClass: ldapSubentry
objectClass: subschema
cn: schema
objectClasses: ( newtestobjectclass-oid NAME 'newtestobjectclass-0' SUP person MUST ( street $ c ) X-ORIGIN 'user defined' )
ds-sync-generation-id: 8408
ds-sync-state: 00000136121012733fd700000001

Stop M1 and delete the new objectclass.

Start M1 and wait to allow for schema to be replicated.

cat ../m1/config/schema/99-user.ldif 
dn: cn=schema
objectClass: top
objectClass: ldapSubentry
objectClass: subschema
cn: schema
ds-sync-generation-id: 8408
ds-sync-state: 0000013612113c1e3fd700000002

cat ../m2/config/schema/99-user.ldif 
dn: cn=schema
objectClass: top
objectClass: ldapSubentry
objectClass: subschema
cn: schema
objectClasses: ( newtestobjectclass-oid NAME 'newtestobjectclass-0' SUP person MUST ( street $ c ) X-ORIGIN 'user defined' )
ds-sync-generation-id: 8408
ds-sync-state: 0000013612113c1e3fd700000002

#Comment
This problem happens because when the delete is done manually in the 99-user.ldif the operation that is generated by the core server on restart is : a modify operation consisting in a delete attribute objectClasses. This is probably because the 99 user does not contain an objectclass definition anymore.

When the replication try to replay this operation on the remote server, the remote server correctly refuses this operation because it would make no sense to remove all the objectClasses of the schema.

A possible fixe is for the core server to generate the operation with a delete of only the deleted values even if this is the last value in this file.