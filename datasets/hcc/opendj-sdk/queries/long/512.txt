I have been playing around with the asynchronous LDAP client api to see what sort of tps rate I can get with it. I have found that the connection seems to die when I try to push a lot of transactions through it. I dug a little into the lower layers of the code and there seems to be an unexpected EOF in the workflow, causing an EOFException. The SearchResultHandler.handleErrorResult gets called and shows a "Server Connection Closed" exception. Once this happens, connection.isValid() returns false but connection.isClosed() also returns false. After this no more queries can be sent to the server. See the attached standalone source file which produces the following results (adjust the params at the top as necessary):

1. With an unauthenticated connection, I can send 100 search queries successfully. If I change the loop to send 200 or more the connection dies as explained above - but it doesn't necessarily die at a specific quantity of transactions, it could die after 3 successful responses or 150. It's as though it gets swamped and dies at a random point.

2. With an authenticated connection, I can send 1000 search queries successfully. If I change the loop to send 2000 or more the same problem happens as in (1). I suspect that I can send more in this second test before hitting a problem as there is a little more happening behind the scenes and it executes a little slower.

3. If I add a 1ms sleep to the loop sending the queries, I can send any amount of queries successfully - but obviously this limits the rate at which results can be obtained. Possibly a concurrency issue? 

I have written a small worker pool / queue that uses a synchronous JNDI or Spring LDAP client and with this I can push the tps rate to about 6000 (same destination LDAP servers). I tried using the OpenDJ synchronous API and plugged it into my worker pool (one long-lived Connection per worker) but could not push this anywhere near this rate (1000 - 2000 tps).

One other thing, I ran the same tests with an embedded Apache DS and I didn't hit this problem. My tps rate is a bit more limited though as its all running on my laptop, so it maxes out the CPUs - getting around 3000 tps.


	Using opendj-ldap-sdk 3.0.0-M2 from http://maven.forgerock.org/repo/releases
	Tested using OpenLDAP 2.4.30 on Redhat 6.1 and OpenLDAP 2.4.23 on CentOS 6.2 (same issue on both)



Let me know if you need anything else!

Thanks.

Chris.