dsreplication initialize-all --port 4444 uses the --port of the local instance instead, overwriting the --port 4444 server with the contents of the local server.

Use Case:

	Setup Master 1 with 1000 entries and configure replication
	Setup Master 2 with a base entry, configure replication
	Initialize Master 2 from Master 1.



DJ 3.0.0 behavior: Master 2 has a copy of Master 1's data - 1000 entries.
DJ 4.0.0 behavior: Master 2 has overwritten Master 1's data - 1 entry.

Example:

Note, the same script was used to setup Master 1 and 2 on OpendJ 3.0.0 as it was with OpenDJ 4.0.0-SNAPSHOT (opendj-4.0.0-20160516.zip)

OpenDJ 3.0.0


Install Master1 with 1000 entries & setup replication



          --- Server Status ---
Server Run Status:        Started
Open Connections:         1

          --- Server Details ---
Host Name:                opendj.forgerock.com
Administrative Users:     cn=Directory Manager
Installation Path:        /opt/instances/replissue/master1
Version:                  OpenDJ 3.0.0
Java Version:             1.8.0_45
Administration Connector: Port 4444 (LDAPS)

          --- Connection Handlers ---
Address:Port : Protocol               : State
-------------:------------------------:---------
--           : LDIF                   : Enabled
8989         : Replication            : Enabled
0.0.0.0:161  : SNMP                   : Disabled
0.0.0.0:1389 : LDAP (allows StartTLS) : Enabled
0.0.0.0:1636 : LDAPS                  : Enabled
0.0.0.0:1689 : JMX                    : Disabled
0.0.0.0:8080 : HTTP                   : Disabled

          --- Data Sources ---
Base DN:                      dc=forgerock,dc=com
Backend ID:                   userRoot
Entries:                      1000
Replication:                  Enabled
Missing Changes:              0
Age of Oldest Missing Change: <not available>



Install Master2 with The Base Entry & setup replication



Configuring Directory Server ..... Done.
Configuring Certificates ..... Done.
Creating Base Entry dc=forgerock,dc=com ..... Done.
Starting Directory Server ....... Done.



Enable Replication



Establishing connections ..... Done.
Checking registration information ..... Done.
Updating remote references on server opendj.forgerock.com:4444 ..... Done.
Configuring Replication port on server opendj.forgerock.com:5444 ..... Done.
Updating replication configuration for baseDN dc=forgerock,dc=com on server
opendj.forgerock.com:4444 .....Done.
Updating replication configuration for baseDN dc=forgerock,dc=com on server
opendj.forgerock.com:5444 .....Done.
Updating registration configuration on server opendj.forgerock.com:4444 ..... Done.
Updating registration configuration on server opendj.forgerock.com:5444 ..... Done.
Updating replication configuration for baseDN cn=schema on server
opendj.forgerock.com:4444 .....Done.
Updating replication configuration for baseDN cn=schema on server
opendj.forgerock.com:5444 .....Done.
Initializing registration information on server opendj.forgerock.com:5444 with
the contents of server opendj.forgerock.com:4444 .....Done.
Initializing schema on server opendj.forgerock.com:5444 with the contents of
server opendj.forgerock.com:4444 .....Done.

Replication has been successfully enabled.  Note that for replication to work
you must initialize the contents of the base DNs that are being replicated
(use dsreplication initialize to do so).


See
/var/folders/32/hqbp0t2n5k73f9ssp3ssc9740000gn/T/opendj-replication-5412519990397499312.log
for a detailed log of this operation.



Initializing All Replicas from 4444

Note the command uses Master1's Admin Port  - the command output shows it initializing with the contents from Master1 -> opendj.forgerock.com:4444 [GOOD]



bin/dsreplication initialize-all --adminUID admin --adminPassword password --baseDN dc=forgerock,dc=com --hostname opendj.forgerock.com --port 4444 --trustAll --no-prompt

Initializing base DN dc=forgerock,dc=com with the contents from
opendj.forgerock.com:4444:
1000 entries processed (100 % complete).
Base DN initialized successfully.

See
/var/folders/32/hqbp0t2n5k73f9ssp3ssc9740000gn/T/opendj-replication-5768674326125458829.log
for a detailed log of this operation.






          --- Server Status ---
Server Run Status:        Started
Open Connections:         1

          --- Server Details ---
Host Name:                opendj.forgerock.com
Administrative Users:     cn=Directory Manager
Installation Path:        /opt/instances/replissue/master2
Version:                  OpenDJ 3.0.0
Java Version:             1.8.0_45
Administration Connector: Port 5444 (LDAPS)

          --- Connection Handlers ---
Address:Port : Protocol               : State
-------------:------------------------:---------
--           : LDIF                   : Enabled
9989         : Replication (secure)   : Enabled
0.0.0.0:161  : SNMP                   : Disabled
0.0.0.0:1689 : JMX                    : Disabled
0.0.0.0:2389 : LDAP (allows StartTLS) : Enabled
0.0.0.0:2636 : LDAPS                  : Enabled
0.0.0.0:8080 : HTTP                   : Disabled

          --- Data Sources ---
Base DN:                      dc=forgerock,dc=com
Backend ID:                   userRoot
Entries:                      1000
Replication:                  Enabled
Missing Changes:              0
Age of Oldest Missing Change: <not available>



Result: Master 2 has a copy of Master 1's data - 1000 entries.



OpenDJ 4.0.0-SNAPSHOT

Install Master1 with 1000 entries & setup replication


Configuring Directory Server ..... Done.
Configuring Certificates ..... Done.
Importing Automatically-Generated Data (998 Entries) ...... Done.
Starting Directory Server ....... Done.





          --- Server Status ---
Server Run Status:        Started
Open Connections:         2

          --- Server Details ---
Host Name:                opendj.forgerock.com
Administrative Users:     cn=Directory Manager
Installation Path:        /opt/instances/replissue/master1
Version:                  OpenDJ Server 4.0.0-SNAPSHOT
Java Version:             1.8.0_45
Administration Connector: Port 4444 (LDAPS)

          --- Connection Handlers ---
Address:Port : Protocol               : State
-------------:------------------------:---------
--           : LDIF                   : Enabled
8989         : Replication            : Enabled
0.0.0.0:161  : SNMP                   : Disabled
0.0.0.0:1389 : LDAP (allows StartTLS) : Enabled
0.0.0.0:1636 : LDAPS                  : Enabled
0.0.0.0:1689 : JMX                    : Disabled
0.0.0.0:8080 : HTTP                   : Disabled

          --- Data Sources ---
Base DN:                      dc=forgerock,dc=com
Backend ID:                   userRoot
Entries:                      1000
Replication:                  Enabled
Missing Changes:              0
Age of Oldest Missing Change: <not available>



Install Master2 with The Base Entry & setup replication

Enable Replication


Establishing connections ..... Done.
Checking registration information ..... Done.
Updating remote references on server opendj.forgerock.com:4444 ..... Done.
Configuring Replication port on server opendj.forgerock.com:5444 ..... Done.
Updating replication configuration for baseDN dc=forgerock,dc=com on server
opendj.forgerock.com:4444 .....Done.
Updating replication configuration for baseDN dc=forgerock,dc=com on server
opendj.forgerock.com:5444 .....Done.
Updating registration configuration on server opendj.forgerock.com:4444 ..... Done.
Updating registration configuration on server opendj.forgerock.com:5444 ..... Done.
Updating replication configuration for baseDN cn=schema on server
opendj.forgerock.com:4444 .....Done.
Updating replication configuration for baseDN cn=schema on server
opendj.forgerock.com:5444 .....Done.
Initializing registration information on server opendj.forgerock.com:5444 with
the contents of server opendj.forgerock.com:4444 .....Done.
Initializing schema on server opendj.forgerock.com:5444 with the contents of
server opendj.forgerock.com:4444 .....Done.

Replication has been successfully enabled.  Note that for replication to work
you must initialize the contents of the base DNs that are being replicated
(use dsreplication initialize to do so).


See
/var/folders/32/hqbp0t2n5k73f9ssp3ssc9740000gn/T/opendj-replication-1879878790189105345.log
for a detailed log of this operation.



Initializing All Replicas from 4444

Note the command uses Master1's Admin Port yet the command output shows it initializing with the contents from Master2 -> opendj.forgerock.com:5444 [BAD]



bin/dsreplication initialize-all --adminUID admin --adminPassword password --baseDN dc=forgerock,dc=com --hostname opendj.forgerock.com --port 4444 --trustAll --no-prompt

Initializing base DN dc=forgerock,dc=com with the contents from
opendj.forgerock.com:5444:
1 entries processed (100 % complete).
Base DN initialized successfully.

See
/var/folders/32/hqbp0t2n5k73f9ssp3ssc9740000gn/T/opendj-replication-7839884122632623417.log
for a detailed log of this operation.





          --- Server Status ---
Server Run Status:        Started
Open Connections:         2

          --- Server Details ---
Host Name:                opendj.forgerock.com
Administrative Users:     cn=Directory Manager
Installation Path:        /opt/instances/replissue/master2
Version:                  OpenDJ Server 4.0.0-SNAPSHOT
Java Version:             1.8.0_45
Administration Connector: Port 5444 (LDAPS)

          --- Connection Handlers ---
Address:Port : Protocol               : State
-------------:------------------------:---------
--           : LDIF                   : Enabled
9989         : Replication (secure)   : Enabled
0.0.0.0:161  : SNMP                   : Disabled
0.0.0.0:1689 : JMX                    : Disabled
0.0.0.0:2389 : LDAP (allows StartTLS) : Enabled
0.0.0.0:2636 : LDAPS                  : Enabled
0.0.0.0:8080 : HTTP                   : Disabled

          --- Data Sources ---
Base DN:                      dc=forgerock,dc=com
Backend ID:                   userRoot
Entries:                      1
Replication:                  Enabled
Missing Changes:              0
Age of Oldest Missing Change: <not available>



Result: Master 2 has overwritten Master 1's data - 1 entry.