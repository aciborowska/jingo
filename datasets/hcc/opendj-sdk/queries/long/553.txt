I’ve been testing the FailoverLoadBalancingAlgorithm but it doesn’t seem to be working as I expected. I've attached example code which shows this – I have tested it with an in-memory test LDAP server and with real instances of the OpenDJ server, in both cases I get the same results. 

In the ConnectionDemonstrator (I’ve removed imports and some other code to keep it small), the testFailoverConnection() method will create the failover connection factory, then it will test the connection. After that it will drop the first/primary LDAP server, wait a couple of seconds, then do two more tests of the connection. My expectation is that we’ll get a connection to the secondary but this does not happen – instead the code hangs trying to get a connection to the primary. The second query (the first one after the primary is killed) fails and the following is output to stderr:

Jul 03, 2012 10:54:09 AM org.forgerock.opendj.ldap.FixedConnectionPool$PooledConnection close
WARNING: Connection no longer valid. currentPoolSize=1, poolSize=10

It is then the third query (the second one after the primary is killed) where the code hangs. I’ve attached a stack trace which shows that we are hung at “FixedConnectionPool.getConnection() line: 791” – waiting on the get() of the FutureResult, which never returns. It seems to be waiting to get a connection to the primary, not the secondary.
