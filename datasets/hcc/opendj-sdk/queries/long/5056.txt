Found with 6.5.0 rev 0bb3f4a81aa

We have 2 servers replicated on dc=com and o=new_suffix_repl, with some data.
Then we setup and add a new server in the topology:


./DJ1/opendj/bin/dsreplication configure --host1 nameserver.example.com --port1 4444 --bindDN1 "cn=Directory Manager" --bindPassword1 "password" --replicationPort1 8989 --host2 nameserver.example.com --port2 4446 --bindDN2 "cn=Directory Manager" --bindPassword2 "password" --replicationPort2 8991 -b dc=com -I admin -w password -X -n



We add a new base dn on this new server:


./DJ3/opendj/bin/dsconfig -h nameserver.example.com -p 4446 -D "cn=Directory Manager" -w password -X set-backend-prop --backend-name userRoot --add base-dn:o=new_suffix_repl -n



Then we configure replication for this base dn:

./DJ1/opendj/bin/dsreplication configure --host1 nameserver.example.com --port1 4444 --bindDN1 "cn=Directory Manager" --bindPassword1 "password" --replicationPort1 8989 --host2 nameserver.example.com --port2 4446 --bindDN2 "cn=Directory Manager" --bindPassword2 "password" --replicationPort2 8991 -b o=new_suffix_repl -I admin -w password -X -n



at this stage, we get an exception in DJ3/opendj/logs/errors:


[04/May/2018:15:19:59 +0200] category=CORE severity=ERROR msgID=140 msg=An uncaught exception during processing for thread Change number indexer has caused it to terminate abnormally. The stack trace for that exception is: IllegalStateException: After reinitializing the cursors, expected the record read from the change number index DB (baseDN=dc=com, csn=000001632b4eb6720003000000fb (sid=3,tsd=Fri May 04 15:19:28 CEST 2018,ts=1525439968882,seqnum=251)) to be the same as the current record (baseDN=dc=com, csn=000001632b4eb6720003000000fb (sid=3,tsd=Fri May 04 15:19:28 CEST 2018,ts=1525439968882,seqnum=251)), but it was not (ChangeNumberIndexer.java:426 ChangeNumberIndexer.java:345)



To reproduce it, you need to run the whole replication_group2.ExternalChangelogFailover suite and it happens in New_RS_Joining_Existing_Topology_Multiple_Suffixes.


./run-pybot.py -s replication_group2.ExternalChangelogFailover opendj

