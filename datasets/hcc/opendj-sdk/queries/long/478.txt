When I try getting the change number from an entry change notification response control, the number always seems to be -1, regardless of the change number shown for the modification under cn=changelog.

My code looks like this:


        if(isSupported(PersistentSearchRequestControl.OID)) {
            final SearchRequest request =
                    Requests.newSearchRequest(
                            "dc=example,dc=com",
                            SearchScope.WHOLE_SUBTREE,
                            "(objectclass=inetOrgPerson)",
                            "cn");
            request.addControl(PersistentSearchRequestControl.newControl(
                    true, true, true,
                    PersistentSearchChangeType.ADD,
                    PersistentSearchChangeType.DELETE,
                    PersistentSearchChangeType.MODIFY,
                    PersistentSearchChangeType.MODIFY_DN));

            final ConnectionEntryReader reader = connection.search(request);

            try {
                while (reader.hasNext()) {
                    if (!reader.isReference()) {
                        final SearchResultEntry entry = reader.readEntry();
                        System.out.println("Entry changed: "
                                + entry.getName().toString());

                        EntryChangeNotificationResponseControl control =
                                entry.getControl(
                                        EntryChangeNotificationResponseControl.DECODER,
                                        new DecodeOptions());

                        PersistentSearchChangeType type = control.getChangeType();
                        System.out.println("Change type: " + type.toString());
                        if (type.equals(PersistentSearchChangeType.MODIFY_DN)) {
                            System.out.println("Previous DN: "
                                    + control.getPreviousName().toString());
                        }
                        System.out.println("Change number: "
                                + control.getChangeNumber());
                        System.out.println(); // Add a blank line.
                   }
                }
            } catch (final DecodeException e) {
                e.printStackTrace();
            } catch (final ErrorResultIOException e) {
                e.printStackTrace();
            } catch (final SearchResultReferenceIOException e) {
                e.printStackTrace();
            }
        }



Running the code, I change abarnes room number, and see this:


Entry changed: uid=abarnes,ou=People,dc=example,dc=com
Change type: modify
Change number: -1



At the same time, this is what I see in the change log. Notice changeNumber: 2.


dn: changeNumber=2,cn=changelog
targetDN: uid=abarnes,ou=people,dc=example,dc=com
changeNumber: 2
changes:: cmVwbGFjZTogcm9vbW51bWJlcgpyb29tbnVtYmVyOiAxMTExCi0KcmVwbGFjZTogbW9kaW
 ZpZXJzTmFtZQptb2RpZmllcnNOYW1lOiBjbj1EaXJlY3RvcnkgTWFuYWdlcixjbj1Sb290IEROcyxjb
 j1jb25maWcKLQpyZXBsYWNlOiBtb2RpZnlUaW1lc3RhbXAKbW9kaWZ5VGltZXN0YW1wOiAyMDEyMDUw
 MzExMzA1NloKLQo=
changeType: modify
changeTime: 20120503113056Z
objectClass: top
objectClass: changeLogEntry
targetEntryUUID: e2e8cb75-44ff-32b3-9db9-a300d635bbf9
replicationCSN: 00000137127795d46ef700000002
numSubordinates: 0
replicaIdentifier: 28407
changeLogCookie: dc=example,dc=com:00000137127795d46ef700000002;
changeInitiatorsName: cn=Directory Manager,cn=Root DNs,cn=config
subschemaSubentry: cn=schema
hasSubordinates: false
entryDN: changeNumber=2,cn=changelog



Maybe those change numbers aren't too valuable in reality, but the SDK should still get the same value as what shows up in the change log.