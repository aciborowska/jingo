Found with opendj 6.0.0 rev e4db3e19a569f87ea49a8e7f5c6c233695f073cb

We setup a DJ with some generated entries and ssl/startTLS enabled.
We setup a proxy in front of this DJ, with a trustore, ssl/startTLS enabled and we import the DJ server certificate in the proxy truststore.
We add proxied-auth privilege for root user of DJ.
And release all control policies for proxy:


/tmp/PROXY/opendj/bin/dsconfig -h nameserver.example.com -p 4445 -D cn=myself -w password -X set-global-access-control-policy-prop --policy-name "Authenticated access all entries" --add permission:read --add permission:write --set allowed-attribute:* -n



We check that the proxy is set up correctly:


PROXY/opendj/bin/ldapsearch -h nameserver.example.com -p 1390 -D cn=myself -w password -b "cn=monitor"  "ds-backend-id=proxyRoot" ds-proxy-backend-partition
dn: cn=proxyRoot,cn=Backends,cn=monitor
ds-proxy-backend-partition: {"id":"Static Servers Service Discovery Mechanism","primaryServers":[{"hostPort":"nameserver.example.com:1644","online":true}],"secondaryServers":[]}



But when trying to access user.0 of DJ through the proxy, we are not authorized:

./PROXY/opendj/bin/ldapsearch -h nameserver.example.com -p 1390 -D "uid=user.0,ou=people,dc=example,dc=com" -w password -b "dc=example,dc=com"  "(objectclass=*)" 
# The LDAP search request failed: 123 (Authorization Denied)
# Additional Information:  You do not have sufficient privileges to use the proxied authorization control



This procedure works for 5.5.0.

IN DJ logs:


{"eventName":"DJ-LDAP","client":{"ip":"127.0.0.1","port":35226},"server":{"ip":"127.0.0.1","port":1644},"request":{"protocol":"LDAPS","operation":"SEARCH","connId":3,"msgId":75,"dn":"dc=example,dc=com","scope":"sub","filter":"(objectClass=*)","attrs":["ALL"]},"transactionId":"b1fe06d9-af40-4732-8234-b704a2360507-606","response":{"status":"FAILED","statusCode":"123","elapsedTime":1,"elapsedTimeUnits":"MILLISECONDS","detail":"You do not have sufficient privileges to use the proxied authorization control","nentries":0},"timestamp":"2018-01-15T17:34:46.572Z","_id":"b1fe06d9-af40-4732-8234-b704a2360507-608"}



script to reproduce in attachment