During upgrade of OpenAM's embedded DJ from 2.6.2 to 3.0.0-M6 we are seeing one of the following two errors (non-deterministic which one is displayed):



>>>> OpenDJ was successfully upgraded from version 2.6.2.11096 to
3.0.0.7878f040fe08795b08fec3bea180c0cc2951c993


>>>> Performing post upgrade tasks

  Rebuilding all indexes............   25%     org.opends.server.tools.RebuildIndex:12/08/2015 08:41:25:901 PM GMT: Thread[localhost-startStop-1,5,main]: TransactionId[6cba59d1-1b53-4772-8069-e0f654128d0a-2]
ERROR: An error occurred while attempting to perform index rebuild:  IllegalStateException(Unclosed Database: /dc=org,dc=forgerock,dc=openam/sunxmlKeyValue.caseIgnoreMatch
Unclosed Database: /dc=org,dc=forgerock,dc=openam/cn.caseIgnoreSubstringsMatch:6
Unclosed Database: /dc=org,dc=forgerock,dc=openam/objectClass.objectIdentifierMatch
Unclosed Database: /dc=org,dc=forgerock,dc=openam/sn.caseIgnoreMatch
Unclosed Database: /dc=org,dc=forgerock,dc=openam/uid.caseIgnoreMatch
Unclosed Database: /dc=org,dc=forgerock,dc=openam/aci.presence
Unclosed Database: /dc=org,dc=forgerock,dc=openam/state
Unclosed Database: /dc=org,dc=forgerock,dc=openam/entryUUID.uuidMatch
Unclosed Database: /dc=org,dc=forgerock,dc=openam/id2entry
Databases left open: 9
)
  Rebuilding all indexes..............................................   FAIL
  [!] An error occurred during post upgrade task. Process aborted. Please
  check log for further details



or



>>>> Performing post upgrade tasks

  Rebuilding all indexes............   25%     org.opends.server.tools.RebuildIndex:12/08/2015 09:26:29:814 PM GMT: Thread[localhost-startStop-1,5,main]: TransactionId[8406ab08-3793-4fc6-8517-38e32c5c5326-2]
ERROR: An error occurred while attempting to perform index rebuild:  Execution error during backend operation: org.opends.server.backends.pluggable.spi.StorageRuntimeException: java.util.concurrent.ExecutionException: java.lang.NegativeArraySizeException (id=org.opends.messages.backend-445)
  Rebuilding all indexes..............................................   FAIL
  [!] An error occurred during post upgrade task. Process aborted. Please
  check log for further details



Setting breakpoints shows that the root cause is this exception in OnDiskMergeImporter:



java.lang.NegativeArraySizeException
at org.opends.server.backends.pluggable.OnDiskMergeImporter$BufferPool$OffHeapBuffer.readByteString(OnDiskMergeImporter.java:2859)
at org.opends.server.backends.pluggable.OnDiskMergeImporter$ExternalSortChunk$InMemorySortedChunk$InMemorySortedChunkCursor.next(OnDiskMergeImporter.java:1672)
at org.opends.server.backends.pluggable.OnDiskMergeImporter$ExternalSortChunk$CollectorCursor.<init>(OnDiskMergeImporter.java:1958)
at org.opends.server.backends.pluggable.OnDiskMergeImporter$ExternalSortChunk$2.call(OnDiskMergeImporter.java:1496)
at org.opends.server.backends.pluggable.OnDiskMergeImporter$ExternalSortChunk$2.call(OnDiskMergeImporter.java:1486)
at java.util.concurrent.FutureTask.run(FutureTask.java:266)
at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
at java.util.concurrent.FutureTask.run(FutureTask.java:266)
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
at java.lang.Thread.run(Thread.java:745)

