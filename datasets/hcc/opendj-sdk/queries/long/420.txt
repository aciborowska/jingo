Under rare circumstances LDAPS connections fail with an SSLException while reading data from the socket. The exact circumstances which cause the errors are very hard to reproduce but seem to involve the following:


	SSL connection to the LDAPS port: cipher and protocol seems unimportant. We have reproduced the issue with a null cipher
	Connect, simple bind, then perform more than one large search request (example below)
	Repeat on several connections at once and 1 thread per connection
	Seems to depend on a slowish network latency



After one or two searches the following exceptions may be observed in the access log:


[03/Nov/2011:12:09:53 -0400] DISCONNECT conn=854223 reason="Protocol Error" msg="The client sent a request to the Directory Server that could not be properly decoded as an LDAP message: javax.net.ssl.SSLException: Unsupported record version Unknown-126.120"
[03/Nov/2011:12:12:57 -0400] DISCONNECT conn=854297 reason="Protocol Error" msg="The client sent a request to the Directory Server that could not be properly decoded as an LDAP message: javax.net.ssl.SSLProtocolException: Input SSL/TLS record too big: max = 33049 len = 43166"
[04/Nov/2011:13:51:30 -0400] DISCONNECT conn=26265 reason="Protocol Error" msg="The client sent a request to the Directory Server that could not be properly decoded as an LDAP message: javax.net.ssl.SSLException: bad record MAC"


Use of tcpdump/wireshark does not seem to indicate any problems with the packets coming from the client. The tools are able to decode and decrypt them as LDAP messages without any problems. Here are the commands to use (replace xxxxx with a client port associated with a connection which failed):


$ tcpdump -w ldap-ssl.pcap -i eth0 tcp port 1636 -s 0

$ wireshark -o "ssl.desegment_ssl_records: TRUE" \
    -o "ssl.desegment_ssl_application_data: TRUE" \
    -o "ssl.keys_list:,1636,ldap,/path/to/ssl-private-key.pem" \
    -r ldap-ssl.pcap \
    -R "(tcp.port == xxxxx)"


To convert a JKS private key to a pem do the following using the attached GetPrivateKey tool:


$ java -cp ~/path/to/GetPrivateKey GetPrivateKey `cat config/keystore.pin` `cat config/keystore.pin` config/keystore server-cert > key.der
$ openssl pkcs8 -inform der -in key.der -outform pem -out ssl-private-key.pem -nocrypt


Here's an example search filter which may trigger the SSL failure:


"(&(|(sunxmlKeyValue=subjectindex=identity:=id=bjensen,ou=user)(sunxmlKeyValue=subjectindex=identity:=all))(|(sunxmlKeyValue=hostindex=://)(sunxmlKeyValue=hostindex=://.com)(sunxmlKeyValue=hostindex=://.opendj.com)(sunxmlKeyValue=hostindex=://stagecompass.opendj.com))(|(sunxmlKeyValue=pathindex=/?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj?ddsel1=&ddsel2=&monsel1=&monsel2=&personid=&range=&search=&transferid=&yysel1=&yysel2=)(sunxmlKeyValue=pathindex=/jsp?ddsel1=14&ddsel2=14&monsel1=&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj/csr?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj/csr?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj/csr)(sunxmlKeyValue=pathindex=/jsp/opendj/csr/customer_corrections.jsp?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj/csr/customer_corrections.jsp?ddsel1=&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj/csr?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj/csr/customer_corrections.jsp)(sunxmlKeyValue=pathindex=/jsp/opendj?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj/csr/customer_corrections.jsp?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=)(sunxmlKeyValue=pathindex=/jsp?ddsel1=&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj/csr/customer_corrections.jsp?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=)(sunxmlKeyValue=pathindex=/jsp/opendj/csr/customer_corrections.jsp?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=&yysel2=2011)(sunxmlKeyValue=pathindex=/?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp)(sunxmlKeyValue=pathindex=/jsp/opendj)(sunxmlKeyValue=pathindex=/jsp/opendj?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=&yysel2=2011)(sunxmlKeyValue=pathindex=/)(sunxmlKeyValue=pathindex=/jsp/opendj/csr/customer_corrections.jsp?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp?ddsel1=14&ddsel2=&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj?ddsel1=14&ddsel2=&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj/csr?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj/csr/customer_corrections.jsp?ddsel1=&ddsel2=&monsel1=&monsel2=&personid=&range=&search=&transferid=&yysel1=&yysel2=)(sunxmlKeyValue=pathindex=/jsp/opendj/csr/customer_corrections.jsp?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj?ddsel1=14&ddsel2=14&monsel1=&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj/csr/customer_corrections.jsp?ddsel1=14&ddsel2=14&monsel1=&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj/csr?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj/csr?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj/csr?ddsel1=&ddsel2=&monsel1=&monsel2=&personid=&range=&search=&transferid=&yysel1=&yysel2=)(sunxmlKeyValue=pathindex=/jsp/opendj/csr/customer_corrections.jsp?ddsel1=14&ddsel2=&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=)(sunxmlKeyValue=pathindex=/?ddsel1=14&ddsel2=&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/?ddsel1=&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj/csr/customer_corrections.jsp?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj/csr?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=)(sunxmlKeyValue=pathindex=/jsp/opendj?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj/csr?ddsel1=14&ddsel2=&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/?ddsel1=&ddsel2=&monsel1=&monsel2=&personid=&range=&search=&transferid=&yysel1=&yysel2=)(sunxmlKeyValue=pathindex=/jsp/opendj/csr?ddsel1=&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/?ddsel1=14&ddsel2=14&monsel1=&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj/csr/customer_corrections.jsp?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp?ddsel1=&ddsel2=&monsel1=&monsel2=&personid=&range=&search=&transferid=&yysel1=&yysel2=)(sunxmlKeyValue=pathindex=/jsp?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj?ddsel1=&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=&transferid=2594137&yysel1=2011&yysel2=2011)(sunxmlKeyValue=pathindex=/jsp/opendj/csr?ddsel1=14&ddsel2=14&monsel1=dec&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=)(sunxmlKeyValue=pathindex=/jsp/opendj/csr?ddsel1=14&ddsel2=14&monsel1=&monsel2=dec&personid=919321&range=ninty&search=shownav&transferid=2594137&yysel1=2011&yysel2=201)))"


I've attached a OpenAM Netscape SDK based example which seems to reliably trigger the issue (Demo.java).