During testing of profiles feature I noticed that there is a problem with am-user-store profile settings.
The issue is that doing manual installation and steps to prepare DS as user data store works fine with AM, but replacing those manual steps with installation by DS am-user-store profile leads to errors in AM installation.

For DS common setup I followed the AM installation guide prepare-identity-repository and I followed the part with enabling auto load of schema by AM prepare-idrepo-dynamic-schema .

I tried two main scenarios of preparing the DS as user data store:

	DS is used by AM as only user store
	DS is used by AM as user store and also config store



I have attached a zip with scripts to setup each scenario with profile feature and manual steps.

The results of each run:
 common_deployment_user_datastore.sh

	Use manual steps to prepare DS (scenario 1.)
	I was able to finish AM configuration
	The validation is OK



profile_deployment_user_datastore.sh

	Use profile feature to prepare DS (scenario 1.)
	I was able to finish AM configuration
	The validation is not OK
	In this case, it is possible to finish the configuration, but when I tried to add a demo user via AM I hit an error with code 65 and on DS side I saw following entry in logs:




{"eventName":"DJ-LDAP","client":{"ip":"127.0.0.1","port":40666},"server":{"ip":"127.0.0.1","port":1389},"request":{"protocol":"LDAP","operation":"ADD","connId":64,"msgId":3,"dn":"uid=demo,ou=people,dc=example,dc=com"},"transactionId":"0427bc11-622f-4ef2-8ae0-fa3bdb54816f-1239","response":{"status":"FAILED","statusCode":"65","elapsedTime":4,"elapsedTimeUnits":"MILLISECONDS","detail":"Entry \"uid=demo,ou=people,dc=example,dc=com\" violates the schema because it contains an unrecognized object class \"pushDeviceProfilesContainer\""},"timestamp":"2018-09-14T06:13:30.878Z","_id":"0427bc11-622f-4ef2-8ae0-fa3bdb54816f-1241"}

common_deployment_config_user_datastore.sh

	Use manual steps to prepare DS (scenario 2.)
	I was able to finish AM configuration
	The validation is OK



profile_deployment_config_user_datastore.sh

	Use profile feature to prepare DS (scenario 2.)
	I wasn't able to finish AM configuration => I hit error during run of ssoconfigurator with configuration "configuserdatastore", when the tool tried to register dashboardService.
	The validation is not possible.



 NOTE: To run scripts in attached zip you need to download OpenAM-6.5.0-SNAPSHOT.zip and opendj-6.5.0-SNAPSHOT.zip and add them to archives folder after extracting provided zip.