Global information

Problem seen and sometimes reproducible by running four replicas system test (scenario2).
 Test imports 5 millions entries on dedicated backend ou=ssousers,dc=customer_one,dc=com then run dsreplication initialize-all on DS1 with error :

Details: com.forgerock.opendj.cli.ClientException: Error during the
initialization with contents from server tomme.internal.forgerock.com:4444.
Last log details: [23/Aug/2018:10:58:41 +0200] severity="NOTICE" msgCount=0
msgID=org.opends.messages.backend-413 message="Initialize Backend task
dsreplication-initialize-1 started execution". Task state: STOPPED_BY_ERROR.
Check the error logs of tomme.internal.forgerock.com:4444 for more
information.

Java exception 

[23/Aug/2018:11:00:43 +0200] category=BACKEND severity=ERROR msgID=99 msg=An error occurred while executing the task defined in entry ds-task-id=dsreplication-initialize-1,cn=Scheduled Tasks,cn=Tasks:  LdapException: Other: An error occurred while attempting to process the LDIF export:  Other: Other: When initializing remote server(s), connection to Replication Server with serverId=-1 is lost (LdapException.java:231 LdapException.java:144 LdapException.java:113 LdapException.java:71 LDAPReplicationDomain.java:2619 LDAPReplicationDomain.java:2546 ReplicationDomain.java:1528 LDAPReplicationDomain.java:1231 ReplicationDomain.java:1433 InitializeTargetTask.java:88 Task.java:778 TaskThread.java:137)


Topology

4 DJ instances

	DS1 (1389) and DS3 (1390) running on tomme
	DS2 (1389) and DS4 (1390) running on brie



https://wikis.forgerock.org/confluence/display/QA/Four+replicas#Fourreplicas-Topology
Scenario

	deploy and configure 4 DSRS instances
	import entries on DS1
	dsreplication initialize-all on DS1




$ dsreplication initialize-all -h tomme.internal.forgerock.com -p 4444 -b ou=ssousers,dc=customer_one,dc=com -I admin -w password  -X -n

-- rc --
returned 12, expected [0]
-- stdout --

Initializing base DN ou=ssousers,dc=customer_one,dc=com with the contents from
tomme.internal.forgerock.com:4444:
685 entries processed (0 % complete).
162317 entries processed (3 % complete).
327182 entries processed (6 % complete).
492727 entries processed (9 % complete).
677351 entries processed (13 % complete).
874478 entries processed (17 % complete).
1068803 entries processed (21 % complete).
1271681 entries processed (25 % complete).
1474654 entries processed (29 % complete).
1688021 entries processed (33 % complete).
1737182 entries processed (34 % complete).

-- stderr --

Error during the initialization with contents from server
tomme.internal.forgerock.com:4444. Last log details: [23/Aug/2018:10:58:41
+0200] severity="NOTICE" msgCount=0 msgID=org.opends.messages.backend-413
message="Initialize Backend task dsreplication-initialize-1 started
execution". Task state: STOPPED_BY_ERROR. Check the error logs of
tomme.internal.forgerock.com:4444 for more information.
See /tmp/opendj-replication-4751716261496068235.log for a detailed log of this
operation.
Details: com.forgerock.opendj.cli.ClientException: Error during the
initialization with contents from server tomme.internal.forgerock.com:4444.
Last log details: [23/Aug/2018:10:58:41 +0200] severity="NOTICE" msgCount=0
msgID=org.opends.messages.backend-413 message="Initialize Backend task
dsreplication-initialize-1 started execution". Task state: STOPPED_BY_ERROR.
Check the error logs of tomme.internal.forgerock.com:4444 for more
information.


	dsreplication status




dsreplication status -h tomme.internal.forgerock.com -p 4444 -b ou=ssousers,dc=customer_one,dc=com -I admin -w password -X -n
Suffix DN : Server : Entries : Replication enabled : DS ID : RS ID : RS Port (1) : M.C. (2) : A.O.M.C. (3) : Security (4)
-----------------------------------:-----------------------------------:---------:---------------------:-------:-------:-------------:----------:--------------:-------------
ou=ssousers,dc=customer_one,dc=com : brie.internal.forgerock.com:4444 : 1737407 : true : 5 : 5 : 8989 : 0 : : false
ou=ssousers,dc=customer_one,dc=com : brie.internal.forgerock.com:4445 : 1737407 : true : 7 : 7 : 8990 : 0 : : false
ou=ssousers,dc=customer_one,dc=com : tomme.internal.forgerock.com:4444 : 5000001 : true : 4 : 4 : 8989 : 0 : : false
ou=ssousers,dc=customer_one,dc=com : tomme.internal.forgerock.com:4445 : 1737407 : true : 6 : 6 : 8990 : 0 : : false

[1] The port used to communicate between the servers whose contents are being
replicated.
[2] The number of changes that are still missing on this server (and that have
been applied to at least one of the other servers).
[3] Age of oldest missing change: the date on which the oldest change that has
not arrived on this server was generated.
[4] Whether the replication communication through the replication port is
encrypted or not.

Result

http://kiri.internal.forgerock.com/qaresults/pyforge/opendj/6.5.0/manual/perf/four_replicas.scenario2/20180823-105050/summary.html
How to run the test

controller : zola
 agents : tomme / brie

zola $ scripts/stress/run/run_stress.py -c perf -s four_replicas.scenario2 --duration 2h --num_users 5000000 --monitoring_interval 180 --concurrency 10000 --dj_version 6.5.0-SNAPSHOT OpenDJ

config file example
Details
Errors logs

http://kiri.internal.forgerock.com/qaresults/pyforge/opendj/6.5.0/manual/perf/four_replicas.scenario2/20180823-105050/

Detailed log file displayed by replication command is empty 

$ cat /tmp/opendj-replication-4751716261496068235.log
${noformat}
h2. DS1 error log (tomme - server id 4) 


[...]
[23/Aug/2018:10:57:58 +0200] category=BACKEND severity=NOTICE msgID=519 msg=Processed 5000002 entries, imported 5000001, skipped 1, rejected 0 and migrated 0 in 149 seconds (average rate 33415.1/sec)
[23/Aug/2018:10:57:58 +0200] category=BACKEND severity=NOTICE msgID=526 msg=Import LDIF environment close took 0 seconds
[23/Aug/2018:10:57:58 +0200] category=BACKEND severity=NOTICE msgID=518 msg=Flushing data to disk
[23/Aug/2018:10:58:07 +0200] category=BACKEND severity=NOTICE msgID=513 msg=The database backend ssousers containing 5000001 entries has started
[23/Aug/2018:10:58:07 +0200] category=BACKEND severity=NOTICE msgID=414 msg=Import task 20180823105527923 finished execution in the state Completed successfully
[23/Aug/2018:10:58:14 +0200] category=SYNC severity=NOTICE msgID=204 msg=Replication server RS(4) started listening for new connections on address 0.0.0.0 port 8989
[23/Aug/2018:10:58:14 +0200] category=SYNC severity=NOTICE msgID=62 msg=Directory server DS(4) has connected to replication server RS(4) for domain "ou=ssousers,dc=customer_one,dc=com" at 172.16.204.193:8989 with generation ID 60321570
[23/Aug/2018:10:58:15 +0200] category=SYNC severity=NOTICE msgID=62 msg=Directory server DS(4) has connected to replication server RS(4) for domain "cn=admin data" at 172.16.204.193:8989 with generation ID 161656
[23/Aug/2018:10:58:15 +0200] category=SYNC severity=NOTICE msgID=62 msg=Directory server DS(4) has connected to replication server RS(4) for domain "cn=schema" at 172.16.204.193:8989 with generation ID 8408
[23/Aug/2018:10:58:15 +0200] category=SYNC severity=NOTICE msgID=143 msg=Starting total update: exporting 12 entries in domain "cn=admin data" from this directory server DS(4) to remote directory server DS(5)
[23/Aug/2018:10:58:16 +0200] category=SYNC severity=NOTICE msgID=78 msg=The generation ID for domain "cn=admin data" has been reset to 161656
[23/Aug/2018:10:58:16 +0200] category=SYNC severity=NOTICE msgID=144 msg=Finished total update: exported domain "cn=admin data" from this directory server DS(4) to remote directory server DS(5).
[23/Aug/2018:10:58:19 +0200] category=SYNC severity=NOTICE msgID=62 msg=Directory server DS(4) has connected to replication server RS(4) for domain "ou=ssousers,dc=customer_one,dc=com" at 172.16.204.193:8989 with generation ID 60321570
[23/Aug/2018:10:58:25 +0200] category=SYNC severity=NOTICE msgID=62 msg=Directory server DS(4) has connected to replication server RS(4) for domain "cn=admin data" at 172.16.204.193:8989 with generation ID 161656
[23/Aug/2018:10:58:25 +0200] category=SYNC severity=NOTICE msgID=62 msg=Directory server DS(4) has connected to replication server RS(4) for domain "cn=schema" at 172.16.204.193:8989 with generation ID 8408
[23/Aug/2018:10:58:26 +0200] category=SYNC severity=NOTICE msgID=143 msg=Starting total update: exporting 14 entries in domain "cn=admin data" from this directory server DS(4) to remote directory server DS(6)
[23/Aug/2018:10:58:27 +0200] category=SYNC severity=NOTICE msgID=78 msg=The generation ID for domain "cn=admin data" has been reset to 161656
[23/Aug/2018:10:58:27 +0200] category=SYNC severity=NOTICE msgID=144 msg=Finished total update: exported domain "cn=admin data" from this directory server DS(4) to remote directory server DS(6).
[23/Aug/2018:10:58:30 +0200] category=SYNC severity=NOTICE msgID=62 msg=Directory server DS(4) has connected to replication server RS(4) for domain "ou=ssousers,dc=customer_one,dc=com" at 172.16.204.193:8989 with generation ID 60321570
[23/Aug/2018:10:58:36 +0200] category=SYNC severity=WARNING msgID=146 msg=Directory server DS(6) at tomme.internal.forgerock.com/172.16.204.193:49118 presented generation ID 48 for domain "ou=ssousers,dc=customer_one,dc=com", but the generation ID of this replication server RS(4) is 60321570. This usually indicates that one or more directory servers in the replication topology have not been initialized with the same data, and re-initialization is required
[23/Aug/2018:10:58:36 +0200] category=SYNC severity=NOTICE msgID=62 msg=Directory server DS(4) has connected to replication server RS(4) for domain "cn=admin data" at 172.16.204.193:8989 with generation ID 161656
[23/Aug/2018:10:58:37 +0200] category=SYNC severity=NOTICE msgID=62 msg=Directory server DS(4) has connected to replication server RS(4) for domain "cn=schema" at 172.16.204.193:8989 with generation ID 8408
[23/Aug/2018:10:58:37 +0200] category=SYNC severity=NOTICE msgID=143 msg=Starting total update: exporting 16 entries in domain "cn=admin data" from this directory server DS(4) to remote directory server DS(7)
[23/Aug/2018:10:58:38 +0200] category=SYNC severity=NOTICE msgID=78 msg=The generation ID for domain "cn=admin data" has been reset to 161656
[23/Aug/2018:10:58:38 +0200] category=SYNC severity=NOTICE msgID=144 msg=Finished total update: exported domain "cn=admin data" from this directory server DS(4) to remote directory server DS(7).
[23/Aug/2018:10:58:41 +0200] category=BACKEND severity=NOTICE msgID=413 msg=Initialize Backend task dsreplication-initialize-1 started execution
[23/Aug/2018:10:58:41 +0200] category=SYNC severity=NOTICE msgID=209 msg=Starting total update: exporting 5000001 entries in domain "ou=ssousers,dc=customer_one,dc=com" from this directory server DS(4) to all remote directory servers
[23/Aug/2018:10:58:41 +0200] category=SYNC severity=NOTICE msgID=131 msg=Directory server DS(6) for domain "ou=ssousers,dc=customer_one,dc=com" has changed its status to Full update
[23/Aug/2018:10:58:51 +0200] category=BACKEND severity=NOTICE msgID=516 msg=Exported 150775 records and skipped 0 (recent rate 15076.0/sec)
[23/Aug/2018:10:59:01 +0200] category=BACKEND severity=NOTICE msgID=516 msg=Exported 318454 records and skipped 0 (recent rate 16769.6/sec)
[23/Aug/2018:10:59:11 +0200] category=BACKEND severity=NOTICE msgID=516 msg=Exported 485996 records and skipped 0 (recent rate 16754.2/sec)
[23/Aug/2018:10:59:21 +0200] category=BACKEND severity=NOTICE msgID=516 msg=Exported 667915 records and skipped 0 (recent rate 18191.9/sec)
[23/Aug/2018:10:59:31 +0200] category=BACKEND severity=NOTICE msgID=516 msg=Exported 860653 records and skipped 0 (recent rate 19273.8/sec)
[23/Aug/2018:10:59:41 +0200] category=BACKEND severity=NOTICE msgID=516 msg=Exported 1052108 records and skipped 0 (recent rate 19143.6/sec)
[23/Aug/2018:10:59:51 +0200] category=BACKEND severity=NOTICE msgID=516 msg=Exported 1256246 records and skipped 0 (recent rate 20415.8/sec)
[23/Aug/2018:11:00:01 +0200] category=BACKEND severity=NOTICE msgID=516 msg=Exported 1457513 records and skipped 0 (recent rate 20126.7/sec)
[23/Aug/2018:11:00:11 +0200] category=BACKEND severity=NOTICE msgID=516 msg=Exported 1671409 records and skipped 0 (recent rate 21389.6/sec)
[23/Aug/2018:11:00:14 +0200] category=SYNC severity=NOTICE msgID=213 msg=Directory Server DS(4) is disconnecting from replication server RS(4) at 172.16.204.193:8989 for domain "ou=ssousers,dc=customer_one,dc=com" in order to find another replication server in the topology and distribute load more equally
[23/Aug/2018:11:00:14 +0200] category=TOOLS severity=ERROR msgID=59 msg=An error occurred while attempting to process the LDIF export:  Other: Other: When initializing remote server(s), connection to Replication Server with serverId=-1 is lost
[23/Aug/2018:11:00:14 +0200] category=SYNC severity=NOTICE msgID=62 msg=Directory server DS(4) has connected to replication server RS(4) for domain "ou=ssousers,dc=customer_one,dc=com" at 172.16.204.193:8989 with generation ID 60321570
[23/Aug/2018:11:00:43 +0200] category=SYNC severity=NOTICE msgID=210 msg=Finished total update: exported domain "ou=ssousers,dc=customer_one,dc=com" from this directory server DS(4) to all remote directory servers. Other: An error occurred while attempting to process the LDIF export:  Other: Other: When initializing remote server(s), connection to Replication Server with serverId=-1 is lost
[23/Aug/2018:11:00:43 +0200] category=BACKEND severity=ERROR msgID=99 msg=An error occurred while executing the task defined in entry ds-task-id=dsreplication-initialize-1,cn=Scheduled Tasks,cn=Tasks:  LdapException: Other: An error occurred while attempting to process the LDIF export:  Other: Other: When initializing remote server(s), connection to Replication Server with serverId=-1 is lost (LdapException.java:231 LdapException.java:144 LdapException.java:113 LdapException.java:71 LDAPReplicationDomain.java:2619 LDAPReplicationDomain.java:2546 ReplicationDomain.java:1528 LDAPReplicationDomain.java:1231 ReplicationDomain.java:1433 InitializeTargetTask.java:88 Task.java:778 TaskThread.java:137)
[23/Aug/2018:11:00:43 +0200] category=BACKEND severity=NOTICE msgID=414 msg=Initialize Backend task dsreplication-initialize-1 finished execution in the state Stopped by error

h2. DS2 errors (brie - server id 5)


$ cat errors | grep ERROR
[23/Aug/2018:10:58:25 +0200] category=SYNC severity=ERROR msgID=178 msg=Directory server 5 was attempting to connect to replication server 5 but has disconnected in handshake phase. Error: SocketException(Broken pipe (Write failed))

h2. DS3 errors (tomme - server id 6)


$ cat errors | grep ERROR
[23/Aug/2018:10:58:36 +0200] category=SYNC severity=ERROR msgID=178 msg=Directory server 6 was attempting to connect to replication server 6 but has disconnected in handshake phase. Error: SocketException(Broken pipe (Write failed))

h2. DS4 errors (brie - server id 7)


$ cat errors | grep ERROR
${noformat}