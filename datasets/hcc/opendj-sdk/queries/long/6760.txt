Concurrent updates via Rest2Ldap against the same LDAP object may result in a Schema violation if the request specifies If-Match: *.

See the following failure which occurs when using OpenIDM with EmbeddedDJ via Rest2Ldap:




[261] Oct 29, 2019 12:35:21.963 PM org.forgerock.openidm.sync.RepoReconProgressStatePersistence updateInstance
SEVERE: Exception caught updating interim recon state instance for recon id 9ea5b9c2-28b8-49e6-8d44-3897d4ea5a8a. Exception: org.forgerock.json.resource.BadRequestException: Object Class Violation: Entry uid=acfdd27f-2ae1-4290-9426-43a68c339b39,ou=reconprogressstate,dc=openidm,dc=forgerock,dc=com cannot be modified because the resulting entry would have violated the server schema: Entry "uid=acfdd27f-2ae1-4290-9426-43a68c339b39,ou=reconprogressstate,dc=openidm,dc=forgerock,dc=com" violates the schema because it contains multiple values for the single-valued attribute "fr-idm-json"
org.forgerock.json.resource.BadRequestException: Object Class Violation: Entry uid=acfdd27f-2ae1-4290-9426-43a68c339b39,ou=reconprogressstate,dc=openidm,dc=forgerock,dc=com cannot be modified because the resulting entry would have violated the server schema: Entry "uid=acfdd27f-2ae1-4290-9426-43a68c339b39,ou=reconprogressstate,dc=openidm,dc=forgerock,dc=com" violates the schema because it contains multiple values for the single-valued attribute "fr-idm-json"

Upon review it appears that Rest2Ldap attempts to optimize Update operations by performing Delete/Add attribute value modifications for modified attributes instead of a Replace operation.  This optimization falls apart in the case of concurrent requests with If-Match: * and may result in attempts to add multiple values to a single valued attribute.

See the following code within Rest2Ldap: https://stash.forgerock.org/projects/OPENDJ/repos/opendj/browse/opendj-rest2ldap/src/main/java/org/forgerock/opendj/rest2ldap/AbstractLdapPropertyMapper.java#321