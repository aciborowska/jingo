Just shutdown a server (rev 6823) and it took ages: it looks like a shutdown handler (probably replication) was blocking the shutdown process. Got this ugly load of errors:

[14/Apr/2011:18:56:47 +0200] category=CORE severity=NOTICE msgID=458891 msg=The Directory Server has sent an alert notification generated by class org.opends.server.core.DirectoryServer (alert type org.opends.server.DirectoryServerShutdown, alert ID 458893):  The Directory Server has started the shutdown process.  The shutdown was initiated by an instance of class org.opends.server.core.DirectoryServerShutdownHook and the reason provided for the shutdown was The Directory Server shutdown hook detected that the JVM is shutting down.  This generally indicates that JVM received an external request to stop (e.g., through a kill signal)
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 2 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 0 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 1 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 8 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 3 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 6 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 7 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 11 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 10 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 9 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 4 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 12 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 5 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=SYNC severity=SEVERE_ERROR msgID=14942317 msg=An Exception was caught while replaying replication message : InterruptedException (AbstractQueuedSynchronizer.java:1961 AbstractQueuedSynchronizer.java:2038 LinkedBlockingQueue.java:424 ReplayThread.java:102)
[14/Apr/2011:18:56:47 +0200] category=SYNC severity=SEVERE_ERROR msgID=14942317 msg=An Exception was caught while replaying replication message : InterruptedException (AbstractQueuedSynchronizer.java:1961 AbstractQueuedSynchronizer.java:2038 LinkedBlockingQueue.java:424 ReplayThread.java:102)
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 15 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=SYNC severity=SEVERE_ERROR msgID=14942317 msg=An Exception was caught while replaying replication message : InterruptedException (AbstractQueuedSynchronizer.java:1961 AbstractQueuedSynchronizer.java:2038 LinkedBlockingQueue.java:424 ReplayThread.java:102)
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 13 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 22 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 23 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=SYNC severity=SEVERE_ERROR msgID=14942317 msg=An Exception was caught while replaying replication message : InterruptedException (AbstractQueuedSynchronizer.java:1961 AbstractQueuedSynchronizer.java:2038 LinkedBlockingQueue.java:424 ReplayThread.java:102)
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 20 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 19 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=SYNC severity=SEVERE_ERROR msgID=14942317 msg=An Exception was caught while replaying replication message : InterruptedException (AbstractQueuedSynchronizer.java:1961 AbstractQueuedSynchronizer.java:2038 LinkedBlockingQueue.java:424 ReplayThread.java:102)
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 21 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=SYNC severity=SEVERE_ERROR msgID=14942317 msg=An Exception was caught while replaying replication message : InterruptedException (AbstractQueuedSynchronizer.java:1961 AbstractQueuedSynchronizer.java:2038 LinkedBlockingQueue.java:424 ReplayThread.java:102)
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 18 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 17 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=SYNC severity=SEVERE_ERROR msgID=14942316 msg=Unable to send monitor data request for domain "dc=example,dc=com" to replication server RS(18292) due to the following error: Socket closed
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 14 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=CORE severity=SEVERE_WARNING msgID=131185 msg=Worker Thread 16 was interrupted while waiting for new work:  java.lang.InterruptedException.  This should not happen, but the thread will resume waiting for new work so there should be no adverse effects
[14/Apr/2011:18:56:47 +0200] category=SYNC severity=SEVERE_ERROR msgID=14942317 msg=An Exception was caught while replaying replication message : InterruptedException (AbstractQueuedSynchronizer.java:1961 AbstractQueuedSynchronizer.java:2038 LinkedBlockingQueue.java:424 ReplayThread.java:102)
[14/Apr/2011:18:56:47 +0200] category=SYNC severity=SEVERE_ERROR msgID=14942317 msg=An Exception was caught while replaying replication message : InterruptedException (AbstractQueuedSynchronizer.java:1961 AbstractQueuedSynchronizer.java:2038 LinkedBlockingQueue.java:424 ReplayThread.java:102)
[14/Apr/2011:18:56:47 +0200] category=SYNC severity=SEVERE_ERROR msgID=14942317 msg=An Exception was caught while replaying replication message : InterruptedException (AbstractQueuedSynchronizer.java:1961 AbstractQueuedSynchronizer.java:2038 LinkedBlockingQueue.java:424 ReplayThread.java:102)
[14/Apr/2011:18:56:47 +0200] category=SYNC severity=SEVERE_ERROR msgID=14942389 msg=The connection from this replication server RS(26589) to replication server RS(18292) at matts-laptop/127.0.1.1:8989 for domain "cn=schema" has failed
[14/Apr/2011:18:56:47 +0200] category=SYNC severity=SEVERE_ERROR msgID=14942317 msg=An Exception was caught while replaying replication message : InterruptedException (AbstractQueuedSynchronizer.java:1961 AbstractQueuedSynchronizer.java:2038 LinkedBlockingQueue.java:424 ReplayThread.java:102)
[14/Apr/2011:18:56:47 +0200] category=CORE severity=FATAL_ERROR msgID=327820 msg=An uncaught exception during processing for thread Replication server RS(26589) reading from Replication server RS(18292) for domain "dc=example,dc=com" at matts-laptop/127.0.1.1:8989 has caused it to terminate abnormally.  The stack trace for that exception is:  java.lang.IllegalMonitorStateException
  java.util.concurrent.locks.ReentrantLock$Sync.tryRelease(ReentrantLock.java:127)
  java.util.concurrent.locks.AbstractQueuedSynchronizer.release(AbstractQueuedSynchronizer.java:1239)
  java.util.concurrent.locks.ReentrantLock.unlock(ReentrantLock.java:431)
  org.opends.server.replication.server.ReplicationServerDomain.release(ReplicationServerDomain.java:2901)
  org.opends.server.replication.server.ReplicationServerDomain.stopServer(ReplicationServerDomain.java:1153)
  org.opends.server.replication.server.ServerHandler.doStop(ServerHandler.java:1393)
  org.opends.server.replication.server.ServerReader.run(ServerReader.java:353)

[14/Apr/2011:18:56:47 +0200] category=CORE severity=NOTICE msgID=458891 msg=The Directory Server has sent an alert notification generated by class org.opends.server.api.DirectoryThread (alert type org.opends.server.UncaughtException, alert ID 327820):  An uncaught exception during processing for thread Replication server RS(26589) reading from Replication server RS(18292) for domain "dc=example,dc=com" at matts-laptop/127.0.1.1:8989 has caused it to terminate abnormally.  The stack trace for that exception is:  java.lang.IllegalMonitorStateException
  java.util.concurrent.locks.ReentrantLock$Sync.tryRelease(ReentrantLock.java:127)
  java.util.concurrent.locks.AbstractQueuedSynchronizer.release(AbstractQueuedSynchronizer.java:1239)
  java.util.concurrent.locks.ReentrantLock.unlock(ReentrantLock.java:431)
  org.opends.server.replication.server.ReplicationServerDomain.release(ReplicationServerDomain.java:2901)
  org.opends.server.replication.server.ReplicationServerDomain.stopServer(ReplicationServerDomain.java:1153)
  org.opends.server.replication.server.ServerHandler.doStop(ServerHandler.java:1393)
  org.opends.server.replication.server.ServerReader.run(ServerReader.java:353)

[14/Apr/2011:18:56:47 +0200] category=BACKEND severity=NOTICE msgID=9896306 msg=The backend userRoot is now taken offline
[14/Apr/2011:18:56:47 +0200] category=CORE severity=NOTICE msgID=458955 msg=The Directory Server is now stopped

Ignore the interrupted exceptions for the worker and replay threads: these are threads which are waiting to be processed by the shutdown handler. It looks like the ServerReader is the culprit.

I may have introduced a regression as I have not seen this before.
