Today, the server allows to add a subordinate entry to an LdapSubEntry.

Checking the standards, I found the following:

RFC-3672
Subentries in the Lightweight Directory Access Protocol (LDAP)
 [RFC3377] SHALL behave in accordance with X.501 unless noted
 otherwise in this specification.
X.501-201210
 Section 12.6.1:
A subentry shall not have subordinates. 
So, we should not allow to create any entry below a subEntry.

Moreover, when replicating. the subordinate entry is renamed due to a missing parent.

Original Server:

dn: cn=test,cn=sub1,dc=example,dc=com


On Replica:

dn: entryuuid=ff6e3cc0-9dc7-4549-9d08-32b4117493d1+cn=test,dc=example,dc=com


Also on the replica, the error is logged:

[20/Sep/2018:19:55:13 +0200] category=CORE severity=NOTICE msgID=139 msg=The Directory Server has sent an alert notification generated by class org.opends.server.replication.plugin.LDAPReplicationDomain (alert type org.opends.server.replication.UnresolvedConflict, alert ID org.opends.messages.replication-69): An unresolved conflict was detected for DN cn=test,cn=sub1,dc=example,dc=com


And in the ldap-access.json file:

{"eventName":"DJ-LDAP","client":{"ip":"internal","port":-1},"server":{"ip":"internal","port":-1},"request":{"protocol":"internal","operation":"ADD","connId":-3,"msgId":100,"opType":"sync","dn":"cn=test,cn=sub1,dc=example,dc=com"},"transactionId":"0","response":{"status":"FAILED","statusCode":"32","elapsedTime":4,"elapsedTimeUnits":"MILLISECONDS"},"timestamp":"2018-09-20T17:55:13.320Z","_id":"8d0a6c32-8d70-4280-b627-c3c93b2b72c3-919"}


This was detected by Mark while testing the CTS proxy scenario, and installing DS instance with the AM:cts profile.

 

Simple scenario to reproduce
 Create 2 servers with default "dc=example,dc=com" backend.
 Configure and Initialise Replication.
 On server 1, add 2 entries as below:

$ ldapmodify -D cn=directory\ manager -w secret12 -p 1389
dn: cn=sub1,dc=example,dc=com
objectClass: ldapSubentry

# ADD operation successful for DN cn=sub1,dc=example,dc=com

dn: cn=test,cn=sub1,dc=example,dc=com
objectclass: person
sn: test

# ADD operation successful for DN cn=test,cn=sub1,dc=example,dc=com


If you search for (cn=test) on server 1:

$ ./bin/ldapsearch -h localhost -p 1389 -D "cn=directory manager" -w secret12  -b "dc=example,dc=com" "(cn=test)" dn
dn: cn=test,cn=sub1,dc=example,dc=com


And on the replica:

$ ./bin/ldapsearch -h localhost -p 2389 -D "cn=directory manager" -w secret12  -b "dc=example,dc=com" "(cn=test)" dn
dn: entryuuid=ff6e3cc0-9dc7-4549-9d08-32b4117493d1+cn=test,dc=example,dc=com

