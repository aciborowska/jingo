Found with 7.0.0-SNAPSHOT rev. 4eab37cbd4. 

When stopping DS which is just configured to replicate with already existed 2 replicated DSs and those are behind proxy. On all servers the confidentiality is enabled for indexes, db and replication. The stop-ds produce an NPE:

[25/Mar/2020:14:53:05 +0100] category=CORE severity=ERROR msgID=140 msg=An uncaught exception during processing for thread Directory Server Shutdown Hook has caused it to terminate abnormally. The stack trace for that exception is: NullPointerException (MultimasterReplication.java:900 MultimasterReplication.java:862 LDAPReplicationDomain.java:1534 ReplicationBroker.java:2007 ReplicationDomain.java:2085 LDAPReplicationDomain.java:2311 LDAPReplicationDomain.java:1713 MultimasterReplication.java:613 DirectoryServer.java:3141 DirectoryServer.java:3093 DirectoryServerShutdownHook.java:53)



To reproduce this error set DJ section properties in config/config.cfg and run the pyforge cmd:

[OpenDJ]
...
database_encrypted = True 
indexes_encrypted = True 
changelog_encrypted = True



run-pybot.py -v -s proxy_group.failoverWithStaticDiscovery -t Failover_Add_Primary_Server_Other_Stopped DJ



Test steps:

	Setup DJ1, DJ2 and DJ3
	Enable confidentiality (backend + indexes)
	Configure replication between DJ1 and DJ2
	Enable confidentiality for Multimaster Synchronization provider
	Initialize replication
	Setup PROXY and configure it with primary server DJ1 and secundary server DJ2
	Configure replication between DJ1 and DJ3
	Stop DJ3



The last step produce the NPE above.

 