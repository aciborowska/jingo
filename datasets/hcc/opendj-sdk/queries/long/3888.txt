When a server has its schema CSN (ds-sync-state) reset to empty (for example with issue OPENDJ-3767), the schema changes will be sync'd.
But the content of 99-user.ldif is replicated one schema element at a time, and not in the proper order.
The end result is highly inefficient and possibly leaves the schema in invalid intermediate states.

Here's the content of the 99-user.ldif file on Server 1

objectClass: subschema
cn: schema
attributeTypes: ( test-oid NAME 'test' DESC 'test' SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 USAGE userApplications X-SCHEMA-FILE '99-user.ldif' )
attributeTypes: ( test2-oid NAME 'test2' SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 USAGE userApplications X-SCHEMA-FILE '99-user.ldif' )
objectClasses: ( testOC-oid NAME 'testOC' DESC 'test' SUP top STRUCTURAL MUST test MAY test2 X-SCHEMA-FILE '99-user.ldif' )
ds-sync-state: 0000015adcce81280e1000000004
modifiersName: cn=Directory Manager,cn=Root DNs,cn=config
ds-sync-generation-id: 8408
modifyTimestamp: 20170317150617Z



When I enable audit log, I see 5 schema modifications one for ds-sync-generation-id, one per attribute, one per objectClass and one for the ds-sync-state.
Note that the modifications appear completely out of order in the audit log.


# 17/Mar/2017:16:32:03 +0100; conn=-3; op=44
dn: cn=schema
changetype: modify
replace: ds-sync-generation-id
ds-sync-generation-id: 8408
-

# 17/Mar/2017:16:32:04 +0100; conn=-2; op=55
dn: cn=schema
control: 1.3.6.1.4.1.36733.2.1.5.4 false: 0D0000015adcce81280e1000000004$224309e4-3ca9-37ac-8102-2acac3bd3b89
control: 2.16.840.1.113730.3.4.2 false
control: 1.2.840.113556.1.4.1413 false
changetype: modify
add: objectClasses
objectClasses: ( testOC-oid NAME 'testOC' DESC 'test' SUP top STRUCTURAL MUST test MAY test2 X-SCHEMA-FILE '99-user.ldif' )
-
replace: modifiersName
modifiersName: cn=Directory Manager,cn=Root DNs,cn=config
-
replace: modifyTimestamp
modifyTimestamp: 20170317150645Z
-

# 17/Mar/2017:16:32:04 +0100; conn=-2; op=54
dn: cn=schema
control: 1.3.6.1.4.1.36733.2.1.5.4 false: 0D0000015adcce14130e1000000003$224309e4-3ca9-37ac-8102-2acac3bd3b89
control: 2.16.840.1.113730.3.4.2 false
control: 1.2.840.113556.1.4.1413 false
changetype: modify
add: attributeTypes
attributeTypes: ( test2-oid NAME 'test2' SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 USAGE userApplications X-SCHEMA-FILE '99-user.ldif' )
-
replace: modifiersName
modifiersName: cn=Directory Manager,cn=Root DNs,cn=config
-
replace: modifyTimestamp
modifyTimestamp: 20170317150617Z
-

# 17/Mar/2017:16:32:04 +0100; conn=-2; op=53
dn: cn=schema
control: 1.3.6.1.4.1.36733.2.1.5.4 false: 0D0000015adcc0341b0e1000000001$224309e4-3ca9-37ac-8102-2acac3bd3b89
control: 2.16.840.1.113730.3.4.2 false
control: 1.2.840.113556.1.4.1413 false
changetype: modify
add: attributeTypes
attributeTypes: ( test-oid NAME 'test' DESC 'test' SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 USAGE userApplications X-SCHEMA-FILE '99-user.ldif' )
-
replace: modifiersName
modifiersName: cn=Directory Manager,cn=Root DNs,cn=config
-
replace: modifyTimestamp
modifyTimestamp: 20170317145108Z
-

# 17/Mar/2017:16:32:05 +0100; conn=-3; op=60
dn: cn=schema
changetype: modify
replace: ds-sync-state
ds-sync-state: 0000015adcce81280e1000000004
-

