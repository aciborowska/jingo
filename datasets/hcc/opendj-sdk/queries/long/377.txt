This was reported on OpenDJ mailing list by Grzegorz Kowaliczek

<quote>
Hi,

My first on this list so hello to everyone 

I have some issues to setup the OpenDJ to work with MS Active Directory for Kerberos authentication.

My lab setup is following:
OpenDJ 2.4.4 running on Solaris 10.
MS Active Directory as the KDC

Service account for the OpenDJ in AD is:
"svc_opendj" with attributes set to:
servicePrincipalName: ldap/f.q.d.n
userPrincipalName: svc_opendj@REALM 

[Issue] My issue is that such configuration works only if I change the userPrincipalName to ldap/f.q.d.n@REALM (it is default when the keytab is generated by native AD ktpass.exe, which is not true in my case).
If I stay with the svc_opendj@REALM value, I am getting "Client not found in Kerberos database". (Problem similar as described here: https://bugzilla.samba.org/show_bug.cgi?id=7739)

[Solution] I have found that if I modify the OpenDJ code so it adds flag isInitiator=false in generated login conf file, everything works fine (regardless the userPrincipalName value)

Here are the details:

â€“ Fail story-- 

	cat /var/tmp/login8294542574818652209conf
org.opends.server.extensions.GSSAPISASLMechanismHandler {
  com.sun.security.auth.module.Krb5LoginModule required storeKey=true useKeyTab=true doNotPrompt=true keyTab="/etc/krb5/krb5.keytab" principal="ldap/f.q.d.n";
};



Search request returns: 

	ldapsearch -h f.q.d.n -p  389 -o mech=GSSAPI -o authzid="opendj_user@REALM" -b "somebase" "objectclass=*"
ldap_sasl_interactive_bind_s: Invalid credentials
ldap_sasl_interactive_bind_s: additional info: An error occurred while attempting to create the JAAS login context for GSSAPI authentication:  LoginException(Client not found in Kerberos database (6))



-Success story-

	cat /var/tmp/login4511239619980925351conf
org.opends.server.extensions.GSSAPISASLMechanismHandlerExt {
  com.sun.security.auth.module.Krb5LoginModule required storeKey=true useKeyTab=true doNotPrompt=true keyTab="/etc/krb5/krb5.keytab" principal="ldap/f.q.d.n" isInitiator=false debug=true;
};
The same search request returns valid result.



I also dug little deeper in the other open source tools that I successfuly configured to work with Kerberos and found that all of them have the isInitiator set to false:

SPNEGO: http://spnego.sourceforge.net/pre_flight.html (login.conf configuration: http://spnego.sourceforge.net/login.conf)

Spring Kerberos extension: http://static.springsource.org/spring-security/site/extensions/krb/index.html (LoginConfig private class implementation in SunJaasKerberosTicketValidator class)


Please consider adding the isInitiator flag as the configuration option for GSSAPI Handler (if you don't want to set it always to false).

Thanks,
Greg
</quote>