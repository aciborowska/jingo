There are several bugs by the looks of things using Tomcat 6:


"OpenDJ LDAP SDK Grizzly worker thread(4)" daemon prio=10 tid=0x00007f7c5c24b000 nid=0x7743 waiting on condition [0x00007f7c6c36e000]
   java.lang.Thread.State: WAITING (parking)
	at sun.misc.Unsafe.park(Native Method)
	- parking to wait for  <0x00000000eda13b50> (a java.util.concurrent.CountDownLatch$Sync)
	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:834)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(AbstractQueuedSynchronizer.java:994)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1303)
	at java.util.concurrent.CountDownLatch.await(CountDownLatch.java:236)
	at org.forgerock.json.resource.servlet.Servlet2CompletionHandlerFactory$Servlet2Impl.awaitIfNeeded(Servlet2CompletionHandlerFactory.java:52)
	at org.forgerock.json.resource.servlet.HttpServletAdapter.doRequest(HttpServletAdapter.java:520)
	at org.forgerock.json.resource.servlet.HttpServletAdapter.doGet(HttpServletAdapter.java:370)
	at org.forgerock.json.resource.servlet.HttpServlet.doGet(HttpServlet.java:177)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:617)
	at org.forgerock.json.resource.servlet.HttpServlet.service(HttpServlet.java:356)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:717)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)
	at org.forgerock.opendj.rest2ldap.servlet.Rest2LDAPAuthnFilter$3$1.handleResult(Rest2LDAPAuthnFilter.java:457)
	at org.forgerock.opendj.rest2ldap.servlet.Rest2LDAPAuthnFilter$3$1.handleResult(Rest2LDAPAuthnFilter.java:437)
	at org.forgerock.opendj.ldap.HeartBeatConnectionFactory$ConnectionImpl$3.handleResult(HeartBeatConnectionFactory.java:682)
	at com.forgerock.opendj.util.AsynchronousFutureResult$Sync.innerSetResult(AsynchronousFutureResult.java:182)
	at com.forgerock.opendj.util.AsynchronousFutureResult.handleResult(AsynchronousFutureResult.java:309)
	at com.forgerock.opendj.ldap.AbstractLDAPFutureResultImpl.setResultOrError(AbstractLDAPFutureResultImpl.java:127)
	at com.forgerock.opendj.ldap.LDAPClientFilter$1.bindResult(LDAPClientFilter.java:171)
	at com.forgerock.opendj.ldap.LDAPClientFilter$1.bindResult(LDAPClientFilter.java:79)
	at com.forgerock.opendj.ldap.LDAPReader.decodeBindResult(LDAPReader.java:408)
	at com.forgerock.opendj.ldap.LDAPReader.decodeProtocolOp(LDAPReader.java:1125)
	at com.forgerock.opendj.ldap.LDAPReader.decode(LDAPReader.java:166)
	at com.forgerock.opendj.ldap.LDAPClientFilter.handleRead(LDAPClientFilter.java:499)
	at org.glassfish.grizzly.filterchain.ExecutorResolver$9.execute(ExecutorResolver.java:119)
	at org.glassfish.grizzly.filterchain.DefaultFilterChain.executeFilter(DefaultFilterChain.java:265)
	at org.glassfish.grizzly.filterchain.DefaultFilterChain.executeChainPart(DefaultFilterChain.java:200)
	at org.glassfish.grizzly.filterchain.DefaultFilterChain.execute(DefaultFilterChain.java:134)
	at org.glassfish.grizzly.filterchain.DefaultFilterChain.process(DefaultFilterChain.java:112)
	at org.glassfish.grizzly.ProcessorExecutor.execute(ProcessorExecutor.java:78)
	at org.glassfish.grizzly.nio.transport.TCPNIOTransport.fireIOEvent(TCPNIOTransport.java:770)
	at org.glassfish.grizzly.strategies.AbstractIOStrategy.fireIOEvent(AbstractIOStrategy.java:112)
	at org.glassfish.grizzly.strategies.WorkerThreadIOStrategy.run0(WorkerThreadIOStrategy.java:115)
	at org.glassfish.grizzly.strategies.WorkerThreadIOStrategy.access$100(WorkerThreadIOStrategy.java:55)
	at org.glassfish.grizzly.strategies.WorkerThreadIOStrategy$WorkerThreadRunnable.run(WorkerThreadIOStrategy.java:135)
	at org.glassfish.grizzly.threadpool.AbstractThreadPool$Worker.doWork(AbstractThreadPool.java:567)
	at org.glassfish.grizzly.threadpool.AbstractThreadPool$Worker.run(AbstractThreadPool.java:547)
	at java.lang.Thread.run(Thread.java:722)

...

"http-8080-1" daemon prio=10 tid=0x00007f7c50001800 nid=0x76fc waiting on condition [0x00007f7c6cab8000]
   java.lang.Thread.State: WAITING (parking)
	at sun.misc.Unsafe.park(Native Method)
	- parking to wait for  <0x00000000efb34048> (a java.util.concurrent.CountDownLatch$Sync)
	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:834)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(AbstractQueuedSynchronizer.java:994)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1303)
	at java.util.concurrent.CountDownLatch.await(CountDownLatch.java:236)
	at org.forgerock.json.resource.servlet.Servlet2CompletionHandlerFactory$Servlet2Impl.awaitIfNeeded(Servlet2CompletionHandlerFactory.java:52)
	at org.forgerock.opendj.rest2ldap.servlet.Rest2LDAPAuthnFilter.doFilter(Rest2LDAPAuthnFilter.java:295)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)
	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)
	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)
	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)
	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)
	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)
	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:293)
	at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:859)
	at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:602)
	at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:489)
	at java.lang.Thread.run(Thread.java:722)




The recent refactoring of the CompletionHandler abstraction in order to be reused in the authn filter is at fault. In particular, the onComplete() is overloaded: it should not complete the async context when used in a filter.

In addition the authn filter is invoking chain.doFilter on completion in the bind result handler when it should only be invoked by the filter thread on 2.5.