OPENIDM-13943 occurs intermittently, only with embedded DS, and only when IDM shutdown is triggered via the shutdown.sh script, which sends a kill signal. The issue can be reproduced on every invocation of the shutdown.sh script by shortening the cluster service's heartbeat to 1 ms, down from the default of 5 seconds. It is believed that the error occurs because the DirectoryServer's shutdown hook shuts down the DirectoryServer instance, at the same time as IDM's OSGi shutdown sequence is initiated, thereby opening a window in which IDM will dispatch a DirectoryServer request after the DirectoryServer has shutdown. Shortening the cluster service's heartbeat to 1ms makes this happen on every shutdown.

See this comment for detailed analysis.

Stacktrace:

Exception in thread "pool-11-thread-1" java.lang.NullPointerException
	at org.opends.server.core.ModifyOperation.createPasswordPolicyState(ModifyOperation.java:665)
	at org.opends.server.core.ModifyOperation.mustChangePassword0(ModifyOperation.java:657)
	at org.opends.server.core.ModifyOperation.mustChangePassword(ModifyOperation.java:653)
	at org.opends.server.core.ModifyOperation.processModify(ModifyOperation.java:522)
	at org.opends.server.core.ModifyOperation.processLocalModify(ModifyOperation.java:438)
	at org.opends.server.core.ModifyOperation.run(ModifyOperation.java:368)
	at org.opends.server.protocols.internal.AbstractInternalClientConnection.handleRequest(AbstractInternalClientConnection.java:329)
	at org.opends.server.protocols.internal.AbstractInternalClientConnection.lambda$handle$0(AbstractInternalClientConnection.java:312)
	at io.reactivex.internal.operators.flowable.FlowableCreate.subscribeActual(FlowableCreate.java:71)
	at io.reactivex.Flowable.subscribe(Flowable.java:14936)
	at io.reactivex.Flowable.subscribe(Flowable.java:14883)
	at io.reactivex.internal.operators.flowable.FlowableLift.subscribeActual(FlowableLift.java:49)
	at io.reactivex.Flowable.subscribe(Flowable.java:14936)
	at io.reactivex.internal.operators.flowable.FlowableDoOnEach.subscribeActual(FlowableDoOnEach.java:50)
	at io.reactivex.Flowable.subscribe(Flowable.java:14936)
	at io.reactivex.internal.operators.flowable.FlowableDoFinally.subscribeActual(FlowableDoFinally.java:46)
	at io.reactivex.Flowable.subscribe(Flowable.java:14936)
	at io.reactivex.internal.operators.flowable.FlowableMap.subscribeActual(FlowableMap.java:37)
	at io.reactivex.Flowable.subscribe(Flowable.java:14936)
	at io.reactivex.internal.operators.flowable.FlowableDoOnEach.subscribeActual(FlowableDoOnEach.java:50)
	at io.reactivex.Flowable.subscribe(Flowable.java:14936)
	at io.reactivex.internal.operators.flowable.FlowableOnErrorNext.subscribeActual(FlowableOnErrorNext.java:40)
	at io.reactivex.Flowable.subscribe(Flowable.java:14936)
	at io.reactivex.Flowable.subscribe(Flowable.java:14883)
	at io.reactivex.internal.operators.flowable.FlowableScalarXMap.tryScalarXMapSubscribe(FlowableScalarXMap.java:93)
	at io.reactivex.internal.operators.flowable.FlowableFlatMap.subscribeActual(FlowableFlatMap.java:50)
	at io.reactivex.Flowable.subscribe(Flowable.java:14936)
	at io.reactivex.Flowable.subscribe(Flowable.java:14883)
	at io.reactivex.internal.operators.flowable.FlowableScalarXMap.tryScalarXMapSubscribe(FlowableScalarXMap.java:93)
	at io.reactivex.internal.operators.flowable.FlowableFlatMap.subscribeActual(FlowableFlatMap.java:50)
	at io.reactivex.Flowable.subscribe(Flowable.java:14936)
	at io.reactivex.Flowable.subscribe(Flowable.java:14883)
	at io.reactivex.internal.operators.flowable.FlowableDefer.subscribeActual(FlowableDefer.java:42)
	at io.reactivex.Flowable.subscribe(Flowable.java:14936)
	at io.reactivex.internal.operators.flowable.FlowableFilter.subscribeActual(FlowableFilter.java:37)
	at io.reactivex.Flowable.subscribe(Flowable.java:14936)
	at io.reactivex.internal.operators.flowable.FlowableMap.subscribeActual(FlowableMap.java:37)
	at io.reactivex.Flowable.subscribe(Flowable.java:14936)
	at io.reactivex.Flowable.subscribe(Flowable.java:14883)
	at io.reactivex.internal.operators.flowable.FlowableLastSingle.subscribeActual(FlowableLastSingle.java:45)
	at io.reactivex.Single.subscribe(Single.java:3666)
	at io.reactivex.internal.operators.single.SingleFlatMap.subscribeActual(SingleFlatMap.java:36)
	at io.reactivex.Single.subscribe(Single.java:3666)
	at io.reactivex.internal.operators.single.SingleFlatMap$SingleFlatMapCallback.onSuccess(SingleFlatMap.java:84)
	at io.reactivex.internal.operators.flowable.FlowableReduceSeedSingle$ReduceSeedObserver.onComplete(FlowableReduceSeedSingle.java:110)
	at io.reactivex.internal.operators.flowable.FlowableConcatMapEager$ConcatMapEagerDelayErrorSubscriber.drain(FlowableConcatMapEager.java:264)
	at io.reactivex.internal.operators.flowable.FlowableConcatMapEager$ConcatMapEagerDelayErrorSubscriber.onComplete(FlowableConcatMapEager.java:156)
	at io.reactivex.internal.operators.flowable.FlowableFromIterable$IteratorSubscription.slowPath(FlowableFromIterable.java:255)
	at io.reactivex.internal.operators.flowable.FlowableFromIterable$BaseRangeSubscription.request(FlowableFromIterable.java:124)
	at io.reactivex.internal.operators.flowable.FlowableConcatMapEager$ConcatMapEagerDelayErrorSubscriber.onSubscribe(FlowableConcatMapEager.java:109)
	at io.reactivex.internal.operators.flowable.FlowableFromIterable.subscribe(FlowableFromIterable.java:69)
	at io.reactivex.internal.operators.flowable.FlowableFromIterable.subscribeActual(FlowableFromIterable.java:47)
	at io.reactivex.Flowable.subscribe(Flowable.java:14936)
	at io.reactivex.internal.operators.flowable.FlowableConcatMapEager.subscribeActual(FlowableConcatMapEager.java:55)
	at io.reactivex.Flowable.subscribe(Flowable.java:14936)
	at io.reactivex.Flowable.subscribe(Flowable.java:14883)
	at io.reactivex.internal.operators.flowable.FlowableReduceSeedSingle.subscribeActual(FlowableReduceSeedSingle.java:49)
	at io.reactivex.Single.subscribe(Single.java:3666)
	at io.reactivex.internal.operators.single.SingleFlatMap.subscribeActual(SingleFlatMap.java:36)
	at io.reactivex.Single.subscribe(Single.java:3666)
	at io.reactivex.internal.operators.single.SingleFlatMap$SingleFlatMapCallback.onSuccess(SingleFlatMap.java:84)
	at io.reactivex.internal.operators.maybe.MaybeSwitchIfEmptySingle$SwitchIfEmptyMaybeObserver.onSuccess(MaybeSwitchIfEmptySingle.java:82)
	at io.reactivex.internal.operators.flowable.FlowableReduceMaybe$ReduceSubscriber.onComplete(FlowableReduceMaybe.java:136)
	at io.reactivex.internal.subscribers.BasicFuseableSubscriber.onComplete(BasicFuseableSubscriber.java:120)
	at io.reactivex.internal.subscribers.BasicFuseableSubscriber.onComplete(BasicFuseableSubscriber.java:120)
	at io.reactivex.processors.ReplayProcessor$UnboundedReplayBuffer.replay(ReplayProcessor.java:735)
	at io.reactivex.processors.ReplayProcessor$ReplaySubscription.request(ReplayProcessor.java:613)
	at io.reactivex.internal.subscribers.BasicFuseableSubscriber.request(BasicFuseableSubscriber.java:153)
	at io.reactivex.internal.subscribers.BasicFuseableSubscriber.request(BasicFuseableSubscriber.java:153)
	at io.reactivex.internal.operators.flowable.FlowableReduceMaybe$ReduceSubscriber.onSubscribe(FlowableReduceMaybe.java:94)
	at io.reactivex.internal.subscribers.BasicFuseableSubscriber.onSubscribe(BasicFuseableSubscriber.java:67)
	at io.reactivex.internal.subscribers.BasicFuseableSubscriber.onSubscribe(BasicFuseableSubscriber.java:67)
	at io.reactivex.processors.ReplayProcessor.subscribeActual(ReplayProcessor.java:334)
	at io.reactivex.Flowable.subscribe(Flowable.java:14936)
	at io.reactivex.internal.operators.flowable.FlowableFilter.subscribeActual(FlowableFilter.java:37)
	at io.reactivex.Flowable.subscribe(Flowable.java:14936)
	at io.reactivex.internal.operators.flowable.FlowableMap.subscribeActual(FlowableMap.java:37)
	at io.reactivex.Flowable.subscribe(Flowable.java:14936)
	at io.reactivex.internal.operators.flowable.FlowableReduceMaybe.subscribeActual(FlowableReduceMaybe.java:57)
	at io.reactivex.Maybe.subscribe(Maybe.java:4290)
	at io.reactivex.internal.operators.maybe.MaybeSwitchIfEmptySingle.subscribeActual(MaybeSwitchIfEmptySingle.java:45)
	at io.reactivex.Single.subscribe(Single.java:3666)
	at io.reactivex.internal.operators.single.SingleFlatMap.subscribeActual(SingleFlatMap.java:36)
	at io.reactivex.Single.subscribe(Single.java:3666)
	at io.reactivex.internal.operators.single.SingleObserveOn.subscribeActual(SingleObserveOn.java:35)
	at io.reactivex.Single.subscribe(Single.java:3666)
	at io.reactivex.Single.subscribe(Single.java:3652)
	at org.forgerock.opendj.ldap.Utils.toPromise(Utils.java:228)
	at org.forgerock.opendj.rest2ldap.RxRequestHandlerAdapter$ToRequestHandlerAdapter.promise(RxRequestHandlerAdapter.java:272)
	at io.reactivex.Single.to(Single.java:3945)
	at org.forgerock.opendj.rest2ldap.RxRequestHandlerAdapter$ToRequestHandlerAdapter.handleUpdate(RxRequestHandlerAdapter.java:241)
	at org.forgerock.json.resource.Router.handleUpdate(Router.java:345)
	at org.forgerock.opendj.rest2ldap.RxRequestHandlerAdapter$ToRxRequestHandlerAdapter.lambda$handleUpdate$8(RxRequestHandlerAdapter.java:146)
	at org.forgerock.opendj.ldap.Utils.lambda$toSingle$7(Utils.java:254)
	at io.reactivex.internal.operators.single.SingleCreate.subscribeActual(SingleCreate.java:39)
	at io.reactivex.Single.subscribe(Single.java:3666)
	at io.reactivex.internal.operators.single.SingleFlatMap$SingleFlatMapCallback.onSuccess(SingleFlatMap.java:84)
	at io.reactivex.internal.operators.single.SingleJust.subscribeActual(SingleJust.java:30)
	at io.reactivex.Single.subscribe(Single.java:3666)
	at io.reactivex.internal.operators.single.SingleFlatMap.subscribeActual(SingleFlatMap.java:36)
	at io.reactivex.Single.subscribe(Single.java:3666)
	at io.reactivex.internal.operators.single.SingleObserveOn.subscribeActual(SingleObserveOn.java:35)
	at io.reactivex.Single.subscribe(Single.java:3666)
	at io.reactivex.Single.subscribe(Single.java:3652)
	at org.forgerock.opendj.ldap.Utils.toPromise(Utils.java:228)
	at org.forgerock.opendj.rest2ldap.RxRequestHandlerAdapter$ToRequestHandlerAdapter.promise(RxRequestHandlerAdapter.java:272)
	at io.reactivex.Single.to(Single.java:3945)
	at org.forgerock.opendj.rest2ldap.RxRequestHandlerAdapter$ToRequestHandlerAdapter.handleUpdate(RxRequestHandlerAdapter.java:241)
	at org.forgerock.json.resource.Router.handleUpdate(Router.java:345)
	at org.forgerock.opendj.rest2ldap.RxRequestHandlerAdapter$ToRxRequestHandlerAdapter.lambda$handleUpdate$8(RxRequestHandlerAdapter.java:146)
	at org.forgerock.opendj.ldap.Utils.lambda$toSingle$7(Utils.java:254)
	at io.reactivex.internal.operators.single.SingleCreate.subscribeActual(SingleCreate.java:39)
	at io.reactivex.Single.subscribe(Single.java:3666)
	at io.reactivex.internal.operators.single.SingleFlatMap$SingleFlatMapCallback.onSuccess(SingleFlatMap.java:84)
	at io.reactivex.internal.operators.single.SingleJust.subscribeActual(SingleJust.java:30)
	at io.reactivex.Single.subscribe(Single.java:3666)
	at io.reactivex.internal.operators.single.SingleFlatMap.subscribeActual(SingleFlatMap.java:36)
	at io.reactivex.Single.subscribe(Single.java:3666)
	at io.reactivex.internal.operators.single.SingleObserveOn.subscribeActual(SingleObserveOn.java:35)
	at io.reactivex.Single.subscribe(Single.java:3666)
	at io.reactivex.Single.subscribe(Single.java:3652)
	at org.forgerock.opendj.ldap.Utils.toPromise(Utils.java:228)
	at org.forgerock.opendj.rest2ldap.RxRequestHandlerAdapter$ToRequestHandlerAdapter.promise(RxRequestHandlerAdapter.java:272)
	at io.reactivex.Single.to(Single.java:3945)
	at org.forgerock.opendj.rest2ldap.RxRequestHandlerAdapter$ToRequestHandlerAdapter.handleUpdate(RxRequestHandlerAdapter.java:241)
	at org.forgerock.json.resource.Router.handleUpdate(Router.java:345)
	at org.forgerock.opendj.rest2ldap.DescribableRequestHandler.handleUpdate(DescribableRequestHandler.java:84)
	at org.forgerock.openidm.repo.opendj.impl.RetryRequestHandlerProxy.lambda$handleUpdate$2(RetryRequestHandlerProxy.java:99)
	at org.forgerock.openidm.repo.opendj.impl.RetryRequestHandlerProxy.afterRetrying(RetryRequestHandlerProxy.java:67)
	at org.forgerock.openidm.repo.opendj.impl.RetryRequestHandlerProxy.handleUpdate(RetryRequestHandlerProxy.java:99)
	at org.forgerock.openidm.repo.opendj.impl.ExplicitDJTypeHandler.handleUpdate(ExplicitDJTypeHandler.java:151)
	at org.forgerock.openidm.repo.opendj.impl.GenericDJTypeHandler.lambda$handleUpdate$4(GenericDJTypeHandler.java:198)
	at org.forgerock.util.promise.Promises$CompletedPromise.thenAsync(Promises.java:263)
	at org.forgerock.util.promise.Promises$CompletedPromise.thenAsync(Promises.java:227)
	at org.forgerock.openidm.repo.opendj.impl.GenericDJTypeHandler.handleUpdate(GenericDJTypeHandler.java:198)
	at org.forgerock.json.resource.FilterChain$Cursor.handleUpdate(FilterChain.java:114)
	at org.forgerock.openidm.repo.opendj.impl.PopulateMissingEdgesFilter.filterUpdate(PopulateMissingEdgesFilter.java:141)
	at org.forgerock.json.resource.FilterChain$Cursor.handleUpdate(FilterChain.java:112)
	at org.forgerock.openidm.repo.opendj.impl.OpenDJConnectionContextFilter.lambda$filterUpdate$7(OpenDJConnectionContextFilter.java:132)
	at org.forgerock.openidm.repo.opendj.impl.OpenDJConnectionContextFilter.lambda$withConnectionContext$0(OpenDJConnectionContextFilter.java:81)
	at org.forgerock.openidm.metrics.MetricsCollector.time(MetricsCollector.java:112)
	at org.forgerock.openidm.repo.opendj.impl.OpenDJConnectionContextFilter.withConnectionContext(OpenDJConnectionContextFilter.java:77)
	at org.forgerock.openidm.repo.opendj.impl.OpenDJConnectionContextFilter.filterUpdate(OpenDJConnectionContextFilter.java:132)
	at org.forgerock.json.resource.FilterChain$Cursor.handleUpdate(FilterChain.java:112)
	at org.forgerock.json.resource.FilterChain.handleUpdate(FilterChain.java:261)
	at org.forgerock.openidm.repo.opendj.impl.OpenDJRepoService.lambda$handleUpdate$6(OpenDJRepoService.java:180)
	at org.forgerock.openidm.metrics.MetricsCollector.time(MetricsCollector.java:112)
	at org.forgerock.openidm.repo.opendj.impl.OpenDJRepoService.handleUpdate(OpenDJRepoService.java:176)
	at org.forgerock.openidm.repo.opendj.impl.OpenDJRepoService.update(OpenDJRepoService.java:264)
	at org.forgerock.openidm.cluster.ClusterManager.updateInstanceState(ClusterManager.java:485)
	at org.forgerock.openidm.cluster.ClusterManager.checkIn(ClusterManager.java:606)
	at org.forgerock.openidm.cluster.ClusterManager$ClusterManagerThread$1.run(ClusterManager.java:874)
	at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)
	at java.base/java.util.concurrent.FutureTask.runAndReset(FutureTask.java:305)
	at java.base/java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:305)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
	at java.base/java.lang.Thread.run(Thread.java:834)
