There are currently several dependencies of opendj-server-legacy that are not OSGi bundles. forgerock-persistit-core, je, and jcip-annotations. I have attempted to get around this by simply embedding the dependencies. This works fine for persistit and jcip-annotations but when embedding JE the bundle plugin generates a manifest claiming JE depends on org.apache.tools.ant and org.apache.tools.ant.tools.

Patch for Persistit and JCIP-Annotatinos:

diff --git a/opendj-server-legacy/pom.xml b/opendj-server-legacy/pom.xml
index b1ee7e4..ed57a86 100644
--- a/opendj-server-legacy/pom.xml
+++ b/opendj-server-legacy/pom.xml
@@ -666,9 +666,14 @@
                 <Export-Package>org.forgerock.opendj.server.embedded</Export-Package>
                 <!-- Import je changelog since it is not shipped in the main jar -->
                 <Import-Package>
-                  org.opends.server.replication.server.changelog.je,
+                  com.sleepycat.je*;resolution:=optional,
                   ${opendj.osgi.import}
                 </Import-Package>
+                <Embed-Dependency>
+                  forgerock-persistit-core,
+                  <!--je,-->
+                  jcip-annotations
+                </Embed-Dependency>
               </instructions>
             </configuration>
           </execution>



This patch is fine for pdb-backed installs but if we wish to support JE (for account-change-handler) we will need to resolve the issue around JE. It's possible this import is simply an issue in the embedding of the bundle plugin. We should first try to create a separate bundle for JE and see if it contains the same manifest.

If you uncomment the je line in the above patch you can view the ant imports in the manifest in opendj-server-legacy/target/classes/META-INF/MANIFEST.MF


Import-Package: ...,org.apache.tools.ant,
 org.apache.tools.ant.types,...



If we manually edit the manifest and remove these two ant imports the bundle starts normally.