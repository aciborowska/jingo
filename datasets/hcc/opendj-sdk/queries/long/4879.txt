A number of IDM performance tests are failing due to indefinite blocking in LdapConnectionFactory.getConnection(). This can be reproduced via


python -u run-pybot.py -c stress -i gatling -s *CrudManUsersWithRoles -t IDM_Managed_User_With_Roles_Create_Put  OpenIDM



In the thread dump we can see


"qtp696719729-835" #835 prio=5 os_prio=31 tid=0x00007fdaa49a4000 nid=0x14d03 in Object.wait() [0x000070000d2be000]
   java.lang.Thread.State: WAITING (on object monitor)
        at java.lang.Object.wait(Native Method)
        at java.lang.Object.wait(Object.java:502)
        at org.forgerock.util.promise.PromiseImpl.await(PromiseImpl.java:582)
        - locked <0x00000007adf6c948> (a org.forgerock.util.promise.PromiseImpl)
        at org.forgerock.util.promise.PromiseImpl.getOrThrow(PromiseImpl.java:136)
        at org.forgerock.opendj.ldap.LdapConnectionFactory.getConnection(LdapConnectionFactory.java:298)
        at org.forgerock.openidm.repo.opendj.impl.OpenDJConnectionContextFilter.withConnectionContext(OpenDJConnectionContextFilter.java:78)
        at org.forgerock.openidm.repo.opendj.impl.OpenDJConnectionContextFilter.filterQuery(OpenDJConnectionContextFilter.java:123)



This blocking did not occur in 6.0.0-M1 and previous. We did see a heartbeat timeout in previous versions but never a full lock of the connection factory as we are seeing currently.