The following password policy is configured:


dn: cn=Company,cn=Password Policies,cn=config
cn: Company
ds-cfg-allow-expired-password-changes: true
ds-cfg-default-password-storage-scheme: cn=Salted SHA-256,cn=Password Storage Schemes,cn=config
ds-cfg-default-password-storage-scheme: cn=Salted SHA-512,cn=Password Storage Schemes,cn=config
ds-cfg-grace-login-count: 3
ds-cfg-idle-lockout-interval: 15552000 s
ds-cfg-java-class: org.opends.server.core.PasswordPolicyFactory
ds-cfg-lockout-duration: 300 s
ds-cfg-lockout-failure-count: 3
ds-cfg-lockout-failure-expiration-interval: 300 s
ds-cfg-max-password-age: 5184000 s
ds-cfg-max-password-reset-age: 5184000 s
ds-cfg-min-password-age: 1 s
ds-cfg-password-attribute: userpassword
ds-cfg-password-expiration-warning-interval: 1209600 s
ds-cfg-password-history-count: 6
ds-cfg-password-history-duration: 15552000 s
objectClass: ds-cfg-password-policy
objectClass: top
objectClass: ds-cfg-authentication-policy



A newly created user is assigned that policy, and runs ldappasswordmodify repeatedly (with a min-age delay between each one) to keep changing their password.

The pwdHistory attribute is observed to grow by 2 values after each successful ldappasswordmodify, each new value having the same timestamp.

i.e.


pwdHistory: 20140613102356.813Z#1.3.6.1.4.1.26027.1.3.1#{SSHA256}3FFKiQeSmHifO+EEpCOxOZIWU4aRk8OAVyytwmirpmyVqLE02TXyuQ==
pwdHistory: 20140613102356.813Z#1.3.6.1.4.1.26027.1.3.1#{SSHA512}qMcb9a13ZoDBuhaJSgtthLWNuaUqWT14FZYFUTkZxeA4KDqpEaEqtbOXbrm4pgZ3nWC7gTQYrHa0wZLtT9jVgOv1XF1hnseM



then


pwdHistory: 20140613102356.813Z#1.3.6.1.4.1.26027.1.3.1#{SSHA256}3FFKiQeSmHifO+EEpCOxOZIWU4aRk8OAVyytwmirpmyVqLE02TXyuQ==
pwdHistory: 20140613102356.813Z#1.3.6.1.4.1.26027.1.3.1#{SSHA512}qMcb9a13ZoDBuhaJSgtthLWNuaUqWT14FZYFUTkZxeA4KDqpEaEqtbOXbrm4pgZ3nWC7gTQYrHa0wZLtT9jVgOv1XF1hnseM
pwdHistory: 20140613102400.027Z#1.3.6.1.4.1.26027.1.3.1#{SSHA256}KrniYr+6B0sA1TJleXgOS53gQkUT9JAEClZv15vfBxquh+Xugldx9w==
pwdHistory: 20140613102400.027Z#1.3.6.1.4.1.26027.1.3.1#{SSHA512}ejFDnVCs3GFovzX5SdH91wU2vLZoy1IXzRim+pFcWr+HKzRcWsnD/UWn8/6vksxh87xL/e659Qm25OqjgrVqpnRhsOJvCzQn



etc until the 6th change (password-history-count is 6) which results in:


pwdHistory: 20140613102356.813Z#1.3.6.1.4.1.26027.1.3.1#{SSHA256}3FFKiQeSmHifO+EEpCOxOZIWU4aRk8OAVyytwmirpmyVqLE02TXyuQ==
pwdHistory: 20140613102356.813Z#1.3.6.1.4.1.26027.1.3.1#{SSHA512}qMcb9a13ZoDBuhaJSgtthLWNuaUqWT14FZYFUTkZxeA4KDqpEaEqtbOXbrm4pgZ3nWC7gTQYrHa0wZLtT9jVgOv1XF1hnseM
pwdHistory: 20140613102400.027Z#1.3.6.1.4.1.26027.1.3.1#{SSHA256}KrniYr+6B0sA1TJleXgOS53gQkUT9JAEClZv15vfBxquh+Xugldx9w==
pwdHistory: 20140613102400.027Z#1.3.6.1.4.1.26027.1.3.1#{SSHA512}ejFDnVCs3GFovzX5SdH91wU2vLZoy1IXzRim+pFcWr+HKzRcWsnD/UWn8/6vksxh87xL/e659Qm25OqjgrVqpnRhsOJvCzQn
pwdHistory: 20140613102403.236Z#1.3.6.1.4.1.26027.1.3.1#{SSHA256}BlmnL3F4I1+yxW4SJDZ1n4KKquGMB9pls2eZq+NzVuY+4jCP1sh7Aw==
pwdHistory: 20140613102403.236Z#1.3.6.1.4.1.26027.1.3.1#{SSHA512}8XdB2gB3QeoiaNvbOy1WKZ2bV9Biu4fCGePvf8iOsFFc/Na+v0+6xEFEpGmW3NGsSR24Xy97uM0HxndnpuBFS6BdV2chEkXk
pwdHistory: 20140613102406.644Z#1.3.6.1.4.1.26027.1.3.1#{SSHA256}Bl2HJkg5/R+zjT7DO9qC5zGzUY4bIbpVNcCdqz2rSAgiTCecwvD8hg==
pwdHistory: 20140613102406.644Z#1.3.6.1.4.1.26027.1.3.1#{SSHA512}RuwBuuZNS9Cy4si9U8wpfxDMzNAznLrM3nga1iEO1Ei+1tcIPWGpzXUqcygqAeuJcTnU1gBQxD70GZL1WTk19/M4kb4igCJZ
pwdHistory: 20140613102409.856Z#1.3.6.1.4.1.26027.1.3.1#{SSHA256}pWDrYup8mphat+HAEVPthMGRR9TnCFDjMBOuM/EkJlA9cBNWod6iiQ==
pwdHistory: 20140613102409.856Z#1.3.6.1.4.1.26027.1.3.1#{SSHA512}z9A4a492OIvc0a6FHwPU9krprPLjmDhoXAWTeMt+yYayHO+ODBYzD6du/9ZNZOoJr9bTwoXJyoQp0eRYFSmmhX9GCJDJlLuY
pwdHistory: 20140613102413.070Z#1.3.6.1.4.1.26027.1.3.1#{SSHA256}Y+4cDDvF5R9tqf1wZVJnajxKdYGCUl0EnjXD094ZOtHSTCw7M7Wm8w==
pwdHistory: 20140613102413.070Z#1.3.6.1.4.1.26027.1.3.1#{SSHA512}WIcyRVvNA/KQD3Eb3c5qqLllqgfU1lMfY3ODQAYb9kxDMjZ4aRb1SwaadqGPOdvptD1/QIyDo/TJ8kcPQ/vJoVrGog4SXOlq



Subsequent ldappasswordmodify operations succeed in updating the userpassword, but the pwdHistory attribute is never updated.

Repeating the tests using a new entry and a single password storage scheme works as expected, i.e. the 7th password change updates pwdHistory.

The root cause is that the PasswordPolicyState object maintains a single list of modifications that need to be made, but the list ends up containing duplicate deletions of the same value and the modify fails.

The duplicate deletions are because we end up making multiple passes through getSortedHistoryValues() which does the trimming based on the entry's pwdHistory attribute. Each time through getSortedHistoryValues() we re-read the attribute and thus detect the same values need trimming, and thus add the same deletions to the modifications list.