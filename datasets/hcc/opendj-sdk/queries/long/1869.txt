This needs fixing in order to support entry cache preloading.

The fix is a non-trivial unless the loop can be simplified.