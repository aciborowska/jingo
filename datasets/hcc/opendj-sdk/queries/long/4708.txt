With OpenIDM's integration of embedded DJ, when we shutdown the service and connection factory, one or more failures to log an audit message are printed to the logs by DJ. There appears to be a timing issue with DJ shutdown, where the audit service is shutdown before everything has been logged.

We shutdown embedded DJ, and its connection factory, as follows in `org.forgerock.openidm.repo.opendj.impl.Activator#stop` :



    @Override
    public void stop(BundleContext context) {
        logger.info("OpenDJ bundle stopped");
        keyStoreService = null;
        trustStoreService = null;
        if (embeddedServer != null) {
            embeddedServer.stop(this.getClass().getName(), LocalizableMessage.raw("OpenDJ bundle shutdown"));
        }
        if (connectionFactory != null) {
            connectionFactory.close();
        }
    }



The message seen in the log is the following, which is in response to a DISCONNECT event:



WARNING: Failure in publishing audit event to ldap-access : Failed to add event to queue

