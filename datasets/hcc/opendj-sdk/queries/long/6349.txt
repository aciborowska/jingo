I have the following issue in my testbed environment when trying to connect to the /metrics/prometheus endpoint using curl from a remote host, while the same command works locally:


[06/Jun/2019:21:54:42 +0200] category=org.forgerock.opendj.rest2ldap.rest2ldap severity=ERROR msgID=60 msg=An error occurred while processing the request ‘GEThttp://ds:8080/metrics/prometheus': ‘[Status: 500 Internal Server Error]’ (details: ‘Should never happen’) exception=RuntimeException: Should never happen (HttpClientConnection.java:366 HttpClientConnection.java:135 LDAPContextInjectionFilter.java:43 HttpBasicAuthorizationMechanism.java:115 HttpBasicAuthenticationFilter.java:60 Filters.java:172 AuthorizationFilter.java:42 Handlers.java:53 Router.java:100 LDAPContextInjectionFilter.java:52 Handlers.java:53 CommonAuditHttpAccessAuditFilter.java:68 CommonAuditHttpAccessCheckEnabledFilter.java:40 Handlers.java:53 TransactionIdInboundFilter.java:86 Handlers.java:53 AllowDenyFilter.java:72 Handlers.java:53 HTTPConnectionHandler.java:719 HTTPConnectionHandler.java:738 TraditionalWorkQueue.java:462)My curl command is: curl --user monitor:password http://ds:8080/metrics/prometheus



I also tested from another remote host and have no issue. I figured out the hostname I use to connect to ds makes the difference: when using a FQDN (such as ds.mydomain) instead of just a hostname (different from localhost, which works fine too), I have no issue.

So it seems there’s some kind of checking happening at the DS HTTP handler level which makes the request fail  if the Host header (or so) is unknown/unexpected.