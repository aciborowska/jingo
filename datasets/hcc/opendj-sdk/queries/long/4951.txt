In our test with upgraded instance, we see the schema files in a wrong location.

Steps to reproduce:

1) Setup DS 4.0


./setup directory-server -h viktor.internal.forgerock.com -p 1389 -D "cn=Directory Manager" -w password --adminConnectorPort 4444 -Z 1636 -t je -b dc=com -l /home/viktor/repos/pyforge/PyBot/OpenDJ/testcases/data/quickstart.ldif -O --acceptLicense


2) Copy the files from a 6.0.0 .zip

3) Run upgrade command


./upgrade -n --acceptLicense --force

>>>> OpenDJ Upgrade Utility * OpenDJ will be upgraded from version 4.0.0.0b7da454b79944f54e66daf3f591cefb5d77165b to 6.0.0.2d006f3045406838bfdb00a36f61b59622d10490 * See '/home/viktor/repos/pyforge/results/20180329-183045/indexes_group/DJ1/opendj/logs/upgrade.log' for a detailed log of this operation >>>> Preparing to upgrade OpenDJ 5.5.0 changed the indexing algorithm for JSON equality matching rules. All JSON based attribute indexes must be rebuilt which may take a long time. Do you want to rebuild the indexes automatically at the end of the upgrade? (yes/no) yes The upgrade is ready to proceed. Do you wish to continue? (yes/no) yes >>>> Performing upgrade Removing file '/home/viktor/repos/pyforge/results/20180329-183045/indexes_group/DJ1/opendj/QuickSetup.app' . 0% '/home/viktor/repos/pyforge/results/20180329-183045/indexes_group/DJ1/opendj/QuickSetup.app' . 100% Removing file '/home/viktor/repos/pyforge/results/20180329-183045/indexes_group/DJ1/opendj/Uninstall.app' . 0% '/home/viktor/repos/pyforge/results/20180329-183045/indexes_group/DJ1/opendj/Uninstall.app' . 100% Removing file '/home/viktor/repos/pyforge/results/20180329-183045/indexes_group/DJ1/opendj/uninstall' . 0% '/home/viktor/repos/pyforge/results/20180329-183045/indexes_group/DJ1/opendj/uninstall' . 100% Removing file '/home/viktor/repos/pyforge/results/20180329-183045/indexes_group/DJ1/opendj/uninstall.bat' . 0% '/home/viktor/repos/pyforge/results/20180329-183045/indexes_group/DJ1/opendj/uninstall.bat' . 100% Replace parallel work queue by traditional work queue... 20% Replace parallel work queue by traditional work queue............... 100% Removing file '/home/viktor/repos/pyforge/results/20180329-183045/indexes_group/DJ1/opendj/lib/extensions/snmp-mib2605.jar' . 0% '/home/viktor/repos/pyforge/results/20180329-183045/indexes_group/DJ1/opendj/lib/extensions/snmp-mib2605.jar' . 100% Deleting obsolete parameters 'ds-cfg-db-evictor-lru-only' and 'ds-cfg-db-evictor-nodes-per-scan' from JE backends..... 20% 'ds-cfg-db-evictor-nodes-per-scan' from JE backends................. 100% Removing configuration entries for the monitor providers... 20% Removing configuration entries for the monitor providers............ 100% Removing file '/home/viktor/repos/pyforge/results/20180329-183045/indexes_group/DJ1/opendj/bin/control-panel' . 0% '/home/viktor/repos/pyforge/results/20180329-183045/indexes_group/DJ1/opendj/bin/control-panel' . 100% Removing file '/home/viktor/repos/pyforge/results/20180329-183045/indexes_group/DJ1/opendj/bin/ControlPanel.app' . 0% '/home/viktor/repos/pyforge/results/20180329-183045/indexes_group/DJ1/opendj/bin/ControlPanel.app' . 100% Removing file '/home/viktor/repos/pyforge/results/20180329-183045/indexes_group/DJ1/opendj/bat/control-panel.bat' . 0% '/home/viktor/repos/pyforge/results/20180329-183045/indexes_group/DJ1/opendj/bat/control-panel.bat' . 100% Replacing low durability settings in JE backends.... 20% Replacing low durability settings in JE backends.................... 100% Replacing high durability settings in JE backends.... 20% Replacing high durability settings in JE backends................... 100% Replacing medium durability settings in JE backends.... 20% Replacing medium durability settings in JE backends................. 100% Replacing medium durability settings in JE backends.... 20% Replacing medium durability settings in JE backends................. 100% Renaming 'ds-cfg-json-schema' object class to 'ds-cfg-json-query-equality-matching-rule'...... 20% 'ds-cfg-json-query-equality-matching-rule'.......................... 100% Migrating root DN 'cn=Directory Manager'. 0% Migrating root DN 'cn=Directory Manager'............................ 100% Removing root DN users from configuration. 0% Removing root DN users from configuration........................... 100% Segregating mutable and immutable files. 0% Segregating mutable and immutable files............................. 100% Update admin-backend.ldif file location...... 20% Update admin-backend.ldif file location............................. 100% Update tasks backend file location....... 20% Update tasks backend file location.................................. 100% Replacing pin configuration attribute ds-cfg-key-store-pin-file by the attribute ds-cfg-key-store-pin in the configuration entry 'cn=Default Key Manager,cn=Key Manager Providers,cn=config'.. 20% 'cn=Default Key Manager,cn=Key Manager Providers,cn=config'......... 100% Replacing pin configuration attribute ds-cfg-trust-store-pin-file by the attribute ds-cfg-trust-store-pin in the configuration entry 'ds-cfg-backend-id=ads-truststore,cn=Backends,cn=config'... 20% 'ds-cfg-backend-id=ads-truststore,cn=Backends,cn=config'............ 100% Replacing schema file '02-config.ldif'...... 20% Replacing schema file '02-config.ldif'.............................. 100% Archiving concatenated schema........ 20% Archiving concatenated schema....................................... 100% >>>> OpenDJ was successfully upgraded from version 4.0.0.0b7da454b79944f54e66daf3f591cefb5d77165b to 6.0.0.2d006f3045406838bfdb00a36f61b59622d10490 >>>> Performing post upgrade tasks Rebuilding index(es) '[.caseIgnoreJsonQueryMatch, .caseExactJsonQueryMatch]' for base dn(s) '[dc=com]'.... 25% .caseExactJsonQueryMatch]' for base dn(s) '[dc=com]'................ 100% >>>> Post upgrade tasks complete * See '/home/viktor/repos/pyforge/results/20180329-183045/indexes_group/DJ1/opendj/logs/upgrade.log' for a detailed log of this operation


4) Check the contents of db/ and config/ folders:


viktor@viktor-dell ~/repos/pyforge/results/latest/indexes_group/DJ1/opendj (master *$ u=)$ ls db
admin rootUser tasks userRoot
viktor@viktor-dell ~/repos/pyforge/results/latest/indexes_group/DJ1/opendj (master *$ u=)$ ls config/
ads-truststore audit-handlers common-passwords.txt java.properties keystore.pin messages schema tools.properties
ads-truststore.pin buildinfo config.ldif keystore MakeLDIF rest2ldap snmp wordlist.txt


We expect the schema files to be under the db/ folder, but they stay in the config/ after the upgrade.

Â 