Found using OpenDJ 6.0.0 SNAPSHOT and OpenDJ 5.5.1 RC4 on Windows.

Scenario

	install and configure a replication toplogy with split DS RS (DS1, RS1, DS2, RS2)
	check replication is working doing some add, delete, modify operations
	stop RS1, upgrade and restart it
	check replication is working doing some add, delete, modify operations
	stop DS2, upgrade and restart it
	check replication is working doing some add, delete, modify operations
	stop RS2, upgrade and restart it
	check replication is working doing some add, delete, modify operations
	stop DS1, upgrade and restart it
	check replication is working doing some add, delete, modify operations
	stop DS1 and check logs for errors
	stop RS1 and check logs for errors
	stop RS2 and check logs for errors
	stop DS2 and check logs for errors



In DS2 logs we have the following error:

[06/Mar/2018:20:51:33 +0000] category=SYNC severity=ERROR msgID=119 msg=Directory server DS(7758) encountered an unexpected error while connecting to replication server ig-win2016.internal.forgerock.com:9007 for domain "cn=schema": IllegalArgumentException: Unexpected PDU type: org.opends.server.replication.protocol.StopMsg:


==> the time for the error corresponds to the stop of RS2

NOTE
Sometimes we have another error swhen uninstalling/stopping the replication topology.
In RS1 logs we have:

[26/Feb/2018:20:53:41 +0000] category=SYNC severity=ERROR msgID=300 msg=New replication connection from 172.24.3.52:59929 started with unexpected message StopMsg and is being closed


=> this error corresponds to issue OPENDJ-3309

And at later in DS2 logs:

[26/Feb/2018:20:59:18 +0000] category=SYNC severity=ERROR msgID=119 msg=Directory server DS(25470) encountered an unexpected error while connecting to replication server ig-win2016.internal.forgerock.com:9007 for domain "cn=admin data": SocketException: Connection reset (SocketInputStream.java:210 SocketInputStream.java:141 InputRecord.java:465 InputRecord.java:503 SSLSocketImpl.java:973 SSLSocketImpl.java:1375 SSLSocketImpl.java:1403 SSLSocketImpl.java:1387 ReplSessionSecurity.java:153 ReplicationBroker.java:954 ReplicationBroker.java:720 ReplicationBroker.java:1819 ReplicationBroker.java:2065 ReplicationDomain.java:654 ReplicationDomain.java:2484 Thread.java:745)

