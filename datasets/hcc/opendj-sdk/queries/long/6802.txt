The pipeline K8S stage is failing. After some investigation with Ondrej Fuchsik we were able to track it down to the use of quite complex hostnames in our PIT1 environment that cause the docker-entrypoint.sh script to miscalculate the default DS_BOOTSTRAP_REPLICATION_SERVERS settings.

The following test script demonstrates how the computation should be performed:



#!/usr/bin/env bash
set -eu

test() {
    podDomain=${1#*.}
    podName=${1%%.*}
    podPrefix=${podName%-*}

    echo "DS_ADVERTISED_LISTEN_ADDRESS: ${1}"
    echo "podDomain                   : ${podDomain}"
    echo "podName                     : ${podName}"
    echo "podPrefix                   : ${podPrefix}"
    echo
}

test ds-1.userstore.svc.cluster.local
test ds-userstore-1.userstore.svc.cluster.local
test userstore-1.userstore.jnkns-pndj-bld-pr-4958-1.svc.cluster.local
test ds-userstore-1.userstore.jnkns-pndj-bld-pr-4958-1.svc.cluster.local



Previous to the fix the podPrefix was computed as `ds-userstore-1.userstore.jnkns-pndj-bld-pr-4958` for the last test case above, with a similar failure for the third test case.