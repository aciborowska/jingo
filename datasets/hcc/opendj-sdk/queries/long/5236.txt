Found with rev 84e7df93a44cd629d873a43c9f4e01a253e592dd

We set up 2 servers in 3.5.0 version, one with some data and we replicate them.
 We enable confidentiality on both changelog:

./DJ_ENCRYPT1/opendj/bin/dsconfig -h nameserver.example.com -p 4455 -D "cn=Directory Manager" -w password -X \
    set-replication-server-prop --provider-name "Multimaster Synchronization" --set confidentiality-enabled:true -n

./DJ_ENCRYPT2/opendj/bin/dsconfig -h nameserver.example.com -p 4456 -D "cn=Directory Manager" -w password -X \
    set-replication-server-prop --provider-name "Multimaster Synchronization" --set confidentiality-enabled:true -n


We add some entries through ldapmodify and check data are in sync.
 Then we stop and upgrade one server.
 It fails with the following error:

./DJ_ENCRYPT1/opendj/upgrade -n --acceptLicense --force
18:09:49.966 WARN ERROR:
– rc –
returned 1, expected [0]
– stdout –

>>>> OpenDJ Upgrade Utility

OpenDJ will be upgraded from version
3.5.0.6c04f4cb5de809ea1b4e8deb12925396da89d841 to
6.5.0.84e7df93a44cd629d873a43c9f4e01a253e592dd
See
'/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/logs/upgrade.log'
for a detailed log of this operation

>>>> Preparing to upgrade

OpenDJ 5.5.0 changed the indexing algorithm for JSON equality matching
rules. All JSON based attribute indexes must be rebuilt which may take a
long time. Do you want to rebuild the indexes automatically at the end of
the upgrade? (yes/no) yes

The upgrade is ready to proceed. Do you wish to continue? (yes/no) yes

>>>> Performing upgrade

Adding configuration for schema providers. 0% Adding configuration for schema providers........................... 100%
Adding configuration entry 'dn: cn=Core Schema,cn=Schema
Providers,cn=config'. 0% Providers,cn=config'................................................ 100%
Removing top configuration entry for matching rules. 0% Removing top configuration entry for matching rules................. 100%
Removing configuration for syntaxes. 0% Removing configuration for syntaxes................................. 100%
Adding local backend object class. 0% Adding local backend object class................................... 100%
Removing base-dn attribute for backends where base-dn is fixed. 0% Removing base-dn attribute for backends where base-dn is fixed...... 100%
Removing file
'/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/lib/je.jar'
. 0% '/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/lib/je.jar'
. 100%
Removing file
'/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/lib/opendj-je-backend.jar'
. 0% '/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/lib/opendj-je-backend.jar'
. 100%
Replacing schema file '03-keystore.ldif'. 0% Replacing schema file '03-keystore.ldif'...... 20% Replacing schema file '03-keystore.ldif'............................ 100%
Removing file
'/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/QuickSetup.app'
. 0% '/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/QuickSetup.app'
. 100%
Removing file
'/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/Uninstall.app'
. 0% '/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/Uninstall.app'
. 100%
Removing file
'/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/uninstall'
. 0% '/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/uninstall'
. 100%
Removing file
'/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/uninstall.bat'
. 0% '/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/uninstall.bat'
. 100%
Replace parallel work queue by traditional work queue. 0% Replace parallel work queue by traditional work queue............... 100%
Removing file
'/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/lib/extensions/snmp-mib2605.jar'
. 0% '/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/lib/extensions/snmp-mib2605.jar'
. 100%
Deleting obsolete parameters 'ds-cfg-db-evictor-lru-only' and
'ds-cfg-db-evictor-nodes-per-scan' from JE backends.. 0% 'ds-cfg-db-evictor-nodes-per-scan' from JE backends................. 100%
Removing configuration entries for the monitor providers. 0% Removing configuration entries for the monitor providers............ 100%
Removing file
'/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/bin/control-panel'
. 0% '/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/bin/control-panel'
. 100%
Removing file
'/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/bin/ControlPanel.app'
. 0% '/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/bin/ControlPanel.app'
. 100%
Removing file
'/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/bat/control-panel.bat'
. 0% '/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/bat/control-panel.bat'
. 100%
Removing file
'/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/lib/forgerock-persistit-core.jar'
. 0% '/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/lib/forgerock-persistit-core.jar'
. 100%
Replacing low durability settings in JE backends. 0% Replacing low durability settings in JE backends.................... 100%
Replacing high durability settings in JE backends. 0% Replacing high durability settings in JE backends................... 100%
Replacing medium durability settings in JE backends. 0% Replacing medium durability settings in JE backends................. 100%
Replacing medium durability settings in JE backends. 0% Replacing medium durability settings in JE backends................. 100%
Renaming 'ds-cfg-json-schema' object class to
'ds-cfg-json-query-equality-matching-rule'. 0% 'ds-cfg-json-query-equality-matching-rule'.......................... 100%
Migrating root DN 'cn=Directory Manager'. 0% Migrating root DN 'cn=Directory Manager'............................ 100%
Removing root DN users from configuration. 0% Removing root DN users from configuration........................... 100%
Segregating mutable and immutable files. 0% Segregating mutable and immutable files............................. 100%
Update admin-backend.ldif file location. 0% Update admin-backend.ldif file location............................. 100%
Update tasks backend file location. 0% Update tasks backend file location.................................. 100%
Replacing all pin related configuration attributes by a single pin
configuration attribute. 0% configuration attribute............................................. 100%
Removing send and receive window size configuration in replication. 0% Removing send and receive window size configuration in replication.. 100%
Updating ds-cfg-ldif-file in adminRoot backend configuration entry. 0% Updating ds-cfg-ldif-file in adminRoot backend configuration entry.. 100%
Replacing schema file '02-config.ldif'. 0% Replacing schema file '02-config.ldif'...... 20% Replacing schema file '02-config.ldif'.............................. 100%
Archiving concatenated schema. 0% Archiving concatenated schema....................................... 100%
Moving admin-backend.ldif, admin-backend.ldif.old from db/admin to
db/adminRoot. 0% db/adminRoot........................................................ 100%
Migrating replication changelog files to 6.5.0 format. 0% Migrating replication changelog files to 6.5.0 format.. 14% Migrating replication changelog files to 6.5.0 format.... 28% Migrating replication changelog files to 6.5.0 format...... 42% Migrating replication changelog files to 6.5.0 format........ 57% Migrating replication changelog files to 6.5.0 format.......... 71% Migrating replication changelog files to 6.5.0 format............... FAIL
Migrating replication changelog files to 6.5.0 format............... FAIL

An error occurred while renaming the changelog files: ClientException: An
error occured while migrating replicas' offline states to the changelog
files: ChangelogException: Could not add record 'Record
[000001645bc1b6004d3d00000005:ReplicaOfflineMsg
offlineCSN=000001645bc1b6004d3d00000005]' in log file
'/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/changelogDb/1.dom/19773.server/000001645bc142494d3d00000001.log'
(BlockLogWriter.java:119 LogFile.java:202 Log.java:357
ReplicationEnvironment.java:842 FileChangelogDB.java:850
UpgradeTasks.java:1715 UpgradeTasks.java:1666 ProgressMonitor.java:76
UpgradeTasks.java:1656 Upgrade.java:855 UpgradeCli.java:213 Utils.java:959
Utils.java:941 UpgradeCli.java:89) (UpgradeTasks.java:909
UpgradeTasks.java:114 UpgradeTasks.java:1721 UpgradeTasks.java:1666
ProgressMonitor.java:76 UpgradeTasks.java:1656 Upgrade.java:855
UpgradeCli.java:213 Utils.java:959 Utils.java:941 UpgradeCli.java:89)
See
'/local/GIT/pyforge/results/20180702-180737/upgrade_group/Replication/DJ_ENCRYPT1/opendj/logs/upgrade.log'
for a detailed log of this operation

reproducible with:


./run-pybot.py -s upgrade_group.Replication -t encrypted_replication_topology opendj

