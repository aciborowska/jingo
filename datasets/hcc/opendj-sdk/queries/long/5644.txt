As part of OPENIDM-11973 IDM needs to upgrade the latest DS ( 6.5.0-RC1 ) however, when pulling in this version IDM fails to start with the following error:


SEVERE: Bundle: org.forgerock.openidm.repo-opendj [9] FrameworkEvent ERROR
org.apache.felix.log.LogException: org.osgi.framework.BundleException: Activator start error in bundle org.forgerock.openidm.repo-opendj [9].
at org.apache.felix.framework.Felix.activateBundle(Felix.java:2290)
at org.apache.felix.framework.Felix.startBundle(Felix.java:2146)
at org.apache.felix.framework.Felix.setActiveStartLevel(Felix.java:1373)
at org.apache.felix.framework.FrameworkStartLevelImpl.run(FrameworkStartLevelImpl.java:308)
at java.lang.Thread.run(Thread.java:745)
Caused by: java.lang.NullPointerException
at org.opends.server.api.KeyManagerProvider.registerCertificateMonitorEntries(KeyManagerProvider.java:235)
at org.opends.server.core.KeyManagerProviderConfigManager.createJvmKeyStoreCertificateMonitorIfNeeded(KeyManagerProviderConfigManager.java:109)
at org.opends.server.core.KeyManagerProviderConfigManager.initializeKeyManagerProviders(KeyManagerProviderConfigManager.java:102)
at org.opends.server.core.DirectoryServer.startServer(DirectoryServer.java:1307)
at org.forgerock.opendj.server.embedded.EmbeddedDirectoryServer.start(EmbeddedDirectoryServer.java:634)
at org.forgerock.openidm.repo.opendj.impl.Activator.setupEmbeddedServer(Activator.java:572)
at org.forgerock.openidm.repo.opendj.impl.Activator.initializeEmbeddedServer(Activator.java:382)
at org.forgerock.openidm.repo.opendj.impl.Activator.start(Activator.java:184)
at org.apache.felix.framework.util.SecureAction.startActivator(SecureAction.java:697)
at org.apache.felix.framework.Felix.activateBundle(Felix.java:2240)
... 4 more

-> [110] Oct 30, 2018 12:19:33.665 PM org.forgerock.openidm.health.HealthService$4 run
SEVERE: OpenIDM failure during startup, ACTIVE_NOT_READY: Not all modules started [] [org.forgerock.openidm.repo-opendj] []

 

Currently IDM is on DS Milestone  6.5.0-M130.1 and commons 24.0.0-alpha-47
 However, this startup error occurs regardless of IDM being on  24.0.0-alpha-47 or  24.0.0-alpha-50

When debugging DJ, it looks like the serverContext isnt being set for the JVM Key Manager (see attachment)

Steps to reproduce:
 1. check out the following PR: https://stash.forgerock.org/projects/OPENIDM/repos/openidm/pull-requests/4567/overview
 2. Build IDM locally, using either


mvn clean install  -D skipTests  -T 1C

or


mvn clean install -T 1C 

3. Unzip IDM into desired directory. This will create an openidm folder


unzip /Users/krismy.alfaro/Documents/repos/openidm/openidm-zip/target/openidm-*.zip

4. Go into the openidm folder and start IDM with the following. This will allow you to set up your debugger. will want to debug on host: localhost and port: 5005 (see attachment for intelliJ setup)


./startup.sh jpda


5. On startup you will see that IDM fails to start with the above error in console.

Current results:
IDM cannot start due to error.

Expected Results:
IDM starts with no errors in console.