A buildup of GRIZZLY TCPNIOConnection objects leads to hangs anywhere between 2 days to 2 weeks depending on DS load.

1. heap dump

7,599 instances of "com.sleepycat.je.tree.BIN", loaded by "sun.misc.Launcher$AppClassLoader @ 0xaaaa14e0" occupy 43,441,248 (31.78%) bytes.

Biggest instances:

com.sleepycat.je.tree.BIN @ 0xaaed8020 - 2,456,720 (1.80%) bytes.
These instances are referenced from one instance of "java.util.concurrent.ConcurrentHashMap$Node[]", loaded by "<system class loader>"

Keywords
sun.misc.Launcher$AppClassLoader @ 0xaaaa14e0
java.util.concurrent.ConcurrentHashMap$Node[]
com.sleepycat.je.tree.BIN

606 instances of "org.glassfish.grizzly.nio.transport.TCPNIOConnection", loaded by "sun.misc.Launcher$AppClassLoader @ 0xaaaa14e0" occupy 16,692,456 (12.21%) bytes.

Keywords
org.glassfish.grizzly.nio.transport.TCPNIOConnection
sun.misc.Launcher$AppClassLoader @ 0xaaaa14e0

 

2. heap dump 

575 instances of "org.glassfish.grizzly.nio.transport.TCPNIOConnection", loaded by "sun.misc.Launcher$AppClassLoader @ 0xaaaa0800" occupy 14,294,040 (21.72%) bytes.

Keywords
org.glassfish.grizzly.nio.transport.TCPNIOConnection
sun.misc.Launcher$AppClassLoader @ 0xaaaa0800

 

3.High CPU threads all in Grizzly SSL code

CPU = 101.0 % (nid=0x6a84)
"LDAPS 0.0.0.0 port 1636(10) SelectorRunner" #160 daemon prio=5 os_prio=0 tid=0x00007fa3f9764800 nid=0x6a84 runnable [0x00007fa11f8f7000]
   java.lang.Thread.State: RUNNABLE
        at sun.security.ssl.SSLEngineImpl.writeAppRecord(SSLEngineImpl.java:1212)
        - locked <0x00000000b2e62908> (a sun.security.ssl.SSLEngineImpl)
        at sun.security.ssl.SSLEngineImpl.wrap(SSLEngineImpl.java:1165)
        - locked <0x00000000b0bd6b80> (a java.lang.Object)
        at javax.net.ssl.SSLEngine.wrap(SSLEngine.java:469)
        at org.glassfish.grizzly.ssl.SSLUtils.sslEngineWrap(SSLUtils.java:451)
        at org.glassfish.grizzly.ssl.SSLConnectionContext.wrap(SSLConnectionContext.java:360)
        at org.glassfish.grizzly.ssl.SSLUtils.handshakeWrap(SSLUtils.java:327)
        at org.glassfish.grizzly.ssl.SSLBaseFilter.doHandshakeStep(SSLBaseFilter.java:698)
        at org.glassfish.grizzly.ssl.SSLFilter.doHandshakeStep(SSLFilter.java:332)
        at org.glassfish.grizzly.ssl.SSLBaseFilter.doHandshakeStep(SSLBaseFilter.java:623)
        at org.glassfish.grizzly.ssl.SSLBaseFilter.handleRead(SSLBaseFilter.java:335)
        at org.glassfish.grizzly.filterchain.ExecutorResolver$9.execute(ExecutorResolver.java:119)
        at org.glassfish.grizzly.filterchain.DefaultFilterChain.executeFilter(DefaultFilterChain.java:284)
        at org.glassfish.grizzly.filterchain.DefaultFilterChain.executeChainPart(DefaultFilterChain.java:201)
        at org.glassfish.grizzly.filterchain.DefaultFilterChain.execute(DefaultFilterChain.java:133)
        at org.glassfish.grizzly.filterchain.DefaultFilterChain.process(DefaultFilterChain.java:112)
        at org.glassfish.grizzly.ProcessorExecutor.execute(ProcessorExecutor.java:77)
        at org.glassfish.grizzly.nio.transport.TCPNIOTransport.fireIOEvent(TCPNIOTransport.java:539)
        at org.glassfish.grizzly.strategies.AbstractIOStrategy.fireIOEvent(AbstractIOStrategy.java:112)
        at org.glassfish.grizzly.strategies.SameThreadIOStrategy.executeIoEvent(SameThreadIOStrategy.java:103)
        at org.glassfish.grizzly.strategies.AbstractIOStrategy.executeIoEvent(AbstractIOStrategy.java:89)
        at org.glassfish.grizzly.nio.SelectorRunner.iterateKeyEvents(SelectorRunner.java:415)
        at org.glassfish.grizzly.nio.SelectorRunner.iterateKeys(SelectorRunner.java:384)
        at org.glassfish.grizzly.nio.SelectorRunner.doSelect(SelectorRunner.java:348)
        at org.glassfish.grizzly.nio.SelectorRunner.run(SelectorRunner.java:279)
        at org.glassfish.grizzly.threadpool.AbstractThreadPool$Worker.doWork(AbstractThreadPool.java:593)
        at org.glassfish.grizzly.threadpool.AbstractThreadPool$Worker.run(AbstractThreadPool.java:573)
        at java.lang.Thread.run(Thread.java:748)

 

Errors encountered

[21/Sep/2019:23:17:21 +0100] category=org.opends.messages.external severity=WARNING msgID=1 msg=GRIZZLY0013: Exception during FilterChain execution exception=IllegalArgumentException: Cannot change mode after SSL traffic has started (SSLEngineImpl.java:1990 SSLEngineConfigurator.java:246 SSLFilter.java:245 SSLFilter.java:168 ExecutorResolver.java:111 DefaultFilterChain.java:284 DefaultFilterChain.java:201 DefaultFilterChain.java:133 DefaultFilterChain.java:112 ProcessorExecutor.java:77 DefaultFilterChain.java:414 NIOConnection.java:431 NIOConnection.java:405 GrizzlyLdapSocketFilter.java:245 GrizzlyLdapSocketFilter.java:158 FlowableMap.java:69 FlowableOnErrorReturn.java:50 FlowableDoOnEach.java:92 FlowableDoOnEach.java:92 FlowableOnErrorNext.java:69 FlowableDoOnEach.java:92 ...)

Other info:

	DS 650 with 2gb Max heap
	Shared cache enabled
	The instance is properly tuned: JVM tunables



Java & System info 

        javaVersion       1.8.0_212
        javaVendor        Oracle Corporation
        usedMemory        1599000872 (1.48919 GB)
        maxMemory         2075918335 (1.93335 GB)
        avail disk space  8161648640 (7.60113 GB)
        available CPUs    40        Operating System  2.6.32-754.17.1.el6.x86_64

JVM info 

start-ds.java-args=-Xms2048m -Xmx2048m -Dcom.sun.management.jmxremote -Ds=opendj -server -XX:+UseCompressedOops -XX:+UseConcMarkSweepGC -XX:MaxTenuringThreshold=1 -XX:+DisableExplicitGC

 

 

 

 