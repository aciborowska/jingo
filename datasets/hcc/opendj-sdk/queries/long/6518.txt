Found with rev 0f06286fb31053145af833da7b2d320f507e3823

Since this commit: https://stash.forgerock.org/projects/OPENDJ/repos/opendj/commits/6b0393a390e4acfe632b16ac32fba565f4c373c2
We are regularly encountering an issue at server startup when running tests in parallel on docker containers:


[04/Aug/2019:05:56:34 +0000] category=CORE severity=NOTICE msgID=134 msg=ForgeRock Directory Services 7.0.0-SNAPSHOT (build 20190802213433, revision number 0f06286fb31053145af833da7b2d320f507e3823) starting up [04/Aug/2019:05:56:34 +0000] category=JVM severity=NOTICE msgID=21 msg=Installation Directory: /root/workspace/OpenDJ-7.0.x/tests_ds_upgrade_paths_je/results/20190804-054324/replication_group3/Upgrade/DJ_REPL2/opendj [04/Aug/2019:05:56:34 +0000] category=JVM severity=NOTICE msgID=23 msg=Instance Directory: /root/workspace/OpenDJ-7.0.x/tests_ds_upgrade_paths_je/results/20190804-054324/replication_group3/Upgrade/DJ_REPL2/opendj [04/Aug/2019:05:56:34 +0000] category=JVM severity=NOTICE msgID=17 msg=JVM Information: 1.8.0_181-b13 by Oracle Corporation, 64-bit architecture, 28631367680 bytes heap size [04/Aug/2019:05:56:34 +0000] category=JVM severity=NOTICE msgID=18 msg=JVM Host: openam.example.com default/3369, running Linux 3.10.0-862.3.2.el7.x86_64 amd64, 337829965824 bytes physical memory size, number of processors available 40 [04/Aug/2019:05:56:34 +0000] category=JVM severity=NOTICE msgID=19 msg=JVM Arguments: "-XX:+UnlockExperimentalVMOptions", "-XX:+UseCGroupMemoryLimitForHeap", "-Dorg.opends.server.scriptName=start-ds" [04/Aug/2019:05:56:34 +0000] category=EXTENSIONS severity=ERROR msgID=670 msg=File based key manager provider 'Replication Key Manager' cannot load content from keystore file 'null'. TLS connections which rely on this key manager provider may fail. Restarting the server or the impacted connection handler may resolve this problem. Error detail: User limit of inotify instances reached or too many open files [04/Aug/2019:05:56:34 +0000] category=EXTENSIONS severity=ERROR msgID=670 msg=File based key manager provider 'Default Key Manager' cannot load content from keystore file 'null'. TLS connections which rely on this key manager provider may fail. Restarting the server or the impacted connection handler may resolve this problem. Error detail: User limit of inotify instances reached or too many open files [04/Aug/2019:05:56:34 +0000] category=CONFIG severity=ERROR msgID=640 msg=An error occurred while trying to initialize an instance of class org.opends.server.extensions.FileBasedTrustManagerProvider as a trust manager provider as defined in configuration entry cn=Replication Trust Manager,cn=Trust Manager Providers,cn=config: InitializationException: File based trust manager provider 'Replication Trust Manager' cannot load content from truststore file 'null'. TLS connections which rely on this trust manager provider may fail. Restarting the server or the impacted connection handler may resolve this problem. Error detail: User limit of inotify instances reached or too many open files (FileBasedTrustManagerProvider.java:180 FileBasedTrustManagerProvider.java:167 FileBasedTrustManagerProvider.java:76 TrustManagerProviderConfigManager.java:212 TrustManagerProviderConfigManager.java:84 DirectoryServer.java:1543 DirectoryServer.java:4146) [04/Aug/2019:05:56:35 +0000] category=CONFIG severity=ERROR msgID=116 msg=An error occurred while trying to initialize a backend loaded from class org.opends.server.backends.jeb.JEBackend with the information in configuration entry ds-cfg-backend-id=userRoot,cn=Backends,cn=config: The database environment could not be opened: com.sleepycat.je.EnvironmentFailureException: (JE 18.3.12) /root/workspace/OpenDJ-7.0.x/tests_ds_upgrade_paths_je/results/20190804-054324/replication_group3/Upgrade/DJ_REPL2/opendj/db/userRoot Can not register /root/workspace/OpenDJ-7.0.x/tests_ds_upgrade_paths_je/results/20190804-054324/replication_group3/Upgrade/DJ_REPL2/opendj/db/userRoot or its sub-directories to WatchService. UNEXPECTED_EXCEPTION: Unexpected internal Exception, may have side effects. Environment is invalid and must be closed.. This backend will be disabled [04/Aug/2019:05:56:35 +0000] category=CORE severity=NOTICE msgID=139 msg=The Directory Server has sent an alert notification generated by class org.opends.server.core.DirectoryServer (alert type org.opends.server.DirectoryServerShutdown, alert ID org.opends.messages.core-141): The Directory Server has started the shutdown process. The shutdown was initiated by an instance of class org.opends.server.core.DirectoryServer and the reason provided for the shutdown was An error occurred while attempting to bootstrap the Directory Server: An error occurred while trying to initialize a backend loaded from class org.opends.server.backends.jeb.JEBackend with the information in configuration entry ds-cfg-backend-id=userRoot,cn=Backends,cn=config: The database environment could not be opened: com.sleepycat.je.EnvironmentFailureException: (JE 18.3.12) /root/workspace/OpenDJ-7.0.x/tests_ds_upgrade_paths_je/results/20190804-054324/replication_group3/Upgrade/DJ_REPL2/opendj/db/userRoot Can not register /root/workspace/OpenDJ-7.0.x/tests_ds_upgrade_paths_je/results/20190804-054324/replication_group3/Upgrade/DJ_REPL2/opendj/db/userRoot or its sub-directories to WatchService. UNEXPECTED_EXCEPTION: Unexpected internal Exception, may have side effects. Environment is invalid and must be closed.. This backend will be disabled [04/Aug/2019:05:56:35 +0000] category=CORE severity=NOTICE msgID=203 msg=The Directory Server is now stopped



I'm raising this issue so that we can discuss and see if it is not hiding a  real problem or if we just need to adapt our infrastructure to the new needs introduced by this watchservice api calls.

In the meantime, since we get this error: "Error detail: User limit of inotify instances reached or too many open files", we will increment the number of inodes with this: "sudo sysctl --write fs.inotify.max_user_watches=524288"

