Adding bad child group references cause JE to fault and become unusable.

Notes:

	Only 4.0.0, 5.5.0 and 6.0.0 (tested) throw the StackOverflowError and EnvironmentFailureException in JE.
	2.x-3.5.3 (tested) have the backend -1 issue (seen below) but do not throw the StackOverflowError error or have the EnvironmentFailureException in JE.



Testcase steps

	Setup an instance with 10000 (X) entries (9998 users) and add an ou=Groups.
	Add schema
	Add Group set 1
	Search all entries
	Add Group set 2.
	Search all entries



 

 

./ldapsearch --port 1389 -D "cn=Directory Manager" -w password --baseDN dc=example,dc=com objectClass=* | grep -c ^dn:
10003


Processing ADD request for ou=SSOGroups,ou=groups,dc=example,dc=com
ADD operation successful for DN ou=SSOGroups,ou=groups,dc=example,dc=com
Processing ADD request for cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
ADD operation successful for DN cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
Processing ADD request for cn=SSOEnforcedExclusion,ou=SSOGroups,ou=groups,dc=example,dc=com
ADD operation successful for DN cn=SSOEnforcedExclusion,ou=SSOGroups,ou=groups,dc=example,dc=com
Processing ADD request for cn=SSOEnforced,ou=SSOGroups,ou=groups,dc=example,dc=com
ADD operation successful for DN cn=SSOEnforced,ou=SSOGroups,ou=groups,dc=example,dc=com
Processing ADD request for cn=SSOEnforcedExclusion,dc=example,dc=com
ADD operation successful for DN cn=SSOEnforcedExclusion,dc=example,dc=com
Processing ADD request for cn=SSOEnforced,dc=example,dc=com
ADD operation successful for DN cn=SSOEnforced,dc=example,dc=com
Processing ADD request for cn=SnSrianan,cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
ADD operation successful for DN cn=SnSrianan,cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
Processing ADD request for cn=SnUsers,cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
ADD operation successful for DN cn=SnUsers,cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
Processing ADD request for cn=SnSmithXXX,cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
ADD operation successful for DN cn=SnSmithXXX,cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
Processing ADD request for cn=SnUsers,cn=SSOEnforcedExclusion,ou=SSOGroups,ou=groups,dc=example,dc=com
ADD operation successful for DN cn=SnUsers,cn=SSOEnforcedExclusion,ou=SSOGroups,ou=groups,dc=example,dc=com
Processing ADD request for cn=SnUsers,cn=SSOEnforced,ou=SSOGroups,ou=groups,dc=example,dc=com
ADD operation successful for DN cn=SnUsers,cn=SSOEnforced,ou=SSOGroups,ou=groups,dc=example,dc=com
Processing ADD request for cn=SnSmithXXX,cn=SSOEnforced,ou=SSOGroups,ou=groups,dc=example,dc=com
ADD operation successful for DN cn=SnSmithXXX,cn=SSOEnforced,ou=SSOGroups,ou=groups,dc=example,dc=com

./ldapsearch --port 1389 -D "cn=Directory Manager" -w password --baseDN dc=example,dc=com objectClass=* | grep -c ^dn:
10013


Processing MODIFY request for cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
MODIFY operation successful for DN cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
Processing MODIFY request for cn=SSOEnforcedExclusion,ou=SSOGroups,ou=groups,dc=example,dc=com
MODIFY operation successful for DN cn=SSOEnforcedExclusion,ou=SSOGroups,ou=groups,dc=example,dc=com
Processing MODIFY request for cn=SSOEnforced,ou=SSOGroups,ou=groups,dc=example,dc=com
MODIFY operation successful for DN cn=SSOEnforced,ou=SSOGroups,ou=groups,dc=example,dc=com

./ldapsearch --port 1389 -D "cn=Directory Manager" -w password --baseDN dc=example,dc=com objectClass=* | grep ^dn:
dn: dc=example,dc=com
dn: ou=Groups,dc=example,dc=com
dn: ou=SSOGroups,ou=groups,dc=example,dc=com
dn: cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
dn: cn=SnSmithXXX,cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
dn: cn=SnSrianan,cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
dn: cn=SnUsers,cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
dn: cn=SSOEnforced,ou=SSOGroups,ou=groups,dc=example,dc=com
dn: cn=SnSmithXXX,cn=SSOEnforced,ou=SSOGroups,ou=groups,dc=example,dc=com
dn: cn=SnUsers,cn=SSOEnforced,ou=SSOGroups,ou=groups,dc=example,dc=com
dn: cn=SSOEnforcedExclusion,ou=SSOGroups,ou=groups,dc=example,dc=com
dn: cn=SnUsers,cn=SSOEnforcedExclusion,ou=SSOGroups,ou=groups,dc=example,dc=com
dn: ou=People,dc=example,dc=com

 

Note the ordering of the above search.  This is not how the backend has the entries stored.

 

opendj; bin /$ grep "^dn: " forgerock.ldif | grep -v uid=
dn: dc=example,dc=com
dn: ou=People,dc=example,dc=com
dn: ou=Groups,dc=example,dc=com
dn: ou=SSOGroups,ou=groups,dc=example,dc=com
dn: cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
dn: cn=SSOEnforcedExclusion,ou=SSOGroups,ou=groups,dc=example,dc=com
dn: cn=SSOEnforced,ou=SSOGroups,ou=groups,dc=example,dc=com
dn: cn=SSOEnforcedExclusion,dc=example,dc=com
dn: cn=SSOEnforced,dc=example,dc=com
dn: cn=SnSrianan,cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
dn: cn=SnUsers,cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
dn: cn=SnSmithXXX,cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
dn: cn=SnUsers,cn=SSOEnforcedExclusion,ou=SSOGroups,ou=groups,dc=example,dc=com
dn: cn=SnUsers,cn=SSOEnforced,ou=SSOGroups,ou=groups,dc=example,dc=com
dn: cn=SnSmithXXX,cn=SSOEnforced,ou=SSOGroups,ou=groups,dc=example,dc=com

 

Here is the stack overflow error thrown when 

 

[01/Mar/2018:17:46:24 -0700] CONNECT conn=10 from=192.168.0.105:50990 to=192.168.0.105:1389 protocol=LDAP
[01/Mar/2018:17:46:24 -0700] BIND REQ conn=10 op=0 msgID=1 version=3 type=SIMPLE dn="cn=Directory Manager"
[01/Mar/2018:17:46:24 -0700] BIND RES conn=10 op=0 msgID=1 result=0 authDN="cn=Directory Manager" etime=10
[01/Mar/2018:17:46:24 -0700] SEARCH REQ conn=10 op=1 msgID=2 base="dc=example,dc=com" scope=sub filter="(objectClass=*)" attrs="ALL"
[01/Mar/2018:17:46:24 -0700] SEARCH RES conn=10 op=1 msgID=2 result=0 nentries=13 unindexed etime=32
[01/Mar/2018:17:46:24 -0700] UNBIND REQ conn=10 op=2 msgID=3
[01/Mar/2018:17:46:24 -0700] DISCONNECT conn=10 reason="Server Error" msg="Worker Thread 15 encountered an uncaught exception while processing operation SearchOperation(connID=10, opID=1, baseDN=dc=example,dc=com, scope=sub, filter=(objectClass=*)): StackOverflowError (ThreadPoolExecutor.java:1395 Evictor.java:1815 EnvironmentImpl.java:2314 EnvironmentImpl.java:1653 EnvironmentImpl.java:1682 Environment.java:2553 Database.java:1381 Database.java:1430 JEStorage.java:356 DN2ID.java:126 EntryContainer.java:1846 EntryContainer.java:1822 JEStorage.java:676 TracedStorage.java:414 EntryContainer.java:1821 BackendImpl.java:385 DirectoryServer.java:2462 DynamicGroup.java:161 StaticGroup.java:298 StaticGroup.java:316 Group.java:197 ...)"
[01/Mar/2018:17:47:36 -0700] CONNECT conn=11 from=127.0.0.1:51003 to=127.0.0.1:4444 protocol=LDAPS

 

 

Monitor data shows the backend has -1 entries and ldapsearches can only return all but person type entries.

The following is seen in 4.0.0, 5.5.0 and 6.0.0 only

 

dn: cn=userRoot,cn=Backends,cn=monitor
objectClass: top
objectClass: ds-monitor
objectClass: ds-monitor-pluggable-backend
objectClass: extensibleObject
ds-backend-id: userRoot
ds-backend-base-dn: dc=example,dc=com
ds-backend-is-private: false
ds-backend-entry-count: -1
ds-base-dn-entry-count: -1 dc=example,dc=com
ds-backend-writability-mode: enabled
ttl-is-running: false
ttl-last-run-timestamp: 20180302004728Z
ttl-thread-count: 0
ttl-queue-size: 0
ttl-entries-deleted: {"count":0,"mean_rate":0.000,"m1_rate":0.000,"m5_rate":0.000,"m15_rate":0.000}
cn: userRoot

dn: cn=JE Database,cn=userRoot,cn=Backends,cn=monitor
objectClass: top
objectClass: ds-monitor
objectClass: ds-monitor-je-database
objectClass: extensibleObject
JEInfo: EnvironmentFailureException: (JE 7.5.11) JAVA_ERROR: Java Error occurred, recovery may not be possible. (EnvironmentImpl.java:1745 EnvironmentImpl.java:1759 Environment.java:2491 Environment.java:2157 JEMonitor.java:62 MonitorProvider.java:221 MonitorBackend.java:495 MonitorBackend.java:462 SearchOperation.java:966 SearchOperation.java:906 SearchOperation.java:820 SynchronousStrategy.java:39 LdapClientConnection.java:551 LdapClientConnection.java:111 LdapClientConnection.java:833 LdapClientConnection.java:804 LdapClientConnection.java:646 SearchRequestImpl.java:62 LdapClientConnection.java:646 LdapClientConnection.java:631 LdapClientConnection.java:605 ...)
cn: JE Database

 

3.5.3 and older show

 

dn: cn=userRoot Backend,cn=monitor
objectClass: top
objectClass: ds-monitor-entry
objectClass: ds-backend-monitor-entry
ds-backend-id: userRoot
ds-backend-base-dn: dc=example,dc=com
ds-backend-is-private: false
ds-backend-entry-count: 10015
ds-base-dn-entry-count: 10015 dc=example,dc=com
ds-backend-writability-mode: enabled
cn: userRoot Backend

dn: cn=userRoot JE Database,cn=monitor
objectClass: top
objectClass: ds-monitor-entry
objectClass: extensibleObject
JEVersion: 7.3.7
EnvironmentNFSyncRequests: 0
EnvironmentNFSyncs: 0
EnvironmentCursorsBins: 0
EnvironmentEnvironmentCreationTime: 1519954107481
EnvironmentDbClosedBins: 0
EnvironmentInCompQueueSize: 0
EnvironmentNonEmptyBins: 0
EnvironmentProcessedBins: 0
EnvironmentSplitBins: 0
EnvironmentLastCheckpointId: 4
EnvironmentNCheckpoints: 0
EnvironmentNFullINFlush: 0
EnvironmentNFullBINFlush: 0
EnvironmentNDeltaINFlush: 0
EnvironmentLastCheckpointInterval: 0
EnvironmentLastCheckpointStart: 20610521
EnvironmentLastCheckpointEnd: 20610927
EnvironmentCleanerBacklog: 0
EnvironmentFileDeletionBacklog: 0
EnvironmentLastKnownUtilization: 57
EnvironmentDataBytes: 5947384
EnvironmentNWaiters: 0
EnvironmentPendingLNQueueSize: 0
EnvironmentNINSparseTarget: 22
EnvironmentNINNoTarget: 157
EnvironmentNCleanerRuns: 0
EnvironmentNCleanerTwoPassRuns: 0
EnvironmentNCleanerRevisalRuns: 0
EnvironmentNCleanerProbeRuns: 0
EnvironmentNCleanerDeletions: 0
EnvironmentNCleanerDiskRead: 10
EnvironmentNCleanerEntriesRead: 333908
EnvironmentNINsObsolete: 0
EnvironmentNINsCleaned: 0
EnvironmentNINsDead: 0
EnvironmentNINsMigrated: 0
EnvironmentNBINDeltasObsolete: 0
EnvironmentNBINDeltasCleaned: 0
EnvironmentNBINDeltasDead: 0
EnvironmentNBINDeltasMigrated: 0
EnvironmentNLNsObsolete: 0
EnvironmentNLNsExpired: 0
EnvironmentNLNsCleaned: 0
EnvironmentNLNsDead: 0
EnvironmentNLNsLocked: 0
EnvironmentNLNsMigrated: 0
EnvironmentNLNsMarked: 0
EnvironmentNLNQueueHits: 0
EnvironmentNPendingLNsProcessed: 0
EnvironmentNMarkedLNsProcessed: 0
EnvironmentNToBeCleanedLNsProcessed: 0
EnvironmentNClusterLNsProcessed: 0
EnvironmentNPendingLNsLocked: 0
EnvironmentNFSyncTimeouts: 0
EnvironmentFSyncTime: 7
EnvironmentFSyncMaxTime: 5
EnvironmentNLogFSyncs: 2
EnvironmentNLogBuffers: 3
EnvironmentNRandomReads: 1715
EnvironmentNRandomReadBytes: 11714407
EnvironmentNRandomWrites: 13
EnvironmentNRandomWriteBytes: 129667
EnvironmentNSequentialReads: 8640
EnvironmentNSequentialReadBytes: 53008233
EnvironmentNSequentialWrites: 16
EnvironmentNSequentialWriteBytes: 8657
EnvironmentNBytesReadFromWriteQueue: 0
EnvironmentNBytesWrittenFromWriteQueue: 0
EnvironmentNReadsFromWriteQueue: 0
EnvironmentNWritesFromWriteQueue: 0
EnvironmentNWriteQueueOverflow: 0
EnvironmentNWriteQueueOverflowFailures: 0
EnvironmentNNotResident: 10322
EnvironmentNRepeatFaultReads: 0
EnvironmentNTempBufferWrites: 0
EnvironmentNFileOpens: 5
EnvironmentNOpenFiles: 1
EnvironmentRequiredEvictBytes: 0
EnvironmentNNodesScanned: 0
EnvironmentNEvictPasses: 2
EnvironmentNNodesSelected: 0
EnvironmentNNodesExplicitlyEvicted: 0
EnvironmentNBINsStripped: 0
EnvironmentNBINsMutated: 0
EnvironmentNEvictionRuns: 2
EnvironmentNNodesTargeted: 0
EnvironmentNNodesEvicted: 0
EnvironmentNRootNodesEvicted: 0
EnvironmentNDirtyNodesEvicted: 0
EnvironmentNLNsEvicted: 0
EnvironmentNNodesStripped: 0
EnvironmentNNodesMutated: 0
EnvironmentNNodesPutBack: 0
EnvironmentNNodesMovedToDirtyLRU: 0
EnvironmentNNodesSkipped: 0
EnvironmentNThreadUnavailable: 0
EnvironmentNLNsFetch: 23871
EnvironmentNUpperINsFetch: 390
EnvironmentNBINsFetch: 25410
EnvironmentNLNsFetchMiss: 10077
EnvironmentNUpperINsFetchMiss: 5
EnvironmentNBINsFetchMiss: 225
EnvironmentNBINDeltasFetchMiss: 0
EnvironmentNFullBINsMiss: 0
EnvironmentNBINDeltaBlindOps: 0
EnvironmentNCachedUpperINs: 23
EnvironmentNCachedBINs: 252
EnvironmentNCachedBINDeltas: 0
EnvironmentNINCompactKeyIN: 231
EnvironmentDirtyLRUSize: 0
EnvironmentMixedLRUSize: 252
EnvironmentNBINsEvictedEvictorThread: 0
EnvironmentNBINsEvictedManual: 0
EnvironmentNBINsEvictedCritical: 0
EnvironmentNBINsEvictedCacheMode: 0
EnvironmentNBINsEvictedDaemon: 0
EnvironmentNUpperINsEvictedEvictorThread: 0
EnvironmentNUpperINsEvictedManual: 0
EnvironmentNUpperINsEvictedCritical: 0
EnvironmentNUpperINsEvictedCacheMode: 0
EnvironmentNUpperINsEvictedDaemon: 0
EnvironmentNBatchesEvictorThread: 0
EnvironmentNBatchesManual: 0
EnvironmentNBatchesCacheMode: 0
EnvironmentNBatchesCritical: 0
EnvironmentNBatchesDaemon: 0
EnvironmentNBytesEvictedEvictorThread: 0
EnvironmentNBytesEvictedManual: 0
EnvironmentNBytesEvictedCacheMode: 0
EnvironmentNBytesEvictedCritical: 0
EnvironmentNBytesEvictedDeamon: 0
EnvironmentAvgBatchEvictorThread: 0
EnvironmentAvgBatchManual: 0
EnvironmentAvgBatchCacheMode: 0
EnvironmentAvgBatchCritical: 0
EnvironmentAvgBatchDaemon: 0
EnvironmentSharedCacheTotalBytes: 0
EnvironmentCacheTotalBytes: 9096941
EnvironmentDataAdminBytes: 6104
EnvironmentDOSBytes: 0
EnvironmentAdminBytes: 1029
EnvironmentLockBytes: 2800
EnvironmentCacheDataBytes: 5951213
EnvironmentOffHeapAllocFailures: 0
EnvironmentOffHeapAllocOverflows: 0
EnvironmentOffHeapThreadUnavailable: 0
EnvironmentOffHeapNodesTargeted: 0
EnvironmentOffHeapCriticalNodesTargeted: 0
EnvironmentOffHeapNodesEvicted: 0
EnvironmentOffHeapDirtyNodesEvicted: 0
EnvironmentOffHeapNodesStripped: 0
EnvironmentOffHeapNodesMutated: 0
EnvironmentOffHeapNodesSkipped: 0
EnvironmentOffHeapLNsEvicted: 0
EnvironmentOffHeapLNsLoaded: 0
EnvironmentOffHeapLNsStored: 0
EnvironmentOffHeapBINsLoaded: 0
EnvironmentOffHeapBINsStored: 0
EnvironmentOffHeapCachedLNs: 0
EnvironmentOffHeapCachedBINs: 0
EnvironmentOffHeapCachedBINDeltas: 0
EnvironmentOffHeapTotalBytes: 0
EnvironmentOffHeapTotalBlocks: 0
EnvironmentOffHeapLRUSize: 0
EnvironmentRelatchesRequired: 0
EnvironmentNOwners: 25
EnvironmentNReadLocks: 25
EnvironmentNWriteLocks: 0
EnvironmentNRequests: 56840
EnvironmentNWaits: 0
EnvironmentNAcquiresNoWaiters: 0
EnvironmentNAcquiresSelfOwned: 0
EnvironmentNAcquiresWithContention: 0
EnvironmentNAcquiresNoWaitSuccessful: 0
EnvironmentNAcquiresNoWaitUnSuccessful: 0
EnvironmentNReleases: 0
EnvironmentNBinDeltaGetOps: 0
EnvironmentNBinDeltaInsertOps: 0
EnvironmentNBinDeltaUpdateOps: 0
EnvironmentNBinDeltaDeleteOps: 0
EnvironmentPriSearchOps: 20979
EnvironmentPriSearchFailOps: 217
EnvironmentSecSearchOps: 0
EnvironmentSecSearchFailOps: 0
EnvironmentPriPositionOps: 32076
EnvironmentSecPositionOps: 0
EnvironmentPriInsertOps: 139
EnvironmentPriInsertFailOps: 0
EnvironmentSecInsertOps: 0
EnvironmentPriUpdateOps: 99
EnvironmentSecUpdateOps: 0
EnvironmentPriDeleteOps: 0
EnvironmentPriDeleteFailOps: 0
EnvironmentSecDeleteOps: 0
EnvironmentNSharedCacheEnvironments: 0
EnvironmentEndOfLog: 20749275
EnvironmentNTotalLocks: 25
EnvironmentBufferBytes: 3145728
EnvironmentTotalLogSize: 20749266
EnvironmentCurrentMinUtilization: 57
EnvironmentCurrentMaxUtilization: 57
EnvironmentNRepeatIteratorReads: 0
EnvironmentNCacheMiss: 10322
TransactionNXAAborts: 0
TransactionNXAPrepares: 0
TransactionNBegins: 57
TransactionNCommits: 57
TransactionNXACommits: 0
TransactionNAborts: 0
TransactionNActive: 0
cn: userRoot JE Database

 

 

An export shows the backend does have entries.

 

opendj; bin /$ ./export-ldif --backendID userRoot --ldifFile example.ldif --offline | grep -c '^dn: ' example.ldif
10003

 

In testing if I changed the member attributes of the last 2 groups being modified to nonexistent dn's, the issue does not appear. The originals are shown below.

# Add test child groups as members of static groups
dn: cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
changetype: modify
add: member
member: cn=SnSrianan,cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
-
add: member
member: cn=SnUsers,cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com
-
add: member
member: cn=SnSmithXXX,cn=SSOEnabled,ou=SSOGroups,ou=groups,dc=example,dc=com


dn: cn=SSOEnforcedExclusion,ou=SSOGroups,ou=groups,dc=example,dc=com
changetype: modify
add: member
member: cn=SnUsers,cn=SSOEnforcedExclusion,ou=SSOGroups,ou=groups,dc=example,dc=com


dn: cn=SSOEnforced,ou=SSOGroups,ou=groups,dc=example,dc=com
changetype: modify
add: member
member: cn=SnUsers,cn=SSOEnforced,ou=SSOGroups,ou=groups,dc=example,dc=com
-
add: member
member: cn=SnSmithXXX,cn=SSOEnforced,ou=SSOGroups,ou=groups,dc=example,dc=com

Attached:

opendj; Downloads /$ unzip -l testcase.zip
Archive: testcase.zip
Length Date Time Name
--------- ---------- ----- ----
6840336 03-01-2018 16:17 example.ldif
438 03-01-2018 16:38 addschema.ldif
2691 03-01-2018 16:14 part1.ldif
869 03-01-2018 16:14 part2.ldif
--------- -------
6844334 4 files

 