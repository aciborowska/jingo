Problem: The system sometimes calls open() and close() for reduce different amount of times. Given DOP1 and our wordcount example, open() is called 3-times and close() only twice. Both should be called twice, first for combine and then for reduce. See logs below.

First analysis: The first open() is called by DataSourceTask for combine (probably because InputFormat->Map->Combine are chained all together and thus executed from DataSourceTask). The second and third calls are coming from RegularPactTask (which executes the reduce). See the stack traces below.

How to reproduce:
Add open() and close() method to Reduce in WordCount example, add System.out.println(...); in the first line, set DOP to 1 and run using LocalExecutor.

_Log with Combine:_
Map: open
_Reduce: open_ (this is probably the call for combine)
Map: map
Map: map
Map: map
Reduce: combine
Reduce: reduce
Reduce: combine
Reduce: reduce
Reduce: combine
Reduce: reduce
Reduce: combine
Reduce: reduce
Reduce: combine
Reduce: reduce
Reduce: combine
Reduce: reduce
Reduce: combine
Reduce: reduce
Map: close
_Reduce: close_
_Reduce: open_
_Reduce: open_ (this is one call too much here)
Reduce: reduce
Reduce: reduce
Reduce: reduce
Reduce: reduce
Reduce: reduce
Reduce: reduce
Reduce: reduce
_Reduce: close_

_Log without combine_
Map: open
Map: map
Map: map
Map: map
Map: close
_Reduce: open_
Reduce: reduce
Reduce: reduce
Reduce: reduce
Reduce: reduce
Reduce: reduce
Reduce: reduce
Reduce: reduce
_Reduce: close_


	
	
		
		
			
			
				Stack Traces
			
			
		
		
	
	



_First open()_
```
WordCount$CountWords.open(Configuration) line: 116  
RegularPactTask<S,OT>.openUserCode(Stub, Configuration) line: 1212  
SynchronousChainedCombineDriver<T>.openTask() line: 104 
RegularPactTask<S,OT>.openChainedTasks(List<ChainedDriver<?,?>>, AbstractInvokable) line: 1253  
DataSourceTask<OT>.invoke() line: 119   
RuntimeEnvironment.run() line: 344  
Thread.run() line: 744  
```

_Second open()_
```
WordCount$CountWords.open(Configuration) line: 116  
RegularPactTask<S,OT>.initInputLocalStrategy(int) line: 730 
RegularPactTask<S,OT>.initLocalStrategies(int) line: 578    
RegularPactTask<S,OT>.invoke() line: 275    
RuntimeEnvironment.run() line: 344  
Thread.run() line: 744
```

_Third open()_
```
WordCount$CountWords.open(Configuration) line: 116  
RegularPactTask<S,OT>.run() line: 361   
RegularPactTask<S,OT>.invoke() line: 291    
RuntimeEnvironment.run() line: 344  
Thread.run() line: 744  
```



---------------- Imported from GitHub ----------------
Url: https://github.com/stratosphere/stratosphere/issues/314
Created by: andrehacker
Labels: bug, 
Created at: Tue Dec 03 12:00:57 CET 2013
State: closed