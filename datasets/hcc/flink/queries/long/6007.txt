Currently, if an attempt is made to call InternalWatermarkCallbackService.unregisterKeyFromWatermarkCallback() from within the OnWatermarkCallback, a ConcurrentModificationException is thrown. The reason is that the invokeOnWatermarkCallback iterates over the list of keys and calls the callback for each one of them.

To fix this, the deleted keys are put into a separate list, and the deletion happens after the iteration over all keys has finished.