During job failure/restart, FlinkKafkaProducer configured with Semantic.EXACTLY_ONCE fails to disconnect properly do to a NoClassDefFoundError:

java.lang.NoClassDefFoundError: org/apache/kafka/clients/NetworkClient$1

at org.apache.kafka.clients.NetworkClient.processDisconnection(NetworkClient.java:658)

at org.apache.kafka.clients.NetworkClient.handleDisconnections(NetworkClient.java:805)

at org.apache.kafka.clients.NetworkClient.poll(NetworkClient.java:520)

at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:226)

at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:163)

at java.lang.Thread.run(Thread.java:748)

 

This begins a restart loop where the job never recovers properly. This is reproducible only with EXACTLY_ONCE semantic, AT_LEAST_ONCE properly disconnects and restarts without error.

This issue is described in FLINK-10455, but has been since marked as Fixed, but still reproducible.

 