

  public void shutdown() {
    running = false;
    recordsToSend.complete(0L);



In other methods, access to recordsToSend is protected by synchronized keyword.

shutdown() should do the same.