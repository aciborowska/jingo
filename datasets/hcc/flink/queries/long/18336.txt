To my understanding, failure shouldn't be counted more than once for a single checkpoint.

However, after a successful checkpoint, all previous failures are cleared.

So this test will currently fail:

 


TestFailJobCallback callback = new TestFailJobCallback();
CheckpointFailureManager failureManager = new CheckpointFailureManager(2, callback);

failureManager.handleJobLevelCheckpointException(new CheckpointException(CHECKPOINT_EXPIRED), 1L);
failureManager.handleJobLevelCheckpointException(new CheckpointException(CHECKPOINT_EXPIRED), 2L);

failureManager.handleCheckpointSuccess(2L);
failureManager.handleJobLevelCheckpointException(new CheckpointException(CHECKPOINT_EXPIRED), 3L);
failureManager.handleJobLevelCheckpointException(new CheckpointException(CHECKPOINT_EXPIRED), 4L);

// shouldn't be counted because 1L has already failed:
failureManager.handleJobLevelCheckpointException(new CheckpointException(CHECKPOINT_EXPIRED), 1L); 

assertEquals(0, callback.getInvokeCounter());

 