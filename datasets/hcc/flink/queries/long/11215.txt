Sometimes, job will fail after 5 minutes because register fail at resource manager.



But it register successful 5 minutes ago in fact (Tag ljg is added by me for test).



This problem appears for that the function startRegistrationTimeout in TaskExecutor.java is executed in multiple places.

In the function start, it will be executed by resourceManagerLeaderRetriever.start(new ResourceManagerLeaderListener()) in async way. Also, it will be executed in the end of the start function. The order of these two executions is not guaranteed but they will change the same variable currentRegistrationTimeoutId. If the async way is fast enough to execute startRegistrationTimeout() first. It will fail 5 minutes later for the startRegistrationTimeout's execution in the end of the start function.

The solution is to put the function startRegistrationTimeout in the start function before resourceManagerLeaderRetriever.start() . After doing this, the problem never appears again.

 