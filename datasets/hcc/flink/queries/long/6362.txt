Here is related code:

  public int getReferenceCount(SharedStateHandle state) {
    if (state == null) {
      return 0;
    }

    SharedStateRegistry.SharedStateEntry entry =
      registeredStates.get(state.getRegistrationKey());


Access should be protected by holding lock on registeredStates