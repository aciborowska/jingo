Currently, when talking about the limitation of MemoryStateBackend and FsStateBackend in documentation, Flink only focus on the memory checkpoint size limit. However, current documentation forgets to talk about the reference problem, which added in CopyOnWriteStateMap:


IMPORTANT: the contracts for this class rely on the user not holding any references to objects returned by this map beyond the life cycle of per-element operations. Or phrased differently, all get-update-put operations on a mapping should be within one call of processElement. Otherwise, the user must take care of taking deep copies, e.g. for caching purposes.



This actually also applies to NestedStateMap.