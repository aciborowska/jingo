Currently, we add the AggregateProjectMergeRule.INSTANCE in logical rule sets and use it to remove project for aggregates. However, there are some bugs when this rule be applied for the LogicalWindowAggregate.

When the project was removed, the input field names are changed, so the rule has to update all fields in the Aggregate, while the field name in LogicalWindow in LogicalWindowAggregate has not taken into consideration in AggregateProjectMergeRule, as it is a rule in Calcite.

This problem also lies in other Aggregate rules such as FilterAggregateTransposeRule and AggregateProjectPullUpConstantsRule, etc.

As a quick fix, I think we can change


AggregateProjectMergeRule.INSTANCE,


to


    new AggregateProjectMergeRule(
      classOf[LogicalAggregate], classOf[Project], RelFactories.LOGICAL_BUILDER),



Of course, we need a complete solution for the LogicalWindowAggregate(use LogicalAggregate to express LogicalWindowAggregate), but not in this jira.

Any suggestions are welcomed!
