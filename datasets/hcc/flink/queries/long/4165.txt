This occurs sometimes after FLINK-4162 is fixed. About 40 % of the time, when restarting a job it fails with this exception:


java.lang.RuntimeException: Failure happened in filter function.
	at org.apache.flink.cep.nfa.NFA.computeNextStates(NFA.java:316)
	at org.apache.flink.cep.nfa.NFA.process(NFA.java:160)
	at org.apache.flink.cep.operator.KeyedCEPPatternOperator.processEvent(KeyedCEPPatternOperator.java:48)
	at org.apache.flink.cep.operator.AbstractKeyedCEPPatternOperator.processWatermark(AbstractKeyedCEPPatternOperator.java:167)
	at org.apache.flink.streaming.runtime.io.StreamInputProcessor.processInput(StreamInputProcessor.java:165)
	at org.apache.flink.streaming.runtime.tasks.OneInputStreamTask.run(OneInputStreamTask.java:66)
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:265)
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:588)
	at java.lang.Thread.run(Thread.java:745)
Caused by: java.lang.IllegalStateException: Could not find previous shared buffer entry with key: State(start, Normal, [
StateTransition(TAKE, warning, with filter),
]), value: Event{id='three', eventType='start', timestamp=25045188001} and timestamp: 25045188001. This can indicate that the element belonging to the previous relation has been already pruned, even though you expect it to be still there.
	at org.apache.flink.cep.nfa.SharedBuffer.put(SharedBuffer.java:104)
	at org.apache.flink.cep.nfa.NFA.computeNextStates(NFA.java:293)
	... 8 more

