Following-up on FLINK-14370.

As Jiangjie Qin wrote: "The cause [of the unstable test] was that when all the records are processed before a snapshot was taken, the records that could not be sent out trigger the snapshot to fail. That snapshot failure will not cause the job to exit. However, all the records in the KafkaProducer are already expired after the snapshot failure. So when the producer closes, there will be no more exception thrown. Thus the job finished successfully.

It looks that the expected behavior from connector is to report exception in close() method as long as there was a record that could not be sent. On the other hand, exception thrown from CheckpointedFunction.snapshotState() might be ignored. Not sure if this is reasonable, but this expectation is not super clear from the connector implementation's perspective.

In terms of immediate fix, Arvid Heise proposes to always throw exception as long as there has been a record sending failure. I agree that is the right fix per current expected behavior on the connectors."

Kostas Kloudas, Piotr Nowojski any other idea on how to resolve it?