A job that uses CEP fails upon restore with a NullPointerException in NFA.process(). The reason seems to be that field computationStates is null. This field is transient and read in a custom readObject() method.

In AbstractKeyedCEPPatternOperator this snipped is used to construct a StateDescriptor for an NFA state:


new ValueStateDescriptor<NFA<IN>>(
    NFA_OPERATOR_STATE_NAME,
    new KryoSerializer<NFA<IN>>((Class<NFA<IN>>) (Class<?>) NFA.class, getExecutionConfig()),
    null)



It seems Kryo does not invoke readObject/writeObject. We probably need a custom TypeSerializer for NFA to solve the problem.