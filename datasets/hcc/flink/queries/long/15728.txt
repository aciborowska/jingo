When using JDBCUpsertOutputFormat custom dialect e.g. H2/Oracle which uses UpsertWriterUsingInsertUpdateStatement, code fails with below error.


Caused by: org.h2.jdbc.JdbcSQLDataException: Parameter "#6" is not set [90012-200] 
at org.h2.message.DbException.getJdbcSQLException(DbException.java:590) 
at org.h2.message.DbException.getJdbcSQLException(DbException.java:429) 
at org.h2.message.DbException.get(DbException.java:205) 
at org.h2.message.DbException.get(DbException.java:181) 
at org.h2.expression.Parameter.checkSet(Parameter.java:83) 
at org.h2.jdbc.JdbcPreparedStatement.addBatch(JdbcPreparedStatement.java:1275) 
at org.apache.flink.api.java.io.jdbc.writer.UpsertWriter$UpsertWriterUsingInsertUpdateStatement.processOneRowInBatch(UpsertWriter.java:233) 
at org.apache.flink.api.java.io.jdbc.writer.UpsertWriter.executeBatch(UpsertWriter.java:111) 

This is due to UpsertWriterUsingInsertUpdateStatement#processOneRowInBatch does not set all bind paramters in case of Update.

This bug does get surfaced while using Derby DB. 
 In JDBCUpsertOutputFormatTest if we replace Derby with H2 we can reproduce the bug.

The fix is trivial. Happy to raise PR.


//for update case replace below
setRecordToStatement(updateStatement, fieldTypes, row); 
//with
setRecordToStatement(updateStatement, fieldTypes + pkTypes, row  + pkRow);
//NOTE:  as prepared updateStatement contains additional where clause we need pass additional bind values and its sql Types




