Here is related code:

          if (outStream == null && pos <= localStateThreshold) {
            closed = true;
            byte[] bytes = Arrays.copyOf(writeBuffer, pos);
            return new ByteStreamStateHandle(bytes);
          }
          else {
            flush();
            outStream.close();


The if condition checks both outStream and pos.
In the else block, outStream may be null, leading to NPE.