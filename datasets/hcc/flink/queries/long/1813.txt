The StreamCheckPointingITCase sometimes fails on an illegal state exception thrown when trying to broadcast barrier from the sources. I think this is caused by sending a barrier when the source is not running any more.

The exception:

Exception in thread "Thread-341" java.lang.RuntimeException: java.lang.IllegalStateException: Partition already finished.
	at org.apache.flink.streaming.api.streamvertex.StreamVertex.actOnBarrier(StreamVertex.java:300)
	at org.apache.flink.streaming.api.streamvertex.StreamVertex.broadcastBarrierFromSource(StreamVertex.java:105)
	at org.apache.flink.runtime.taskmanager.TaskManager$$anonfun$receiveWithLogMessages$1$$anon$4.run(TaskManager.scala:386)
	at java.lang.Thread.run(Thread.java:745)
Caused by: java.lang.IllegalStateException: Partition already finished.
	at org.apache.flink.shaded.com.google.common.base.Preconditions.checkState(Preconditions.java:173)
	at org.apache.flink.runtime.io.network.partition.ResultPartition.checkInProduceState(ResultPartition.java:388)
	at org.apache.flink.runtime.io.network.partition.ResultPartition.add(ResultPartition.java:221)
	at org.apache.flink.runtime.io.network.api.writer.ResultPartitionWriter.writeEvent(ResultPartitionWriter.java:78)
	at org.apache.flink.runtime.io.network.api.writer.RecordWriter.broadcastEvent(RecordWriter.java:117)
	at org.apache.flink.streaming.api.collector.StreamOutput.broadcastEvent(StreamOutput.java:92)
	at org.apache.flink.streaming.api.streamvertex.OutputHandler.broadcastBarrier(OutputHandler.java:94)
	at org.apache.flink.streaming.api.streamvertex.StreamVertex.actOnBarrier(StreamVertex.java:294)
	... 3 more