Current implementation of needToCleanupState in KeyedProcessFunctionWithCleanupState actually has potention bug:


protected Boolean needToCleanupState(Long timestamp) throws IOException {
   if (stateCleaningEnabled) {
      Long cleanupTime = cleanupTimeState.value();
      // check that the triggered timer is the last registered processing time timer.
      return null != cleanupTime && timestamp == cleanupTime;
   } else {
      return false;
   }
}


Please note that it directly use "==" to judge whether Long type timestamp and cleanupTime equals. However, if that value is larger than 127L, the result would actually return false instead of wanted true.