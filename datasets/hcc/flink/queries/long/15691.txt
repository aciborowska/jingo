The method TaskExecutorPartitionLifecycleTest#runInTaskExecutorThreadAndWait does not run the given runnable in the TaskExecutors main thread. Instead it will run it in an arbitrary thread of the RpcService.

The reason why this does not cause test instabilities is that we execute operations which don't cause race conditions. However, in order to avoid spreading false friends I would suggest to get rid of this pattern. Moreover, I would question whether TaskExecutorPartitionLifecycleTest really needs access to the TaskExecutors internal state. I believe there is an easy way using the TaskExecutors public API to implement the tests.

cc Chesnay Schepler, Andrey Zagrebin