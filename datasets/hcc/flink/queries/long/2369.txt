The test fails with the assert at the very end ("Temp output file has not been removed"). This happens because FileOutputFormat.tryCleanupOnError can't delete the file, because it is still open (note, that Linux happily deletes open files).

A fix would be to have the  this.format.close();  not just in the finally block (in DataSinkTask.invoke), but also before the tryCleanupOnError call (around line 217).