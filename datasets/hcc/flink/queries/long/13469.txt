Currently, resource used by StateMapSnapshot is released in AbstractStateTableSnapshot#writeStateInKeyGroup as follows  


public void writeStateInKeyGroup(@Nonnull DataOutputView dov, int keyGroupId) throws IOException {
    StateMapSnapshot<K, N, S, ? extends StateMap<K, N, S>> stateMapSnapshot = getStateMapSnapshotForKeyGroup(keyGroupId);
    stateMapSnapshot.writeState(localKeySerializer, localNamespaceSerializer, localStateSerializer, dov, stateSnapshotTransformer);
    stateMapSnapshot.release();
}


If exception happens in StateMapSnapshot#writeState, resources used by this and left StateMapSnapshot s can not be released.