Fix concurrent access to shared buffer in map state / querable state