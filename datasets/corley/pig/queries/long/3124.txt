When optimizing a logical plan, it's safe to push a FLATTEN after a FILTER if the columns being flattened don't occur in the expression that the filter is being done on. When the FILTER comes first the FLATTEN generates fewer rows (usually), and so is more efficient.