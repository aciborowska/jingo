Hopefully, a final merge from trunk to spark branch. There was a merge conflict. Will upload the patch that resolves the conflict once I ensure all UTs pass.