Nested foreach getting incorrect schema when having unrelated inner query