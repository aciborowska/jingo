Optimize DISTINCT COUNT inside foreach