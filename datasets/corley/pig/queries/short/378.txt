FOREACH followed by LIMIT produces wrong results