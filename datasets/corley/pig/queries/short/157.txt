Add types and rework execution pipeline