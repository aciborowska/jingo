Filter inside foreach is broken