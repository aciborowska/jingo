Infinite loop with accumulator function in nested foreach