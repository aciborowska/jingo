Filtering bag in nested foreach does not produce expected results