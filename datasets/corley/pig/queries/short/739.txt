Filter in foreach seems to drop records resulting in decreased count of records