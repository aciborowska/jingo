Problems in pushing down foreach with flatten