nested foreach with flatten and agg gives an error