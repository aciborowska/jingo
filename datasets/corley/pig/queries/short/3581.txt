Incorrect scope resolution with nested foreach