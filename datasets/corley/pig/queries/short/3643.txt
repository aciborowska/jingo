Nested Foreach with UDF and bincond is broken