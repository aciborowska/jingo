FLATTEN in nested foreach fails when the input contains an empty bag