This patch replaces timers in the test with semaphores.