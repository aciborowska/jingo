We observed one race condition when multiple threads try to write concurrently. This patch should fix it.  I will also remove some commented code.