This is an extention of the work in  https://issues.apache.org/jira/browse/ZOOKEEPER-859