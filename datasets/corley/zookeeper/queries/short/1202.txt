Prevent certain state transitions in Java client on close(); improve exception handling and enhance client testability