C API makes it difficult to implement a timed wait_until_connected method correctly