Misc changes to improve flush() path performance