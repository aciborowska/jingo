Generated SUBSTRING SQL is ugly and inefficient