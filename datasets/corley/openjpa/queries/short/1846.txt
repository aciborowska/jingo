Generates wrong SQL when subqueries are used