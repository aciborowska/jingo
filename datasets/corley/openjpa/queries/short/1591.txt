Refactor various parts to allow for greater extensibility