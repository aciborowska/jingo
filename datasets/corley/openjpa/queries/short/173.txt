JOIN in subselect generates bad SQL