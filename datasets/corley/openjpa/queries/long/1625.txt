In BrokerImpl, the StateManagerImpl is not created consistently using newStateManagerImpl, making it difficult to extend StateManagerImpl and BrokerImpl. 