After EntityManager.flush() is called, no identifier will be generated for identifiers annotated with @GeneratedValue:

    EntityTransaction transaction = em.getTransaction();
    transaction.begin();
    Query query = em.createQuery("select m from Master m");
    @SuppressWarnings("unchecked")
    List<Master> l = query.getResultList();

    for (Master m: l) 
{

      //-- Two additional Detail's are created for each Master.
      m.getDetails().add(createDetail());
      m.getDetails().add(createDetail());

      //-- The following flush() causes the trouble: The second detail is lost in the second Master:
      //-- No id will be autogenerated for Detail instance after the flush()
      //-- If you omit this line, the test case works fine.
      em.flush();
    }

    transaction.commit();
    em.close();